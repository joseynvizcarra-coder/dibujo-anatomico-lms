<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard Instructor - LMS Dibujo Anat√≥mico UAH (Profesional)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root{--primary-dark:#2c5f66;--primary-light:#e8a2b8;--light-bg:#f8f9fa}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--light-bg);color:#222;margin:0}
    .header{background:linear-gradient(135deg,var(--primary-dark),#0f3a3f);color:#fff;padding:12px 16px;position:sticky;top:0;z-index:1030}
    .header h1{margin:0;font-size:1.25rem;color:var(--primary-light)}
    .btn-header{background:rgba(255,255,255,.12);color:#fff;border-radius:18px;border:none;padding:.35rem .7rem}
    .card{border-radius:10px}
    .small-muted{color:#6c757d}
    .loading-spinner{border:3px solid #f1f1f1;border-top:3px solid var(--primary-dark);border-radius:50%;width:28px;height:28px;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .sync-indicator{position:fixed;bottom:18px;right:18px;background:#fff;padding:.6rem 1rem;border-radius:18px;box-shadow:0 8px 30px rgba(0,0,0,.12);font-size:.9rem;z-index:1050}
    .risk-badge{padding:.25rem .6rem;border-radius:18px;font-weight:600;font-size:.8rem}
    .risk-high{background:#fee2e2;color:#dc2626}.risk-medium{background:#fef3c7;color:#d97706}.risk-low{background:#d1fae5;color:#059669}
    .chart-card{height:260px}
    .stat-number{font-size:1.6rem;font-weight:700;color:var(--primary-dark)}
  </style>
</head>
<body>
  <script src="auth.js"></script>

  <header class="header d-flex align-items-center justify-content-between">
    <div>
      <h1><i class="bi bi-graph-up me-2"></i>Dashboard Instructor ‚Äî UAH (Profesional)</h1>
      <div class="small text-white-50">Conectado a auth.js ‚Äî m√©tricas autom√°ticas y evaluaci√≥n avanzada</div>
    </div>
    <div class="text-end">
      <span id="instructorName" class="me-3">Cargando...</span>
      <a href="index.html" class="btn-header me-2"><i class="bi bi-arrow-left me-1"></i>Volver</a>
      <button id="logoutBtn" class="btn-header"><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
    </div>
  </header>

  <main class="container-fluid py-4">
    <div class="row g-3">
      <div class="col-12">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>M√©tricas y KPIs</h5>
              <small class="small-muted">Porcentajes y m√©tricas calculadas autom√°ticamente</small>
            </div>
            <div>
              <button id="forceSyncBtn" class="btn btn-sm btn-outline-secondary me-2">Forzar sync</button>
              <button id="refreshBtn" class="btn btn-sm btn-success"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button>
            </div>
          </div>

          <div class="row gy-3">
            <div class="col-6 col-md-2">
              <div class="p-2 bg-light rounded text-center">
                <div class="stat-number" id="totalStudents">-</div>
                <small class="small-muted">Estudiantes</small>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="p-2 bg-light rounded text-center">
                <div class="stat-number" id="avgProgress">-</div>
                <small class="small-muted">Progreso promedio</small>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="p-2 bg-light rounded text-center">
                <div class="stat-number" id="completionRate">-</div>
                <small class="small-muted">Tasa finalizaci√≥n</small>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="p-2 bg-light rounded text-center">
                <div class="stat-number" id="evalPassRate">-</div>
                <small class="small-muted">Tasa aprob. evaluaciones</small>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="p-2 bg-light rounded text-center">
                <div class="stat-number" id="activeStudents">-</div>
                <small class="small-muted">Activos (7d)</small>
              </div>
            </div>
            <div class="col-6 col-md-2">
              <div class="p-2 bg-light rounded text-center">
                <div class="stat-number" id="studentsAtRisk">-</div>
                <small class="small-muted">En riesgo</small>
              </div>
            </div>
          </div>

          <div class="row mt-3 g-3">
            <div class="col-12 col-lg-6">
              <div class="card p-2 chart-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Usuarios activos por d√≠a</strong>
                  <small class="small-muted">√öltimos 14 d√≠as</small>
                </div>
                <canvas id="activeByDayChart"></canvas>
              </div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="card p-2 chart-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Distribuci√≥n de progreso</strong>
                  <small class="small-muted">0-25 / 26-50 / 51-75 / 76-100</small>
                </div>
                <canvas id="progressDistributionChart"></canvas>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="col-12 col-lg-7">
        <div class="card p-3">
          <h5 class="mb-3"><i class="bi bi-people me-2"></i>Estudiantes</h5>
          <div class="table-responsive">
            <table class="table table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>Estudiante</th><th>Usuario</th><th>% Progreso</th><th>M√≥dulos</th><th>√öltimo acceso</th><th>Tiempo total (h)</th><th>Nota prom.</th><th>Riesgo</th>
                </tr>
              </thead>
              <tbody id="studentsTableBody">
                <tr><td colspan="8" class="text-center py-4"><span class="loading-spinner"></span> <span class="small-muted ms-2">Cargando...</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card p-3 mt-3">
          <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>Evaluaciones por lecci√≥n</h5>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead class="table-light">
                <tr>
                  <th>Estudiante</th><th class="text-center">M1.1</th><th class="text-center">M1.2</th><th class="text-center">M1.3</th>
                  <th class="text-center">M2.1</th><th class="text-center">M2.2</th><th class="text-center">M2.3</th><th class="text-center">M2.4</th>
                  <th class="text-center">M3.1</th><th class="text-center">M3.2</th><th class="text-center">M3.3</th><th class="text-center">Total</th>
                </tr>
              </thead>
              <tbody id="evaluationsTableBody">
                <tr><td colspan="12" class="text-center py-3 small-muted">Cargando evaluaciones...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <div class="col-12 col-lg-5">
        <div class="card p-3 mb-3">
          <h6 class="mb-2"><i class="bi bi-graph-up me-2"></i>Rendimiento por m√≥dulo</h6>
          <div id="moduleStats">
            <!-- module cards injected -->
          </div>
        </div>

        <div class="card p-3 mb-3">
          <h6 class="mb-2"><i class="bi bi-clock-history me-2"></i>Actividad reciente</h6>
          <div id="activityLog" style="max-height:300px;overflow:auto;border-radius:6px;border:1px solid #eee;padding:.5rem">
            <div class="text-center py-4"><div class="loading-spinner"></div><div class="small-muted mt-2">Cargando actividades...</div></div>
          </div>
        </div>

        <div class="card p-3">
          <h6 class="mb-2"><i class="bi bi-info-circle me-2"></i>Informaci√≥n del sistema</h6>
          <div class="small-muted">√öltima actualizaci√≥n: <span id="lastUpdate">-</span></div>
          <div class="small-muted">√öltima sincronizaci√≥n: <span id="lastSyncDisplay">-</span></div>
        </div>
      </div>

    </div>
  </main>

  <div id="syncIndicator" class="sync-indicator">üîÑ Sincronizando...</div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
  (function(){
    // Wait for auth.js functions
    function waitForAuthReady(timeout = 5000){
      return new Promise((resolve,reject)=>{
        const start = Date.now();
        (function check(){
          if (typeof protectPage === 'function' && typeof getCurrentUser === 'function' && typeof makeJSONPRequest === 'function') return resolve();
          if (Date.now() - start > timeout) return reject(new Error('auth.js no carg√≥ a tiempo'));
          setTimeout(check,50);
        })();
      });
    }

    // Use TOTAL_MODULES from auth.js if available, fallback to 3
    const TOTAL_MODULES_COUNT = (typeof TOTAL_MODULES !== 'undefined') ? TOTAL_MODULES : ((window && window.TOTAL_MODULES) ? window.TOTAL_MODULES : 3);

    // Small toast
    function showLocalToast(msg,type='info'){
      if (typeof window.showToast === 'function'){ try{ return window.showToast(msg,type);}catch(e){} }
      const colors = {success:'#10b981',info:'#3b82f6',warning:'#f59e0b',danger:'#ef4444'};
      const t = document.createElement('div'); t.textContent = msg;
      t.style.cssText = `position:fixed;top:20px;right:20px;background:${colors[type]||'#333'};color:white;padding:.8rem 1rem;border-radius:8px;z-index:10000`;
      document.body.appendChild(t); setTimeout(()=>t.remove(),2500);
    }

    // Charts
    let activeByDayChart = null;
    let progressDistributionChart = null;

    function initCharts(){
      const ctxA = document.getElementById('activeByDayChart').getContext('2d');
      activeByDayChart = new Chart(ctxA, { type:'bar', data:{ labels:[], datasets:[{ label:'Activos', data:[] }] }, options:{ responsive:true, plugins:{legend:{display:false}} } });
      const ctxP = document.getElementById('progressDistributionChart').getContext('2d');
      progressDistributionChart = new Chart(ctxP, { type:'doughnut', data:{ labels:['0-25','26-50','51-75','76-100'], datasets:[{ data:[] }] }, options:{ responsive:true, plugins:{legend:{position:'bottom'}} } });
    }

    // state
    const state = { students:[], activities:[], evaluations:[] , moduleInfo:{} };

    async function init(){
      try{
        await waitForAuthReady();
      }catch(e){
        alert('Error cargando auth.js: ' + e.message);
        console.error(e);
        return;
      }

      if (!protectPage('instructor')) return;
      const user = getCurrentUser();
      if (!user){ window.location.href='login.html'; return; }
      document.getElementById('instructorName').textContent = user.fullName || user.username;
      document.getElementById('logoutBtn').addEventListener('click', logout);

      document.getElementById('refreshBtn').addEventListener('click', async ()=>{ await refreshDashboard(); });
      document.getElementById('forceSyncBtn').addEventListener('click', async ()=>{
        const u = getCurrentUser();
        if (!u) return showLocalToast('No hay sesi√≥n','danger');
        showLocalToast('Forzando sincronizaci√≥n...','info');
        try{
          const ok = await syncProgressFromSheets(u.username, true);
          if (ok){ showLocalToast('Sincronizado correctamente','success'); await loadAll(); }
          else showLocalToast('Sincronizaci√≥n fallida','danger');
        }catch(err){ console.error(err); showLocalToast('Error durante sync','danger'); }
      });

      window.addEventListener('syncStatusChanged', ev=>{
        const d = ev.detail || {};
        const el = document.getElementById('syncIndicator');
        if (!el) return;
        const map = { synced: '‚úÖ ' + (d.message||'Sincronizado'), syncing: 'üîÑ ' + (d.message||'Sincronizando'), error: '‚ö†Ô∏è ' + (d.message||'Error') };
        el.textContent = map[d.status] || (d.message||'');
      });

      initCharts();
      await loadAll();
      await logUserActivity('dashboard_access','','');
    }

    async function loadAll(){
      setSyncIndicator('üîÑ Cargando datos...');
      try{
        await Promise.all([loadStudents(), loadActivities(), loadEvaluations()]);
        computeDerived();
        renderAll();
        setSyncIndicator('‚úÖ √öltima: ' + new Date().toLocaleTimeString());
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
        document.getElementById('lastSyncDisplay').textContent = localStorage.getItem('lastSync_' + (getCurrentUser()?.username || '')) || '-';
      }catch(err){
        console.error('Error loadAll',err);
        setSyncIndicator('‚ö†Ô∏è Error cargando');
        showLocalToast('Error cargando datos','danger');
      }
    }

    async function loadStudents(){
      const res = await makeJSONPRequest('getAllStudents');
      if (!res || !res.success) throw new Error(res?.error||'No students');
      state.students = res.data || [];
      document.getElementById('totalStudents').textContent = state.students.length;
    }

    async function loadActivities(){
      const res = await makeJSONPRequest('getActivities', { limit: 200 });
      state.activities = (res && res.success) ? (res.data||[]) : [];
    }

    async function loadEvaluations(){
      try{
        const res = await makeJSONPRequest('getAllEvaluations');
        if (res && res.success){ state.evaluations = res.data || []; return; }
      }catch(e){ /* ignore */ }
      // fallback build from student.progress
      const evals = [];
      state.students.forEach(s=>{
        const modules = s.progress?.modules || {};
        Object.keys(modules).forEach(mKey=>{
          const m = modules[mKey];
          if (m && m.evaluations){
            Object.keys(m.evaluations).forEach(lesson=>{
              const obj = m.evaluations[lesson] || {};
              evals.push({
                username: s.username,
                module: Number(mKey),
                lesson: Number(lesson),
                attempts: obj.attempts || 1,
                score: typeof obj.score === 'number' ? obj.score : (obj.scoreParsed || null),
                passed: (obj.passed === true) || (Object.keys(obj).length >= 2)
              });
            });
          }
        });
      });
      state.evaluations = evals;
    }

    // compute derived metrics
    function computeDerived(){
      computeProgressDistribution();
      computeAvgProgress();
      computeEvalMetrics();
      computeEngagement();
      computeRetention();
      computeModuleStats();
      computeActivitySeries();
    }

    function computeAvgProgress(){
      const students = state.students || [];
      const total = students.length || 1;
      const sum = students.reduce((acc,s)=> acc + (s.progress?.overallProgress || 0), 0);
      state.avgProgress = Math.round(sum / total);
      document.getElementById('avgProgress').textContent = state.avgProgress + '%';
    }

    function computeProgressDistribution(){
      const ranges = {'0-25':0,'26-50':0,'51-75':0,'76-100':0};
      state.students.forEach(s=>{
        const p = s.progress?.overallProgress || 0;
        if (p <=25) ranges['0-25']++; else if (p<=50) ranges['26-50']++; else if (p<=75) ranges['51-75']++; else ranges['76-100']++;
      });
      state.progressDistribution = ranges;
    }

    function computeEvalMetrics(){
      const evals = state.evaluations || [];
      const total = evals.length || 1;
      let passed=0, sumScore=0, scoreCount=0, attemptsSum=0;
      evals.forEach(e=>{
        if (e.passed) passed++;
        if (typeof e.score === 'number'){ sumScore += e.score; scoreCount++; }
        attemptsSum += (e.attempts || 1);
      });
      state.evalMetrics = {
        passRate: Math.round((passed / total) * 100) || 0,
        avgScore: scoreCount ? Math.round((sumScore/scoreCount)*10)/10 : null,
        avgAttempts: Math.round((attemptsSum / total)*10)/10
      };
      document.getElementById('evalPassRate').textContent = state.evalMetrics.passRate + '%';
    }

    function computeEngagement(){
      let totalTimeMins = 0, sessionsCount = 0, sumAvgSession = 0, countAvg = 0;
      state.students.forEach(s=>{
        if (typeof s.totalTime === 'number') totalTimeMins += s.totalTime;
        if (typeof s.avgSession === 'number'){ sumAvgSession += s.avgSession; countAvg++; }
      });
      state.engagement = { totalHours: Math.round(totalTimeMins/60), avgSession: countAvg ? Math.round(sumAvgSession/countAvg) : 0 };
    }

    function computeRetention(){
      const cutoff7 = new Date(); cutoff7.setDate(cutoff7.getDate()-7);
      const cutoff14 = new Date(); cutoff14.setDate(cutoff14.getDate()-14);
      const total = state.students.length || 1;
      const active7 = state.students.filter(s => s.progress?.lastAccess && new Date(s.progress.lastAccess) > cutoff7).length;
      const churn14 = state.students.filter(s => !s.progress?.lastAccess || new Date(s.progress.lastAccess) < cutoff14).length;
      const atRisk = state.students.filter(s => (s.progress?.overallProgress || 0) < 25 || !s.progress || (s.progress?.lastAccess && ((Date.now() - new Date(s.progress.lastAccess).getTime())/(1000*60*60*24) > 7))).length;
      state.retention = { active7, churn14, atRisk, churnPercent: Math.round((churn14/total)*100) };
      document.getElementById('activeStudents').textContent = state.retention.active7;
      document.getElementById('studentsAtRisk').textContent = state.retention.atRisk;
    }

    function computeModuleStats(){
      const modules = {};
      for (let i=1;i<=TOTAL_MODULES_COUNT;i++){
        modules[i] = { completed:0, inProgress:0, avgTime:0, attempts:0, passRate:0, count:0 };
      }
      // aggregate
      state.students.forEach(s=>{
        for (let i=1;i<=TOTAL_MODULES_COUNT;i++){
          const m = s.progress?.modules?.[i];
          if (!m){ modules[i].count++; continue; }
          if (m.completed) modules[i].completed++;
          else if ((m.progress || 0) > 0) modules[i].inProgress++;
          if (typeof m.timeSpent === 'number'){ modules[i].avgTime += m.timeSpent; }
          modules[i].count++;
          // evaluations pass rate per module: check m.evaluations
          const evals = m.evaluations || {};
          const lessonKeys = Object.keys(evals);
          if (lessonKeys.length){
            let passed = 0;
            lessonKeys.forEach(l=>{
              const obj = evals[l] || {};
              const passedFlag = obj.passed === true || Object.keys(obj).length >= 2;
              if (passedFlag) passed++;
            });
            modules[i].passRate += (lessonKeys.length ? (passed / lessonKeys.length) : 0);
          }
        }
      });
      // finalize averages
      Object.keys(modules).forEach(k=>{
        const m = modules[k];
        if (m.count) m.avgTime = Math.round((m.avgTime / m.count)) + 'h';
        m.passRate = Math.round((m.passRate / Math.max(1,m.count)) * 100);
      });
      state.moduleInfo = modules;
    }

    function computeActivitySeries(){
      // last 14 days count unique users by day
      const days = {};
      for (let i=0;i<14;i++){ const d = new Date(); d.setDate(d.getDate() - (13 - i)); days[d.toISOString().slice(0,10)] = new Set(); }
      state.activities.forEach(a=>{
        const key = new Date(a.timestamp).toISOString().slice(0,10);
        if (key in days) days[key].add(a.username || a.userId || 'unknown');
      });
      const labels = Object.keys(days);
      const data = labels.map(l => days[l].size);
      state.activitySeries = { labels, data };
    }

    // render
    function renderAll(){
      renderProgressDistributionChart();
      renderActiveByDayChart();
      renderStudentsTable();
      renderEvaluationsTable();
      renderModuleStats();
      renderKpis();
      renderActivityLog();
    }

    function renderKpis(){
      document.getElementById('completionRate').textContent = computeCompletionRate() + '%';
      document.getElementById('avgProgress').textContent = (state.avgProgress || 0) + '%';
      // evalPassRate already set
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
    }

    function computeCompletionRate(){
      const completed = state.students.filter(s => s.progress?.overallProgress === 100).length;
      const total = state.students.length || 1;
      return Math.round((completed/total)*100);
    }

    function renderProgressDistributionChart(){
      const vals = Object.values(state.progressDistribution);
      if (progressDistributionChart){
        progressDistributionChart.data.datasets[0].data = vals;
        progressDistributionChart.update();
      }
    }

    function renderActiveByDayChart(){
      if (activeByDayChart && state.activitySeries){
        activeByDayChart.data.labels = state.activitySeries.labels;
        activeByDayChart.data.datasets[0].data = state.activitySeries.data;
        activeByDayChart.update();
      }
    }

    function renderStudentsTable(){
      const tbody = document.getElementById('studentsTableBody');
      tbody.innerHTML = '';
      if (!state.students.length){ tbody.innerHTML = '<tr><td colspan="8" class="text-center py-3 small-muted">No hay estudiantes</td></tr>'; return; }
      state.students.forEach(s=>{
        const overall = s.progress?.overallProgress || 0;
        const completedModules = Object.values(s.progress?.modules || {}).filter(m=>m.completed).length;
        const last = s.progress?.lastAccess ? new Date(s.progress.lastAccess).toLocaleString() : 'Nunca';
        const totalTimeH = s.totalTime ? Math.round(s.totalTime/60) : '-';
        const avgScore = s.avgScore || computeStudentAvgScore(s) || '-';
        const riskClass = overall < 25 ? 'risk-high' : (overall < 50 ? 'risk-medium' : 'risk-low');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><strong>${s.fullName || s.username}</strong></td>
                        <td><code class="small">${s.username}</code></td>
                        <td><div style="width:120px"><div style="background:#eee;height:8px;border-radius:8px;overflow:hidden"><div style="width:${overall}%;height:8px;background:linear-gradient(90deg,var(--primary-dark),var(--primary-light))"></div></div></div><small class="ms-2">${overall}%</small></td>
                        <td class="text-center">${completedModules}/${TOTAL_MODULES_COUNT}</td>
                        <td class="small text-muted">${last}</td>
                        <td class="text-center small">${totalTimeH}</td>
                        <td class="text-center">${avgScore}</td>
                        <td class="text-center"><span class="risk-badge ${riskClass}">${overall<25?'Alto':(overall<50?'Medio':'Bajo')}</span></td>`;
        tbody.appendChild(tr);
      });
    }

    function computeStudentAvgScore(s){
      const modules = s.progress?.modules || {};
      let sum=0,count=0;
      Object.keys(modules).forEach(mk=>{
        const ev = modules[mk].evaluations || {};
        Object.keys(ev).forEach(ln=>{
          const sc = ev[ln]?.score;
          if (typeof sc === 'number'){ sum += sc; count++; }
        });
      });
      return count ? Math.round((sum/count)*10)/10 : null;
    }

    function renderEvaluationsTable(){
      const tbody = document.getElementById('evaluationsTableBody');
      tbody.innerHTML = '';
      if (!state.students.length){ tbody.innerHTML = '<tr><td colspan="12" class="text-center py-3 small-muted">No hay datos</td></tr>'; return; }
      state.students.forEach(student=>{
        const ev = {};
        for (let i=1;i<=TOTAL_MODULES_COUNT;i++){
          ev['module'+i] = student.progress?.modules?.[i]?.evaluations || {};
        }
        const checks = [];
        // m1 (3), m2 (4), m3 (3) - fallback if TOTAL_MODULES differs, derive lessons count heuristically
        const lessonsPerModule = {1:3,2:4,3:3};
        for (let m=1;m<=TOTAL_MODULES_COUNT;m++){
          const lessons = lessonsPerModule[m] || Object.keys(ev['module'+m]||{}).length || 3;
          for (let l=1;l<=lessons;l++){
            checks.push(isEvaluationPassed(ev['module'+m], l));
          }
        }
        const total = checks.filter(Boolean).length;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><strong>${student.fullName||student.username}</strong></td>` +
                       checks.map(p=>`<td class="text-center"><i class="bi bi-${p?'check-circle-fill text-success':'circle text-muted'}"></i></td>`).join('') +
                       `<td class="text-center"><strong>${total}</strong>/${checks.length}</td>`;
        tbody.appendChild(tr);
      });
    }

    function isEvaluationPassed(moduleEvals, lessonNum){
      if (!moduleEvals) return false;
      const obj = moduleEvals[lessonNum] || moduleEvals[String(lessonNum)];
      if (!obj) return false;
      if (typeof obj.passed === 'boolean') return obj.passed;
      if (typeof obj.score === 'number') return obj.score >= 60;
      return Object.keys(obj).length >= 2;
    }

    function renderModuleStats(){
      const container = document.getElementById('moduleStats');
      container.innerHTML = '';
      Object.keys(state.moduleInfo).forEach(k=>{
        const m = state.moduleInfo[k];
        const card = document.createElement('div');
        card.className = 'mb-2 p-2 bg-light rounded';
        card.innerHTML = `<div class="d-flex justify-content-between"><strong>M√≥dulo ${k}</strong><span class="small-muted">${m.passRate}% aprobaci√≥n</span></div>
                          <div class="small-muted">Completados: ${m.completed} ‚Ä¢ En progreso: ${m.inProgress} ‚Ä¢ Tiempo prom.: ${m.avgTime}</div>`;
        container.appendChild(card);
      });
    }

    function renderActivityLog(){
      const el = document.getElementById('activityLog');
      if (!state.activities.length){ el.innerHTML = '<div class="p-3 text-center small-muted">No hay actividades registradas</div>'; return; }
      el.innerHTML = state.activities.slice(0,50).map(a=>{
        const time = new Date(a.timestamp).toLocaleString();
        const who = a.username || a.userId || 'n/a';
        const action = a.action || a.activityType || a.type || 'actividad';
        return `<div style="padding:.6rem;border-bottom:1px solid #f1f1f1;display:flex;justify-content:space-between"><div><strong>${who}</strong><div class="small-muted">${action}</div></div><div class="small-muted">${time}</div></div>`;
      }).join('');
    }

    function setSyncIndicator(txt){
      const el = document.getElementById('syncIndicator');
      if (el) el.textContent = txt;
    }

    async function refreshDashboard(){
      showLocalToast('Actualizando dashboard...','info');
      await loadAll();
      showLocalToast('Dashboard actualizado','success');
    }

    // expose
    window.refreshDashboard = refreshDashboard;

    // init
    init();

  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
