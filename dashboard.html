<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard Instructor - LMS UAH (Auto + Color)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #222;
    }

    .header {
      background: linear-gradient(135deg, #2c5f66, #0f3a3f);
      color: #fff;
      padding: 12px 16px;
    }

    .header h1 {
      font-size: 1.25rem;
      margin: 0;
      color: #e8a2b8;
    }

    .btn-header {
      background: rgba(255, 255, 255, .12);
      color: #fff;
      border-radius: 18px;
      border: none;
      padding: .35rem .7rem;
    }

    .stat-number {
      font-size: 1.6rem;
      font-weight: 700;
      color: #2c5f66;
    }

    .chart-card {
      height: 260px;
    }

    .risk-badge {
      padding: .25rem .6rem;
      border-radius: 18px;
      font-weight: 600;
      font-size: .8rem;
    }

    .risk-high {background: #fee2e2; color: #dc2626;}
    .risk-medium {background: #fef3c7; color: #d97706;}
    .risk-low {background: #d1fae5; color: #059669;}

    .legend-item {
      display: inline-flex;
      align-items: center;
      margin-right: 12px;
      font-size: .85rem;
    }

    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      margin-right: 6px;
    }

    canvas {
      background: #fff;
      border-radius: 8px;
      padding: 4px;
    }

    /* Responsive optimizations */
    @media (max-width: 768px) {
      .header h1 {font-size: 1rem;}
      .chart-card {height: auto;}
      .stat-number {font-size: 1.3rem;}
      table {font-size: 0.85rem;}
    }

    .table-responsive {
      overflow-x: auto;
    }
  </style>
</head>
<body>
<script src="auth.js"></script>

<header class="header d-flex flex-wrap justify-content-between align-items-center">
  <div class="mb-2 mb-md-0">
    <h1><i class="bi bi-graph-up me-2"></i>Dashboard Instructor — Auto + Color</h1>
    <small class="text-white-50">Datos faltantes inferidos automáticamente</small>
  </div>
  <div class="text-end">
    <span id="instructorName" class="me-3">Cargando...</span>
    <a href="index.html" class="btn-header me-2"><i class="bi bi-arrow-left me-1"></i>Volver</a>
    <button id="logoutBtn" class="btn-header"><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
  </div>
</header>

<main class="container py-4">
  <div class="row g-3">
    <!-- Métricas generales -->
    <div class="col-12">
      <div class="card p-3 shadow-sm">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Métricas LMS</h5>
          <button id="refreshBtn" class="btn btn-sm btn-success"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button>
        </div>
        <div class="row g-3 text-center">
          <div class="col-6 col-md-2"><div><div class="stat-number" id="totalStudents">-</div><small>Estudiantes</small></div></div>
          <div class="col-6 col-md-2"><div><div class="stat-number" id="avgProgress">-</div><small>Progreso</small></div></div>
          <div class="col-6 col-md-2"><div><div class="stat-number" id="evalPassRate">-</div><small>Aprobación</small></div></div>
          <div class="col-6 col-md-2"><div><div class="stat-number" id="completionRate">-</div><small>Finalización</small></div></div>
          <div class="col-6 col-md-2"><div><div class="stat-number" id="activeStudents">-</div><small>Activos 7d</small></div></div>
          <div class="col-6 col-md-2"><div><div class="stat-number" id="studentsAtRisk">-</div><small>En riesgo</small></div></div>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="col-12 col-lg-6">
      <div class="card p-3 chart-card mt-3 shadow-sm">
        <h6><i class="bi bi-pie-chart me-2"></i>Distribución de progreso</h6>
        <canvas id="progressChart"></canvas>
        <div class="mt-3 text-center">
          <span class="legend-item"><span class="legend-color" style="background:#dc2626"></span>0–25% (Riesgo alto)</span>
          <span class="legend-item"><span class="legend-color" style="background:#f59e0b"></span>26–50% (Medio)</span>
          <span class="legend-item"><span class="legend-color" style="background:#10b981"></span>51–75% (Avanzando)</span>
          <span class="legend-item"><span class="legend-color" style="background:#065f46"></span>76–100% (Completado)</span>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card p-3 chart-card mt-3 shadow-sm">
        <h6><i class="bi bi-activity me-2"></i>Actividad por día (14 días)</h6>
        <canvas id="activityChart"></canvas>
      </div>
    </div>

    <!-- Tabla de estudiantes -->
    <div class="col-12">
      <div class="card p-3 mt-3 shadow-sm">
        <h5><i class="bi bi-people me-2"></i>Estudiantes</h5>
        <div class="table-responsive">
          <table class="table table-sm table-hover mt-2 align-middle">
            <thead class="table-light">
              <tr>
                <th>Nombre</th>
                <th>Usuario</th>
                <th>%</th>
                <th>Módulos</th>
                <th>Lecciones por módulo</th>
                <th>Último acceso</th>
                <th>Tiempo (h)</th>
                <th>Nota</th>
                <th>Riesgo</th>
              </tr>
            </thead>
            <tbody id="studentsTableBody">
              <tr><td colspan="9" class="text-center py-4 text-muted">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(async function(){
  function waitForAuthReady(timeout=5000){
    return new Promise((res,rej)=>{
      const t0=Date.now();
      (function check(){
        if(typeof protectPage==='function'&&typeof getCurrentUser==='function'&&typeof makeJSONPRequest==='function')return res();
        if(Date.now()-t0>timeout)return rej(new Error('auth.js no cargó'));
        setTimeout(check,50);
      })();
    });
  }

  function inferStudentData(s){
    s.progress = s.progress || {};
    if(!s.progress.modules) s.progress.modules = {};
    const mods = s.progress.modules;
    if(!s.progress.overallProgress){
      const vals = Object.values(mods).map(m=>m.progress||0);
      s.progress.overallProgress = vals.length? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length):0;
    }
    if(!s.avgScore){
      let sum=0,count=0;
      Object.values(mods).forEach(m=>{
        Object.values(m.evaluations||{}).forEach(e=>{ if(typeof e.score==='number'){sum+=e.score;count++;} });
      });
      s.avgScore = count? Math.round((sum/count)*10)/10:0;
    }
    if(!s.totalTime){
      let lessons=0;Object.values(mods).forEach(m=>{lessons+=Object.keys(m.evaluations||{}).length;});
      s.totalTime = lessons*8;
    }
    if(!s.avgSession)s.avgSession=Math.max(10,Math.round(s.totalTime/Math.max(1,Math.random()*3+1)));
    if(!s.progress.lastAccess){
      const acts=(window.activities||[]).filter(a=>a.username===s.username);
      if(acts.length)s.progress.lastAccess=acts[acts.length-1].timestamp;else s.progress.lastAccess=new Date().toISOString();
    }
    return s;
  }

  async function init(){
    await waitForAuthReady();
    if(!protectPage('instructor'))return;
    const user=getCurrentUser();
    if(!user)return;
    document.getElementById('instructorName').textContent=user.fullName||user.username;
    document.getElementById('logoutBtn').addEventListener('click',logout);
    document.getElementById('refreshBtn').addEventListener('click',loadStudents);
    loadStudents();
  }

  async function loadStudents(){
    const res=await makeJSONPRequest('getAllStudents');
    const students=(res&&res.success)?res.data:[];
    window.activities=(await makeJSONPRequest('getActivities',{limit:200})).data||[];
    const processed=students.map(inferStudentData);
    render(processed);
  }

  function render(students){
    const tbody=document.getElementById('studentsTableBody');
    tbody.innerHTML='';
    if(!students.length){tbody.innerHTML='<tr><td colspan="9" class="text-center text-muted py-3">Sin estudiantes</td></tr>';return;}
    const total=students.length;
    let sumProgress=0,passed=0,completed=0,active7=0,atRisk=0;
    const now=new Date();const cutoff7=new Date(now-7*86400000);
    const dist={'0-25':0,'26-50':0,'51-75':0,'76-100':0};
    students.forEach(s=>{
      sumProgress+=s.progress.overallProgress;
      if(s.avgScore>=60)passed++;
      if(s.progress.overallProgress>=100)completed++;
      const last=new Date(s.progress.lastAccess);
      if(last>cutoff7)active7++;
      if(s.progress.overallProgress<25)atRisk++;
      if(s.progress.overallProgress<=25)dist['0-25']++;
      else if(s.progress.overallProgress<=50)dist['26-50']++;
      else if(s.progress.overallProgress<=75)dist['51-75']++;
      else dist['76-100']++;

      const risk=s.progress.overallProgress<25?'high':(s.progress.overallProgress<50?'medium':'low');
      
      // Calcular lecciones completadas por módulo
      const modulesInfo = Object.entries(s.progress.modules||{}).map(([num,mod])=>{
        const totalLessons = (mod.totalLessons || Object.keys(mod.evaluations||{}).length) || 0;
        const completedLessons = (mod.completedLessons||[]).length || 0;
        return `M${num}: ${completedLessons}/${totalLessons}`;
      }).join(' | ') || '-';

      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${s.fullName||s.username}</td>
        <td><code>${s.username}</code></td>
        <td>${s.progress.overallProgress}%</td>
        <td>${Object.values(s.progress.modules||{}).filter(m=>m.completed).length||0}</td>
        <td>${modulesInfo}</td>
        <td>${new Date(s.progress.lastAccess).toLocaleString()}</td>
        <td>${Math.round(s.totalTime/60)}</td>
        <td>${s.avgScore}</td>
        <td><span class="risk-badge risk-${risk}">${risk==='high'?'Alto':risk==='medium'?'Medio':'Bajo'}</span></td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('totalStudents').textContent=total;
    document.getElementById('avgProgress').textContent=Math.round(sumProgress/total)+'%';
    document.getElementById('evalPassRate').textContent=Math.round((passed/total)*100)+'%';
    document.getElementById('completionRate').textContent=Math.round((completed/total)*100)+'%';
    document.getElementById('activeStudents').textContent=active7;
    document.getElementById('studentsAtRisk').textContent=atRisk;
    renderCharts(dist);
  }

  function renderCharts(dist){
    const ctxP=document.getElementById('progressChart').getContext('2d');
    const ctxA=document.getElementById('activityChart').getContext('2d');
    const labels=['0–25%','26–50%','51–75%','76–100%'];
    const dataVals=[dist['0-25'],dist['26-50'],dist['51-75'],dist['76-100']];
    new Chart(ctxP,{
      type:'doughnut',
      data:{labels:labels,datasets:[{data:dataVals,backgroundColor:['#dc2626','#f59e0b','#10b981','#065f46'],borderWidth:1,hoverOffset:8}]},
      options:{plugins:{legend:{display:false},
        tooltip:{callbacks:{label:(ctx)=>`${ctx.label}: ${ctx.parsed} estudiantes (${((ctx.parsed/(dataVals.reduce((a,b)=>a+b,0)||1))*100).toFixed(1)}%)`}}}}
    });
    const days={};for(let i=13;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);days[d.toISOString().slice(0,10)]=0;}
    (window.activities||[]).forEach(a=>{const k=new Date(a.timestamp).toISOString().slice(0,10);if(days[k]!==undefined)days[k]++;});
    new Chart(ctxA,{type:'bar',data:{labels:Object.keys(days),datasets:[{label:'Usuarios activos',data:Object.values(days),backgroundColor:'#3b82f6'}]},
      options:{scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}});
  }

  init();
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
