<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard Instructor - LMS Dibujo Anatómico UAH (Auto-Inferencia)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8f9fa;color:#222}
    .header{background:linear-gradient(135deg,#2c5f66,#0f3a3f);color:#fff;padding:12px 16px}
    .header h1{font-size:1.25rem;margin:0;color:#e8a2b8}
    .btn-header{background:rgba(255,255,255,.12);color:#fff;border-radius:18px;border:none;padding:.35rem .7rem}
    .stat-number{font-size:1.6rem;font-weight:700;color:#2c5f66}
    .risk-badge{padding:.25rem .6rem;border-radius:18px;font-weight:600;font-size:.8rem}
    .risk-high{background:#fee2e2;color:#dc2626}.risk-medium{background:#fef3c7;color:#d97706}.risk-low{background:#d1fae5;color:#059669}
    .loading-spinner{border:3px solid #f1f1f1;border-top:3px solid #2c5f66;border-radius:50%;width:28px;height:28px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
<script src="auth.js"></script>
<header class="header d-flex justify-content-between align-items-center">
  <div>
    <h1><i class="bi bi-graph-up me-2"></i>Dashboard Instructor — Auto-Inferencia</h1>
    <small class="text-white-50">Datos faltantes calculados automáticamente</small>
  </div>
  <div class="text-end">
    <span id="instructorName" class="me-3">Cargando...</span>
    <a href="index.html" class="btn-header me-2"><i class="bi bi-arrow-left me-1"></i>Volver</a>
    <button id="logoutBtn" class="btn-header"><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
  </div>
</header>
<main class="container py-4">
  <div class="row g-3">
    <div class="col-12">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="bi bi-speedometer2 me-2"></i>Métricas LMS</h5>
          <button id="refreshBtn" class="btn btn-sm btn-success"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button>
        </div>
        <div class="row g-3">
          <div class="col-6 col-md-2"><div class="text-center"><div class="stat-number" id="totalStudents">-</div><small>Estudiantes</small></div></div>
          <div class="col-6 col-md-2"><div class="text-center"><div class="stat-number" id="avgProgress">-</div><small>Progreso</small></div></div>
          <div class="col-6 col-md-2"><div class="text-center"><div class="stat-number" id="evalPassRate">-</div><small>Aprobación</small></div></div>
          <div class="col-6 col-md-2"><div class="text-center"><div class="stat-number" id="completionRate">-</div><small>Finalización</small></div></div>
          <div class="col-6 col-md-2"><div class="text-center"><div class="stat-number" id="activeStudents">-</div><small>Activos 7d</small></div></div>
          <div class="col-6 col-md-2"><div class="text-center"><div class="stat-number" id="studentsAtRisk">-</div><small>En riesgo</small></div></div>
        </div>
      </div>
    </div>
    <div class="col-12">
      <div class="card p-3 mt-3">
        <h5><i class="bi bi-people me-2"></i>Estudiantes</h5>
        <table class="table table-sm table-hover mt-2">
          <thead class="table-light"><tr><th>Nombre</th><th>Usuario</th><th>%</th><th>Módulos</th><th>Último acceso</th><th>Tiempo (h)</th><th>Nota</th><th>Riesgo</th></tr></thead>
          <tbody id="studentsTableBody"><tr><td colspan="8" class="text-center py-4"><div class="loading-spinner"></div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<script>
(async function(){
  function waitForAuthReady(timeout=5000){
    return new Promise((res,rej)=>{
      const t0=Date.now();
      (function check(){
        if(typeof protectPage==='function'&&typeof getCurrentUser==='function'&&typeof makeJSONPRequest==='function')return res();
        if(Date.now()-t0>timeout)return rej(new Error('auth.js no cargó'));
        setTimeout(check,50);
      })();
    });
  }

  function inferStudentData(s){
    s.progress = s.progress || {};
    if(!s.progress.modules) s.progress.modules = {};
    const mods = s.progress.modules;

    // Infer overallProgress
    if(!s.progress.overallProgress){
      const vals = Object.values(mods).map(m=>m.progress||0);
      s.progress.overallProgress = vals.length? Math.round(vals.reduce((a,b)=>a+b,0)/vals.length):0;
    }

    // Infer avgScore
    if(!s.avgScore){
      let sum=0,count=0;
      Object.values(mods).forEach(m=>{
        Object.values(m.evaluations||{}).forEach(e=>{
          if(typeof e.score==='number'){sum+=e.score;count++;}
        });
      });
      s.avgScore = count? Math.round((sum/count)*10)/10:0;
    }

    // Infer totalTime (minutos)
    if(!s.totalTime){
      let lessons=0;
      Object.values(mods).forEach(m=>{lessons+=Object.keys(m.evaluations||{}).length;});
      s.totalTime = lessons*8; // 8 minutos por lección
    }

    // Infer avgSession (minutos)
    if(!s.avgSession) s.avgSession = Math.max(10, Math.round(s.totalTime/Math.max(1,Math.random()*3+1)));

    // Infer lastAccess
    if(!s.progress.lastAccess){
      const acts = (window.activities||[]).filter(a=>a.username===s.username);
      if(acts.length) s.progress.lastAccess = acts[acts.length-1].timestamp;
      else s.progress.lastAccess = new Date().toISOString();
    }

    // Normalize evaluations
    Object.values(mods).forEach(m=>{
      Object.entries(m.evaluations||{}).forEach(([k,v])=>{
        if(typeof v.passed==='undefined'){
          if(typeof v.score==='number') v.passed=v.score>=60;
          else if(Object.keys(v).length>=2) v.passed=true;
          else v.passed=false;
        }
      });
    });
    return s;
  }

  async function init(){
    await waitForAuthReady();
    if(!protectPage('instructor'))return;
    const user=getCurrentUser();
    if(!user)return;
    document.getElementById('instructorName').textContent=user.fullName||user.username;
    document.getElementById('logoutBtn').addEventListener('click',logout);
    document.getElementById('refreshBtn').addEventListener('click',loadStudents);
    loadStudents();
  }

  async function loadStudents(){
    const res=await makeJSONPRequest('getAllStudents');
    const students=(res&&res.success)?res.data:[];
    window.activities=(await makeJSONPRequest('getActivities',{limit:200})).data||[];
    const processed=students.map(inferStudentData);
    render(processed);
  }

  function render(students){
    const tbody=document.getElementById('studentsTableBody');
    tbody.innerHTML='';
    if(!students.length){tbody.innerHTML='<tr><td colspan="8" class="text-center text-muted py-3">Sin estudiantes</td></tr>';return;}
    const total=students.length;
    let sumProgress=0,passed=0,completed=0,active7=0,atRisk=0;
    const now=new Date();const cutoff7=new Date(now-7*86400000);
    students.forEach(s=>{
      sumProgress+=s.progress.overallProgress;
      if(s.avgScore>=60)passed++;
      if(s.progress.overallProgress>=100)completed++;
      const last=new Date(s.progress.lastAccess);
      if(last>cutoff7)active7++;
      if(s.progress.overallProgress<25)atRisk++;

      const risk=s.progress.overallProgress<25?'high':(s.progress.overallProgress<50?'medium':'low');
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${s.fullName||s.username}</td><td><code>${s.username}</code></td>
        <td>${s.progress.overallProgress}%</td>
        <td>${Object.values(s.progress.modules||{}).filter(m=>m.completed).length||0}</td>
        <td>${new Date(s.progress.lastAccess).toLocaleString()}</td>
        <td>${Math.round(s.totalTime/60)}</td>
        <td>${s.avgScore}</td>
        <td><span class="risk-badge risk-${risk}">${risk==='high'?'Alto':risk==='medium'?'Medio':'Bajo'}</span></td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('totalStudents').textContent=total;
    document.getElementById('avgProgress').textContent=Math.round(sumProgress/total)+'%';
    document.getElementById('evalPassRate').textContent=Math.round((passed/total)*100)+'%';
    document.getElementById('completionRate').textContent=Math.round((completed/total)*100)+'%';
    document.getElementById('activeStudents').textContent=active7;
    document.getElementById('studentsAtRisk').textContent=atRisk;
  }

  init();
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
