<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Instructor - LMS Dibujo Anat√≥mico UAH (Extendido)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root{--primary-dark:#2c5f66;--primary-light:#e8a2b8;--light-bg:#f8f9fa}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--light-bg);color:#222;margin:0}
    .header{background:linear-gradient(135deg,var(--primary-dark),#0f3a3f);color:#fff;padding:12px 16px;position:sticky;top:0;z-index:1030}
    .header h1{margin:0;font-size:1.2rem;color:var(--primary-light)}
    .btn-header{background:rgba(255,255,255,.12);color:#fff;border-radius:18px;border:none;padding:.35rem .7rem}
    .card{border-radius:10px}
    .small-muted{color:#6c757d}
    .loading-spinner{border:3px solid #f1f1f1;border-top:3px solid var(--primary-dark);border-radius:50%;width:28px;height:28px;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .sync-indicator{position:fixed;bottom:18px;right:18px;background:#fff;padding:.6rem 1rem;border-radius:18px;box-shadow:0 8px 30px rgba(0,0,0,.12);font-size:.9rem;z-index:1050}
    .risk-badge{padding:.25rem .6rem;border-radius:18px;font-weight:600;font-size:.8rem}
    .risk-high{background:#fee2e2;color:#dc2626}.risk-medium{background:#fef3c7;color:#d97706}.risk-low{background:#d1fae5;color:#059669}
    .chart-card{height:260px}
  </style>
</head>
<body>
  <script src="auth.js"></script>

  <header class="header d-flex align-items-center justify-content-between">
    <div>
      <h1><i class="bi bi-graph-up me-2"></i>Dashboard Instructor ‚Äî UAH</h1>
      <div class="small text-white-50">Visi√≥n extendida: Engagement ‚Ä¢ Rendimiento ‚Ä¢ Retenci√≥n ‚Ä¢ Feedback</div>
    </div>
    <div class="text-end">
      <span id="instructorName" class="me-3">Cargando...</span>
      <a href="index.html" class="btn-header me-2"><i class="bi bi-arrow-left me-1"></i>Volver</a>
      <button id="logoutBtn" class="btn-header"><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
    </div>
  </header>

  <main class="container-fluid py-4">
    <div class="row g-3">
      <div class="col-12 col-md-8">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>M√©tricas clave</h5>
            <div>
              <button id="forceSyncBtn" class="btn btn-sm btn-secondary me-2">Forzar sync</button>
              <button id="refreshBtn" class="btn btn-sm btn-success"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button>
            </div>
          </div>

          <div class="row gy-3">
            <div class="col-6 col-md-3">
              <div class="p-2 bg-light rounded text-center">
                <div class="h4 mb-0" id="totalStudents">-</div>
                <small class="small-muted">Estudiantes</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="p-2 bg-light rounded text-center">
                <div class="h4 mb-0" id="activeStudents">-</div>
                <small class="small-muted">Activos (7d)</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="p-2 bg-light rounded text-center">
                <div class="h4 mb-0" id="avgSessionTime">-</div>
                <small class="small-muted">Tiempo / sesi√≥n (min)</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="p-2 bg-light rounded text-center">
                <div class="h4 mb-0" id="avgScore">-</div>
                <small class="small-muted">Puntaje promedio</small>
              </div>
            </div>
          </div>

          <div class="row mt-3 g-3">
            <div class="col-12 col-lg-6">
              <div class="card p-2 chart-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Usuarios activos por d√≠a</strong>
                  <small class="small-muted">√öltimos 14 d√≠as</small>
                </div>
                <canvas id="activeByDayChart" style="max-height:200px"></canvas>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <div class="card p-2 chart-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Distribuci√≥n de progreso</strong>
                  <small class="small-muted">0-25 / 26-50 / 51-75 / 76-100</small>
                </div>
                <canvas id="progressDistributionChart" style="max-height:200px"></canvas>
              </div>
            </div>
          </div>

        </div>

        <div class="card p-3 mt-3">
          <h5 class="mb-3"><i class="bi bi-people me-2"></i>Lista de estudiantes</h5>
          <div class="table-responsive">
            <table class="table table-sm table-hover">
              <thead class="table-light">
                <tr><th>Estudiante</th><th>Usuario</th><th>Progreso</th><th>√öltimo acceso</th><th>Tiempo total (h)</th><th>Score</th><th>Riesgo</th></tr>
              </thead>
              <tbody id="studentsTableBody">
                <tr><td colspan="7" class="text-center py-4"><span class="loading-spinner"></span> <span class="small-muted ms-2">Cargando...</span></td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>

      <div class="col-12 col-md-4">
        <div class="card p-3 mb-3">
          <h6 class="mb-2"><i class="bi bi-clipboard2-check me-2"></i>Rendimiento Acad√©mico</h6>
          <div class="small-muted mb-2">M√©tricas basadas en evaluaciones</div>
          <div><strong>Promedio general:</strong> <span id="perfAvgScore">-</span></div>
          <div><strong>Tasa aprobaci√≥n:</strong> <span id="perfPassRate">-</span></div>
          <div><strong>Intentos / eval (avg):</strong> <span id="perfAvgAttempts">-</span></div>
          <div class="mt-3"><strong>M√≥dulo con m√°s reprobaciones:</strong> <div id="hardestModule">-</div></div>
        </div>

        <div class="card p-3 mb-3">
          <h6 class="mb-2"><i class="bi bi-chat-left-text me-2"></i>Feedback reciente</h6>
          <div id="feedbackList" style="max-height:260px;overflow:auto">
            <div class="small-muted">Cargando feedback...</div>
          </div>
        </div>

        <div class="card p-3">
          <h6 class="mb-2"><i class="bi bi-clock-history me-2"></i>Retenci√≥n & Riesgo</h6>
          <div><strong>Abandono estimado (14d):</strong> <span id="churn14">-</span></div>
          <div class="mt-2"><strong>Estudiantes en riesgo:</strong> <span id="studentsAtRisk">-</span></div>
          <div class="mt-3"><small class="small-muted">√öltima sincronizaci√≥n: <span id="lastSync">-</span></small></div>
        </div>

      </div>
    </div>
  </main>

  <div id="syncIndicator" class="sync-indicator">üîÑ Sincronizando...</div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
  // No redeclare TOTAL_MODULES here; auth.js already defines it.
  (function(){

    // wait for auth.js utilities
    function waitForAuthReady(timeout = 5000){
      return new Promise((resolve,reject)=>{
        const start = Date.now();
        (function check(){
          if (typeof protectPage === 'function' && typeof getCurrentUser === 'function' && typeof makeJSONPRequest === 'function') return resolve();
          if (Date.now() - start > timeout) return reject(new Error('auth.js no carg√≥ a tiempo'));
          setTimeout(check,50);
        })();
      });
    }

    // basic toast (will defer to auth.js showToast if available)
    function showLocalToast(msg,type='info'){
      if (typeof window.showToast === 'function') return window.showToast(msg,type);
      const colors = {success:'#10b981',info:'#3b82f6',warning:'#f59e0b',danger:'#ef4444'};
      const t = document.createElement('div'); t.textContent = msg;
      t.style.cssText = `position:fixed;top:20px;right:20px;background:${colors[type]};color:white;padding:.8rem 1rem;border-radius:8px;z-index:10000`;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),2500);
    }

    // Charts
    let activeByDayChart = null;
    let progressDistributionChart = null;

    async function initCharts(){
      const ctxA = document.getElementById('activeByDayChart').getContext('2d');
      activeByDayChart = new Chart(ctxA, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'Usuarios activos', data: [], tension:0.4 }]},
        options: { responsive:true, plugins:{legend:{display:false}}}
      });

      const ctxP = document.getElementById('progressDistributionChart').getContext('2d');
      progressDistributionChart = new Chart(ctxP, {
        type: 'doughnut',
        data: { labels: ['0-25','26-50','51-75','76-100'], datasets:[{ data: [], hoverOffset:4 }]},
        options:{responsive:true, plugins:{legend:{position:'bottom'}}}
      });
    }

    async function init(){
      try {
        await waitForAuthReady();
      } catch (e) {
        alert('Error cargando auth.js: ' + e.message);
        console.error(e);
        return;
      }

      if (!protectPage('instructor')) return;
      const user = getCurrentUser();
      if (!user){ window.location.href='login.html'; return; }
      document.getElementById('instructorName').textContent = user.fullName || user.username;
      document.getElementById('logoutBtn').addEventListener('click', logout);

      document.getElementById('refreshBtn').addEventListener('click', async ()=>{ await refreshDashboard(); });
      document.getElementById('forceSyncBtn').addEventListener('click', async ()=>{
        const u = getCurrentUser();
        if (!u) return showLocalToast('No hay sesi√≥n','danger');
        showLocalToast('Forzando sincronizaci√≥n...','info');
        try {
          const ok = await syncProgressFromSheets(u.username, true);
          if (ok) { showLocalToast('Sincronizado correctamente','success'); await loadDashboardData(); }
          else showLocalToast('Sincronizaci√≥n fallida','danger');
        } catch(err){ console.error(err); showLocalToast('Error durante sync','danger'); }
      });

      window.addEventListener('syncStatusChanged', ev=>{
        const detail = ev.detail||{};
        const el = document.getElementById('syncIndicator');
        if (!el) return;
        const status = detail.status || 'synced';
        const msg = detail.message || '';
        const map = { synced: '‚úÖ '+msg, syncing: 'üîÑ '+msg, error: '‚ö†Ô∏è '+msg, offline: 'üî¥ '+msg };
        el.textContent = map[status] || msg;
      });

      await initCharts();
      await loadDashboardData();
      await logUserActivity('dashboard_access','','');
    }

    // ---- Data loader / processors ----
    const state = { students:[], activities:[], evaluations:[] };

    async function loadDashboardData(){
      setSyncIndicator('üîÑ Cargando...');
      try {
        await Promise.all([loadStudents(), loadActivities(), loadEvaluations()]);
        computeDerived();
        renderAll();
        setSyncIndicator('‚úÖ √öltima: ' + new Date().toLocaleTimeString());
      } catch(err){
        console.error('Error cargando dashboard:', err);
        setSyncIndicator('‚ö†Ô∏è Error cargando');
        showLocalToast('Error cargando datos. Revisa consola','danger');
      }
    }

    async function loadStudents(){
      // expects getAllStudents to return array with fields including progress, totalTime (mins), avgSession (mins), avgScore, feedbacks[]
      const res = await makeJSONPRequest('getAllStudents');
      if (!res || !res.success) throw new Error(res?.error||'No students');
      state.students = res.data || [];
      document.getElementById('totalStudents').textContent = state.students.length;
      document.getElementById('studentsAtRisk').textContent = '-';
    }

    async function loadActivities(){
      const res = await makeJSONPRequest('getActivities', { limit: 100 });
      state.activities = (res && res.success) ? (res.data||[]) : [];
    }

    async function loadEvaluations(){
      // optional endpoint; if not present, we'll infer from student.progress.evaluations
      try {
        const res = await makeJSONPRequest('getAllEvaluations');
        if (res && res.success) { state.evaluations = res.data || []; return; }
      } catch(e){ /* ignore */ }
      // fallback: build evaluations from students' progress
      const evals = [];
      state.students.forEach(s=>{
        const modules = s.progress?.modules || {};
        Object.keys(modules).forEach(m=>{
          const mod = modules[m];
          if (mod && mod.evaluations){
            Object.keys(mod.evaluations).forEach(lesson=>{
              const entry = { username: s.username, module: parseInt(m), lesson: parseInt(lesson), attempts: (mod.evaluations[lesson]?.attempts||1), score: (mod.evaluations[lesson]?.score||null), passed: (Object.keys(mod.evaluations[lesson]||{}).length>=2) };
              evals.push(entry);
            });
          }
        });
      });
      state.evaluations = evals;
    }

    // ---- Compute metrics ----
    function computeDerived(){
      computeActivitySeries();
      computeProgressDistribution();
      computePerformanceMetrics();
      computeEngagement();
      computeRetention();
    }

    function computeActivitySeries(){
      // Build last 14 days active users count (from activities)
      const days = {};
      for(let i=0;i<14;i++){
        const d = new Date(); d.setDate(d.getDate()- (13 - i));
        const key = d.toISOString().slice(0,10);
        days[key]=0;
      }
      state.activities.forEach(a=>{
        const d = new Date(a.timestamp);
        const key = d.toISOString().slice(0,10);
        if (key in days) days[key] = Math.max(days[key], 0) + 1;
      });
      state.activitySeries = { labels: Object.keys(days), data: Object.values(days) };
    }

    function computeProgressDistribution(){
      const ranges = { '0-25':0,'26-50':0,'51-75':0,'76-100':0 };
      state.students.forEach(s=>{
        const p = s.progress?.overallProgress || 0;
        if (p<=25) ranges['0-25']++; else if (p<=50) ranges['26-50']++; else if (p<=75) ranges['51-75']++; else ranges['76-100']++;
      });
      state.progressDistribution = ranges;
    }

    function computePerformanceMetrics(){
      // average score, pass rate, avg attempts, hardest module
      let totalScore = 0, scoreCount = 0, passed=0, totalEvals=0, attemptsSum=0;
      const moduleFailures = {};
      state.evaluations.forEach(e=>{
        if (typeof e.score === 'number'){ totalScore += e.score; scoreCount++; }
        if (e.passed) passed++;
        totalEvals++;
        attemptsSum += (e.attempts || 1);
        if (!e.passed) moduleFailures[e.module] = (moduleFailures[e.module]||0)+1;
      });
      state.perf = {
        avgScore: scoreCount ? Math.round((totalScore/scoreCount)*10)/10 : null,
        passRate: totalEvals ? Math.round((passed/totalEvals)*100) : 0,
        avgAttempts: totalEvals ? Math.round((attemptsSum/totalEvals)*10)/10 : 0,
        hardestModule: Object.keys(moduleFailures).length ? (''+Object.entries(moduleFailures).sort((a,b)=>b[1]-a[1])[0][0]) : '-'
      };
    }

    function computeEngagement(){
      // average session time (mins)
      let totalSession=0, sessions=0, totalTimeMins=0;
      state.students.forEach(s=>{
        if (typeof s.avgSession === 'number'){ totalSession += s.avgSession; sessions++; }
        if (typeof s.totalTime === 'number') totalTimeMins += s.totalTime;
      });
      state.engagement = { avgSessionMins: sessions ? Math.round(totalSession/sessions) : 0, totalTimeHours: Math.round(totalTimeMins/60) };
    }

    function computeRetention(){
      // churn (14 days): % with lastAccess older than 14 days
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-14);
      const total = state.students.length;
      const churnCount = state.students.filter(s=> !s.progress?.lastAccess || new Date(s.progress.lastAccess) < cutoff).length;
      const atRisk = state.students.filter(s=> (s.progress?.overallProgress||0) < 25 || !s.progress || (s.progress?.lastAccess && ( (Date.now() - new Date(s.progress.lastAccess).getTime())/(1000*60*60*24) ) > 7 )).length;
      state.retention = { churn14: total ? Math.round((churnCount/total)*100) + '%' : '-', atRiskCount: atRisk };
    }

    // ---- Render ----
    function renderAll(){
      renderStudentsTable();
      renderPerformance();
      renderFeedback();
      renderCharts();
      renderSummaryKPIs();
    }

    function renderStudentsTable(){
      const tbody = document.getElementById('studentsTableBody');
      tbody.innerHTML = '';
      if (!state.students.length){ tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 small-muted">No hay estudiantes</td></tr>'; return; }
      state.students.forEach(s=>{
        const overall = s.progress?.overallProgress || 0;
        const lastAccess = s.progress?.lastAccess ? new Date(s.progress.lastAccess).toLocaleString() : 'Nunca';
        const riskClass = (overall<25) ? 'risk-high' : (overall<50 ? 'risk-medium' : 'risk-low');
        const totalTimeH = s.totalTime ? Math.round(s.totalTime/60) : '-';
        const score = (typeof s.avgScore === 'number') ? s.avgScore : (s.score || '-');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><strong>${s.fullName||s.username}</strong></td>
                        <td><code class="small">${s.username}</code></td>
                        <td><div style="width:120px"><div style="background:#eee;height:8px;border-radius:8px;overflow:hidden"><div style="width:${overall}%;height:8px;background:linear-gradient(90deg,var(--primary-dark),var(--primary-light))"></div></div></div></td>
                        <td class="small text-muted">${lastAccess}</td>
                        <td class="text-center small">${totalTimeH}</td>
                        <td class="text-center">${score}</td>
                        <td class="text-center"><span class="risk-badge ${riskClass}">${overall<25?'Alto':(overall<50?'Medio':'Bajo')}</span></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderPerformance(){
      document.getElementById('perfAvgScore').textContent = state.perf.avgScore !== null ? state.perf.avgScore : '-';
      document.getElementById('perfPassRate').textContent = state.perf.passRate + '%';
      document.getElementById('perfAvgAttempts').textContent = state.perf.avgAttempts;
      document.getElementById('hardestModule').textContent = state.perf.hardestModule;
    }

    function renderFeedback(){
      const el = document.getElementById('feedbackList');
      el.innerHTML = '';
      // collect feedback items from students feedback arrays if present
      const feedbacks = [];
      state.students.forEach(s=>{
        if (Array.isArray(s.feedbacks)){
          s.feedbacks.slice(-10).forEach(f=> feedbacks.push({user: s.username, rating: f.rating, comment: f.comment, time: f.time}));
        }
      });
      if (!feedbacks.length){ el.innerHTML = '<div class="small-muted">Sin feedback reciente</div>'; return; }
      feedbacks.slice(-20).reverse().forEach(f=>{
        const d = f.time ? new Date(f.time).toLocaleString() : '';
        const node = document.createElement('div');
        node.className = 'mb-2';
        node.innerHTML = `<div><strong>${f.user}</strong> <span class="small text-muted"> ${d}</span></div><div class="small">${f.comment||''} <span class="small-muted"> (${f.rating||'-'})</span></div>`;
        el.appendChild(node);
      });
    }

    function renderCharts(){
      // Active by day
      if (activeByDayChart){
        activeByDayChart.data.labels = state.activitySeries.labels;
        activeByDayChart.data.datasets[0].data = state.activitySeries.data;
        activeByDayChart.update();
      }
      // Progress distribution
      if (progressDistributionChart){
        const vals = Object.values(state.progressDistribution);
        progressDistributionChart.data.datasets[0].data = vals;
        progressDistributionChart.update();
      }
    }

    function renderSummaryKPIs(){
      document.getElementById('activeStudents').textContent = state.activitySeries.data.reduce((a,b)=>a+b,0) > 0 ? state.activitySeries.data[state.activitySeries.data.length-1] || 0 : 0;
      document.getElementById('avgSessionTime').textContent = state.engagement.avgSessionMins || 0;
      document.getElementById('avgScore').textContent = state.perf.avgScore !== null ? state.perf.avgScore : '-';
      document.getElementById('churn14').textContent = state.retention.churn14;
      document.getElementById('studentsAtRisk').textContent = state.retention.atRiskCount;
      document.getElementById('lastSync').textContent = localStorage.getItem('lastSync_' + (getCurrentUser()?.username || '')) || '-';
    }

    function setSyncIndicator(txt){
      const el = document.getElementById('syncIndicator');
      if (el) el.textContent = txt;
    }

    async function refreshDashboard(){
      showLocalToast('Actualizando dashboard...','info');
      await loadDashboardData();
      showLocalToast('Dashboard actualizado','success');
    }

    // init
    init();

    // expose refresh to global (safety)
    window.refreshDashboard = refreshDashboard;

  })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
