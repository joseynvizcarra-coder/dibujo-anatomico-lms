<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Instructor - Dibujo Anat√≥mico UAH</title>
    
    <!-- Bootstrap 5.3.2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary-dark: #2c5f66;
            --primary-light: #e8a2b8;
            --dark: #1a1a1a;
            --gray-light: #f5f5f5;
            --gray-medium: #666;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #FFC107;
            --info: #2196F3;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-light);
            min-height: 100vh;
        }

        .header-dashboard {
            background: linear-gradient(135deg, var(--primary-dark), var(--dark));
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        .dashboard-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-light);
            margin-bottom: 0;
        }

        .user-info-badge {
            background: rgba(255,255,255,0.15);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary-light));
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-medium);
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 2.5rem;
            opacity: 0.15;
            color: var(--primary-dark);
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .section-header {
            color: var(--primary-dark);
            font-weight: 600;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--primary-light);
        }

        .section-header i {
            margin-right: 0.5rem;
        }

        .btn-custom {
            padding: 0.6rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary-custom {
            background: var(--primary-dark);
            color: white;
        }

        .btn-primary-custom:hover {
            background: var(--primary-light);
            color: var(--dark);
            transform: translateY(-2px);
        }

        .btn-secondary-custom {
            background: var(--gray-light);
            color: var(--primary-dark);
            border: 2px solid var(--primary-light);
        }

        .btn-secondary-custom:hover {
            background: var(--primary-light);
            color: white;
        }

        .module-filter {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1.2rem;
            border-radius: 20px;
            border: 2px solid var(--gray-medium);
            background: white;
            color: var(--gray-medium);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--primary-dark);
            color: white;
            border-color: var(--primary-dark);
        }

        .evaluation-card {
            background: var(--gray-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-dark);
            transition: all 0.3s ease;
        }

        .evaluation-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(5px);
        }

        .eval-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .eval-title {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 1.1rem;
        }

        .eval-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .eval-stat-item {
            text-align: center;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
        }

        .eval-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-dark);
        }

        .eval-stat-label {
            font-size: 0.8rem;
            color: var(--gray-medium);
            margin-top: 0.25rem;
        }

        .progress-bar-custom {
            height: 25px;
            background: var(--gray-light);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill-custom {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #66BB6A);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85rem;
            transition: width 0.6s ease;
            border-radius: 12px;
        }

        .progress-fill-custom.warning {
            background: linear-gradient(90deg, var(--warning), #FFD54F);
        }

        .progress-fill-custom.danger {
            background: linear-gradient(90deg, var(--danger), #EF5350);
        }

        .student-table {
            width: 100%;
            border-collapse: collapse;
        }

        .student-table thead th {
            background: var(--gray-light);
            color: var(--primary-dark);
            font-weight: 600;
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid var(--primary-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .student-table tbody td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .student-table tbody tr:hover {
            background: #f9f9f9;
        }

        .badge-custom {
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #F57C00;
        }

        .badge-danger {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(33, 150, 243, 0.1);
            color: var(--info);
        }

        .question-analysis {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid #eee;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .question-number {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .difficulty-indicator {
            display: flex;
            gap: 0.25rem;
        }

        .difficulty-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-light);
        }

        .difficulty-dot.active {
            background: var(--danger);
        }

        .difficulty-dot.active.medium {
            background: var(--warning);
        }

        .difficulty-dot.active.easy {
            background: var(--success);
        }

        .answer-distribution {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .answer-bar {
            flex: 1;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
        }

        .answer-bar:hover {
            transform: translateY(-2px);
        }

        .answer-bar.correct {
            background: var(--success);
        }

        .answer-bar.incorrect {
            background: var(--gray-medium);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1.5rem 0;
        }

        .loading-spinner {
            border: 3px solid var(--gray-light);
            border-top: 3px solid var(--primary-dark);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--gray-medium);
        }

        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        .alert-custom {
            border-left: 4px solid;
            border-radius: 8px;
            padding: 1rem 1.5rem;
        }

        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 1.3rem;
            }

            .stat-number {
                font-size: 2rem;
            }

            .section-card {
                padding: 1.25rem;
            }

            .student-table {
                font-size: 0.9rem;
            }

            .student-table thead th,
            .student-table tbody td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <script src="auth.js"></script>

    <header class="header-dashboard">
        <div class="container-fluid">
            <div class="row align-items-center g-3">
                <div class="col-md-6">
                    <h1 class="dashboard-title">
                        <i class="bi bi-speedometer2"></i>
                        Dashboard del Instructor
                    </h1>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end align-items-center gap-2">
                        <div class="user-info-badge">
                            <i class="bi bi-person-circle"></i>
                            <span id="instructorName">Cargando...</span>
                        </div>
                        <a href="index.html" class="btn btn-sm btn-outline-light">
                            <i class="bi bi-house"></i>
                            <span class="d-none d-md-inline ms-1">Curso</span>
                        </a>
                        <button class="btn btn-sm btn-danger" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i>
                            <span class="d-none d-md-inline ms-1">Salir</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container-fluid py-4">
        <!-- Estad√≠sticas Principales -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <i class="bi bi-people-fill stat-icon"></i>
                    <div class="stat-number" id="totalStudents">17</div>
                    <div class="stat-label">Estudiantes UAH</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <i class="bi bi-clipboard-check-fill stat-icon"></i>
                    <div class="stat-number" id="completedEvals">0</div>
                    <div class="stat-label">Evaluaciones Completadas</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <i class="bi bi-graph-up-arrow stat-icon"></i>
                    <div class="stat-number" id="avgScore">0%</div>
                    <div class="stat-label">Promedio General</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <i class="bi bi-award-fill stat-icon"></i>
                    <div class="stat-number" id="passRate">0%</div>
                    <div class="stat-label">Tasa de Aprobaci√≥n</div>
                </div>
            </div>
        </div>

        <!-- Filtros de M√≥dulo -->
        <div class="section-card">
            <div class="section-header">
                <div>
                    <i class="bi bi-funnel"></i>
                    Filtrar por M√≥dulo
                </div>
                <button class="btn btn-sm btn-primary-custom" onclick="refreshDashboard()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Actualizar
                </button>
            </div>
            <div class="module-filter">
                <button class="filter-btn active" data-module="all" onclick="filterByModule('all')">
                    <i class="bi bi-list-ul"></i> Todos
                </button>
                <button class="filter-btn" data-module="1" onclick="filterByModule(1)">
                    M√≥dulo 1: Observaci√≥n y Gesto
                </button>
                <button class="filter-btn" data-module="2" onclick="filterByModule(2)">
                    M√≥dulo 2: Anatom√≠a Funcional
                </button>
                <button class="filter-btn" data-module="3" onclick="filterByModule(3)">
                    M√≥dulo 3: Figura Completa
                </button>
            </div>
        </div>

        <!-- M√©tricas de Evaluaciones por M√≥dulo -->
        <div class="row">
            <div class="col-12">
                <div class="section-card">
                    <div class="section-header">
                        <div>
                            <i class="bi bi-bar-chart-fill"></i>
                            M√©tricas de Evaluaciones
                        </div>
                    </div>

                    <div id="evaluationsContainer">
                        <!-- M√≥dulo 1 -->
                        <div class="evaluation-card module-eval" data-module="1">
                            <div class="eval-header">
                                <div class="eval-title">
                                    <i class="bi bi-1-circle-fill me-2"></i>
                                    M√≥dulo 1: Observaci√≥n y Gesto
                                </div>
                                <span class="badge-custom badge-info">3 Evaluaciones</span>
                            </div>

                            <div class="eval-stats">
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m1-completed">0</div>
                                    <div class="eval-stat-label">Completadas</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m1-avg">0%</div>
                                    <div class="eval-stat-label">Promedio</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m1-pass">0%</div>
                                    <div class="eval-stat-label">Aprobaci√≥n</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m1-attempts">0</div>
                                    <div class="eval-stat-label">Intentos Totales</div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <h6 class="text-muted small mb-2">Evaluaciones por Lecci√≥n:</h6>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small><strong>Lecci√≥n 1.1:</strong> Fundamentos del Croquis</small>
                                        <small class="text-muted" id="m1-l1-count">0/17 estudiantes</small>
                                    </div>
                                    <div class="progress-bar-custom">
                                        <div class="progress-fill-custom" id="m1-l1-bar" style="width: 0%">0%</div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small><strong>Lecci√≥n 1.2:</strong> Proporciones</small>
                                        <small class="text-muted" id="m1-l2-count">0/17 estudiantes</small>
                                    </div>
                                    <div class="progress-bar-custom">
                                        <div class="progress-fill-custom" id="m1-l2-bar" style="width: 0%">0%</div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small><strong>Lecci√≥n 1.3:</strong> Balance</small>
                                        <small class="text-muted" id="m1-l3-count">0/17 estudiantes</small>
                                    </div>
                                    <div class="progress-bar-custom">
                                        <div class="progress-fill-custom" id="m1-l3-bar" style="width: 0%">0%</div>
                                    </div>
                                </div>
                            </div>

                            <button class="btn btn-sm btn-secondary-custom mt-3" onclick="showDetailedAnalysis(1)">
                                <i class="bi bi-graph-up"></i>
                                Ver An√°lisis Detallado
                            </button>
                        </div>

                        <!-- M√≥dulo 2 -->
                        <div class="evaluation-card module-eval" data-module="2">
                            <div class="eval-header">
                                <div class="eval-title">
                                    <i class="bi bi-2-circle-fill me-2"></i>
                                    M√≥dulo 2: Anatom√≠a Funcional
                                </div>
                                <span class="badge-custom badge-info">4 Evaluaciones</span>
                            </div>

                            <div class="eval-stats">
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m2-completed">0</div>
                                    <div class="eval-stat-label">Completadas</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m2-avg">0%</div>
                                    <div class="eval-stat-label">Promedio</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m2-pass">0%</div>
                                    <div class="eval-stat-label">Aprobaci√≥n</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m2-attempts">0</div>
                                    <div class="eval-stat-label">Intentos Totales</div>
                                </div>
                            </div>

                            <button class="btn btn-sm btn-secondary-custom mt-3" onclick="showDetailedAnalysis(2)">
                                <i class="bi bi-graph-up"></i>
                                Ver An√°lisis Detallado
                            </button>
                        </div>

                        <!-- M√≥dulo 3 -->
                        <div class="evaluation-card module-eval" data-module="3">
                            <div class="eval-header">
                                <div class="eval-title">
                                    <i class="bi bi-3-circle-fill me-2"></i>
                                    M√≥dulo 3: Figura Completa
                                </div>
                                <span class="badge-custom badge-info">3 Evaluaciones</span>
                            </div>

                            <div class="eval-stats">
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m3-completed">0</div>
                                    <div class="eval-stat-label">Completadas</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m3-avg">0%</div>
                                    <div class="eval-stat-label">Promedio</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m3-pass">0%</div>
                                    <div class="eval-stat-label">Aprobaci√≥n</div>
                                </div>
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value" id="m3-attempts">0</div>
                                    <div class="eval-stat-label">Intentos Totales</div>
                                </div>
                            </div>

                            <button class="btn btn-sm btn-secondary-custom mt-3" onclick="showDetailedAnalysis(3)">
                                <i class="bi bi-graph-up"></i>
                                Ver An√°lisis Detallado
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- An√°lisis de Preguntas Dif√≠ciles -->
        <div class="row">
            <div class="col-12">
                <div class="section-card">
                    <div class="section-header">
                        <div>
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            Preguntas con Mayor Dificultad
                        </div>
                    </div>

                    <div id="difficultQuestionsContainer">
                        <div class="text-center py-4">
                            <div class="loading-spinner"></div>
                            <p class="text-muted">Analizando respuestas de estudiantes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progreso Individual de Estudiantes -->
        <div class="row">
            <div class="col-12">
                <div class="section-card">
                    <div class="section-header">
                        <div>
                            <i class="bi bi-person-lines-fill"></i>
                            Progreso Individual de Estudiantes
                        </div>
                        <button class="btn btn-sm btn-secondary-custom" onclick="exportToCSV()">
                            <i class="bi bi-download"></i>
                            Exportar CSV
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="student-table">
                            <thead>
                                <tr>
                                    <th>Estudiante</th>
                                    <th>M√≥dulo 1</th>
                                    <th>M√≥dulo 2</th>
                                    <th>M√≥dulo 3</th>
                                    <th>Promedio</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="studentsProgressTable">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <div class="loading-spinner"></div>
                                        Cargando datos de estudiantes...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de An√°lisis Detallado -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-dark), var(--dark)); color: white;">
                    <h5 class="modal-title" id="detailModalTitle">
                        <i class="bi bi-graph-up"></i>
                        An√°lisis Detallado
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let allStudentsData = [];
        let currentModuleFilter = 'all';
        let detailModal;

        // Estructura de respuestas correctas por m√≥dulo
        const correctAnswers = {
            1: {
                lesson1: { q1: 2, q2: 1, q3: 3 },
                lesson2: { q1: 2, q2: 3, q3: 1 },
                lesson3: { q1: 2, q2: 3, q3: 1 }
            },
            2: {
                // Agregar respuestas del m√≥dulo 2 cuando est√© disponible
            },
            3: {
                // Agregar respuestas del m√≥dulo 3 cuando est√© disponible
            }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            if (!protectPage('instructor')) return;

            const currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('instructorName').textContent = currentUser.fullName || currentUser.username;
            
            detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            
            loadDashboardData();
        });

        // Cargar todos los datos
        async function loadDashboardData() {
            try {
                await loadStudentsEvaluationData();
                updateAllMetrics();
                analyzeDifficultQuestions();
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showAlert('Error al cargar datos. Por favor, recarga la p√°gina.', 'danger');
            }
        }

        // Cargar datos de evaluaciones de estudiantes
        async function loadStudentsEvaluationData() {
            // Simular carga de datos (en producci√≥n vendr√≠a de Google Sheets)
            allStudentsData = generateMockStudentData();
        }

        // Generar datos de prueba
        function generateMockStudentData() {
            const students = [];
            const nombres = [
                'Ana Garc√≠a', 'Carlos L√≥pez', 'Mar√≠a Fern√°ndez', 'Jos√© Mart√≠nez',
                'Laura Rodr√≠guez', 'Pedro S√°nchez', 'Carmen D√≠az', 'Miguel Torres',
                'Isabel Ruiz', 'Francisco Moreno', 'Luc√≠a Jim√©nez', 'Antonio Castro',
                'Rosa Ortiz', 'Manuel Navarro', 'Teresa Romero', 'Juan Vega', 'Elena Silva'
            ];

            nombres.forEach((nombre, index) => {
                const student = {
                    id: index + 1,
                    name: nombre,
                    username: `est${index + 1}`,
                    evaluations: {}
                };

                // Generar datos de evaluaciones por m√≥dulo
                for (let module = 1; module <= 3; module++) {
                    student.evaluations[module] = {};
                    const lessonsCount = module === 2 ? 4 : 3;
                    
                    for (let lesson = 1; lesson <= lessonsCount; lesson++) {
                        // Simular si complet√≥ la evaluaci√≥n
                        const completed = Math.random() > 0.3; // 70% completadas
                        
                        if (completed) {
                            const answers = {};
                            let correctCount = 0;
                            
                            // Generar respuestas (3 preguntas por evaluaci√≥n)
                            for (let q = 1; q <= 3; q++) {
                                const questionKey = `q${q}`;
                                const correctAnswer = correctAnswers[module]?.[`lesson${lesson}`]?.[questionKey] || Math.floor(Math.random() * 3) + 1;
                                
                                // 70% de probabilidad de responder correctamente
                                const isCorrect = Math.random() > 0.3;
                                const studentAnswer = isCorrect ? correctAnswer : (correctAnswer % 3) + 1;
                                
                                answers[questionKey] = studentAnswer;
                                if (studentAnswer === correctAnswer) correctCount++;
                            }
                            
                            student.evaluations[module][`lesson${lesson}`] = {
                                completed: true,
                                answers: answers,
                                score: Math.round((correctCount / 3) * 100),
                                attempts: Math.floor(Math.random() * 2) + 1,
                                timestamp: new Date().toISOString()
                            };
                        }
                    }
                }

                students.push(student);
            });

            return students;
        }

        // Actualizar todas las m√©tricas
        function updateAllMetrics() {
            updateMainStats();
            updateModuleStats();
            updateStudentsTable();
        }

        // Actualizar estad√≠sticas principales
        function updateMainStats() {
            let totalEvaluations = 0;
            let completedEvaluations = 0;
            let totalScore = 0;
            let passedEvaluations = 0;

            allStudentsData.forEach(student => {
                Object.values(student.evaluations).forEach(module => {
                    Object.values(module).forEach(lesson => {
                        totalEvaluations++;
                        if (lesson.completed) {
                            completedEvaluations++;
                            totalScore += lesson.score;
                            if (lesson.score >= 67) passedEvaluations++; // 2/3 = 67%
                        }
                    });
                });
            });

            const avgScore = completedEvaluations > 0 ? Math.round(totalScore / completedEvaluations) : 0;
            const passRate = completedEvaluations > 0 ? Math.round((passedEvaluations / completedEvaluations) * 100) : 0;

            document.getElementById('completedEvals').textContent = completedEvaluations;
            document.getElementById('avgScore').textContent = avgScore + '%';
            document.getElementById('passRate').textContent = passRate + '%';
        }

        // Actualizar estad√≠sticas por m√≥dulo
        function updateModuleStats() {
            for (let module = 1; module <= 3; module++) {
                let completed = 0;
                let totalScore = 0;
                let passed = 0;
                let attempts = 0;

                allStudentsData.forEach(student => {
                    if (student.evaluations[module]) {
                        Object.values(student.evaluations[module]).forEach(lesson => {
                            if (lesson.completed) {
                                completed++;
                                totalScore += lesson.score;
                                if (lesson.score >= 67) passed++;
                                attempts += lesson.attempts;
                            }
                        });
                    }
                });

                const avgScore = completed > 0 ? Math.round(totalScore / completed) : 0;
                const passRate = completed > 0 ? Math.round((passed / completed) * 100) : 0;

                document.getElementById(`m${module}-completed`).textContent = completed;
                document.getElementById(`m${module}-avg`).textContent = avgScore + '%';
                document.getElementById(`m${module}-pass`).textContent = passRate + '%';
                document.getElementById(`m${module}-attempts`).textContent = attempts;

                // Actualizar progreso por lecci√≥n (solo m√≥dulo 1 tiene desglose)
                if (module === 1) {
                    for (let lesson = 1; lesson <= 3; lesson++) {
                        const lessonCompleted = allStudentsData.filter(s => 
                            s.evaluations[module]?.[`lesson${lesson}`]?.completed
                        ).length;
                        
                        const percentage = Math.round((lessonCompleted / allStudentsData.length) * 100);
                        
                        document.getElementById(`m${module}-l${lesson}-count`).textContent = 
                            `${lessonCompleted}/${allStudentsData.length} estudiantes`;
                        
                        const bar = document.getElementById(`m${module}-l${lesson}-bar`);
                        bar.style.width = percentage + '%';
                        bar.textContent = percentage + '%';
                        
                        // Colorear seg√∫n porcentaje
                        bar.className = 'progress-fill-custom';
                        if (percentage < 40) bar.classList.add('danger');
                        else if (percentage < 70) bar.classList.add('warning');
                    }
                }
            }
        }

        // Analizar preguntas dif√≠ciles
        function analyzeDifficultQuestions() {
            const questionStats = {};

            // Analizar todas las respuestas
            allStudentsData.forEach(student => {
                for (let module = 1; module <= 3; module++) {
                    if (!student.evaluations[module]) continue;
                    
                    Object.entries(student.evaluations[module]).forEach(([lessonKey, lesson]) => {
                        if (!lesson.completed) return;
                        
                        Object.entries(lesson.answers).forEach(([questionKey, answer]) => {
                            const questionId = `m${module}-${lessonKey}-${questionKey}`;
                            
                            if (!questionStats[questionId]) {
                                questionStats[questionId] = {
                                    module,
                                    lesson: lessonKey,
                                    question: questionKey,
                                    total: 0,
                                    correct: 0,
                                    answers: {}
                                };
                            }
                            
                            questionStats[questionId].total++;
                            
                            const correctAnswer = correctAnswers[module]?.[lessonKey]?.[questionKey];
                            if (answer === correctAnswer) {
                                questionStats[questionId].correct++;
                            }
                            
                            questionStats[questionId].answers[answer] = 
                                (questionStats[questionId].answers[answer] || 0) + 1;
                        });
                    });
                }
            });

            // Encontrar las 5 preguntas m√°s dif√≠ciles
            const difficultQuestions = Object.entries(questionStats)
                .map(([id, stats]) => ({
                    id,
                    ...stats,
                    errorRate: stats.total > 0 ? ((stats.total - stats.correct) / stats.total) * 100 : 0
                }))
                .filter(q => q.total > 3) // Al menos 3 respuestas
                .sort((a, b) => b.errorRate - a.errorRate)
                .slice(0, 5);

            displayDifficultQuestions(difficultQuestions);
        }

        // Mostrar preguntas dif√≠ciles
        function displayDifficultQuestions(questions) {
            const container = document.getElementById('difficultQuestionsContainer');
            
            if (questions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-check-circle"></i>
                        <p>No hay suficientes datos de evaluaciones a√∫n</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = questions.map(q => {
                const successRate = 100 - q.errorRate;
                const difficulty = q.errorRate > 60 ? 'Dif√≠cil' : q.errorRate > 40 ? 'Media' : 'F√°cil';
                const difficultyClass = q.errorRate > 60 ? 'danger' : q.errorRate > 40 ? 'warning' : 'success';

                return `
                    <div class="question-analysis">
                        <div class="question-header">
                            <div>
                                <span class="question-number">
                                    M√≥dulo ${q.module} - ${q.lesson.replace('lesson', 'Lecci√≥n ')} - Pregunta ${q.question.replace('q', '')}
                                </span>
                                <span class="badge-custom badge-${difficultyClass} ms-2">${difficulty}</span>
                            </div>
                            <div>
                                <small class="text-muted">${q.total} respuestas</small>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted">Tasa de √©xito:</small>
                            <div class="progress-bar-custom mt-1">
                                <div class="progress-fill-custom ${successRate < 40 ? 'danger' : successRate < 70 ? 'warning' : ''}" 
                                     style="width: ${successRate}%">
                                    ${Math.round(successRate)}%
                                </div>
                            </div>
                        </div>

                        <div class="answer-distribution">
                            ${Object.entries(q.answers).map(([ans, count]) => {
                                const percentage = Math.round((count / q.total) * 100);
                                const correctAnswer = correctAnswers[q.module]?.[q.lesson]?.[q.question];
                                const isCorrect = parseInt(ans) === correctAnswer;
                                
                                return `
                                    <div class="answer-bar ${isCorrect ? 'correct' : 'incorrect'}" 
                                         style="flex: ${percentage}">
                                        ${isCorrect ? '‚úì' : ''} ${ans}: ${percentage}%
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Actualizar tabla de estudiantes
        function updateStudentsTable() {
            const tbody = document.getElementById('studentsProgressTable');
            
            tbody.innerHTML = allStudentsData.map(student => {
                const m1Score = calculateModuleAverage(student, 1);
                const m2Score = calculateModuleAverage(student, 2);
                const m3Score = calculateModuleAverage(student, 3);
                
                const overallAvg = Math.round((m1Score + m2Score + m3Score) / 3);
                const status = overallAvg >= 67 ? 'success' : overallAvg >= 50 ? 'warning' : 'danger';
                const statusText = overallAvg >= 67 ? 'Aprobado' : overallAvg >= 50 ? 'En Progreso' : 'Necesita Apoyo';

                return `
                    <tr>
                        <td><strong>${student.name}</strong></td>
                        <td>${formatScore(m1Score)}</td>
                        <td>${formatScore(m2Score)}</td>
                        <td>${formatScore(m3Score)}</td>
                        <td><strong>${overallAvg}%</strong></td>
                        <td><span class="badge-custom badge-${status}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // Calcular promedio de m√≥dulo
        function calculateModuleAverage(student, module) {
            const evaluations = student.evaluations[module];
            if (!evaluations) return 0;

            const scores = Object.values(evaluations)
                .filter(e => e.completed)
                .map(e => e.score);

            return scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
        }

        // Formatear puntaje
        function formatScore(score) {
            if (score === 0) return '<span class="text-muted">-</span>';
            const className = score >= 67 ? 'text-success' : score >= 50 ? 'text-warning' : 'text-danger';
            return `<span class="${className}">${score}%</span>`;
        }

        // Filtrar por m√≥dulo
        function filterByModule(module) {
            currentModuleFilter = module;
            
            // Actualizar botones
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.module == module) {
                    btn.classList.add('active');
                }
            });

            // Filtrar cards
            document.querySelectorAll('.module-eval').forEach(card => {
                if (module === 'all' || card.dataset.module == module) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Mostrar an√°lisis detallado
        function showDetailedAnalysis(module) {
            const modalBody = document.getElementById('detailModalBody');
            document.getElementById('detailModalTitle').innerHTML = 
                `<i class="bi bi-graph-up"></i> An√°lisis Detallado - M√≥dulo ${module}`;

            // Generar contenido detallado
            const lessonsCount = module === 2 ? 4 : 3;
            let content = '';

            for (let lesson = 1; lesson <= lessonsCount; lesson++) {
                const lessonData = analyzeLesson(module, lesson);
                
                content += `
                    <div class="mb-4">
                        <h5 class="text-primary-dark mb-3">Lecci√≥n ${lesson}</h5>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-3">
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value">${lessonData.completed}</div>
                                    <div class="eval-stat-label">Completadas</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value">${lessonData.avgScore}%</div>
                                    <div class="eval-stat-label">Promedio</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value">${lessonData.passed}</div>
                                    <div class="eval-stat-label">Aprobados</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="eval-stat-item">
                                    <div class="eval-stat-value">${lessonData.avgAttempts}</div>
                                    <div class="eval-stat-label">Intentos Promedio</div>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-2">An√°lisis por Pregunta:</h6>
                        ${lessonData.questions.map((q, index) => `
                            <div class="question-analysis">
                                <div class="question-header">
                                    <span class="question-number">Pregunta ${index + 1}</span>
                                    <small class="text-muted">${q.successRate}% de √©xito</small>
                                </div>
                                <div class="answer-distribution">
                                    ${Object.entries(q.distribution).map(([ans, count]) => {
                                        const percentage = Math.round((count / lessonData.completed) * 100);
                                        const isCorrect = parseInt(ans) === q.correctAnswer;
                                        return `
                                            <div class="answer-bar ${isCorrect ? 'correct' : 'incorrect'}" 
                                                 style="flex: ${percentage}">
                                                ${isCorrect ? '‚úì ' : ''}Opci√≥n ${ans}: ${percentage}%
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${lesson < lessonsCount ? '<hr>' : ''}
                `;
            }

            modalBody.innerHTML = content;
            detailModal.show();
        }

        // Analizar datos de una lecci√≥n
        function analyzeLesson(module, lesson) {
            const lessonKey = `lesson${lesson}`;
            let completed = 0;
            let totalScore = 0;
            let passed = 0;
            let totalAttempts = 0;
            const questionsData = { q1: {}, q2: {}, q3: {} };

            allStudentsData.forEach(student => {
                const evaluation = student.evaluations[module]?.[lessonKey];
                if (evaluation?.completed) {
                    completed++;
                    totalScore += evaluation.score;
                    if (evaluation.score >= 67) passed++;
                    totalAttempts += evaluation.attempts;

                    // Analizar respuestas por pregunta
                    Object.entries(evaluation.answers).forEach(([q, ans]) => {
                        if (!questionsData[q][ans]) questionsData[q][ans] = 0;
                        questionsData[q][ans]++;
                    });
                }
            });

            const avgScore = completed > 0 ? Math.round(totalScore / completed) : 0;
            const avgAttempts = completed > 0 ? (totalAttempts / completed).toFixed(1) : 0;

            // Procesar datos de preguntas
            const questions = Object.entries(questionsData).map(([q, distribution]) => {
                const correctAnswer = correctAnswers[module]?.[lessonKey]?.[q] || 1;
                const correctCount = distribution[correctAnswer] || 0;
                const successRate = completed > 0 ? Math.round((correctCount / completed) * 100) : 0;

                return {
                    distribution,
                    correctAnswer,
                    successRate
                };
            });

            return {
                completed,
                avgScore,
                passed,
                avgAttempts,
                questions
            };
        }

        // Refrescar dashboard
        async function refreshDashboard() {
            const btn = event.target.closest('button');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Actualizando...';

            await loadDashboardData();

            btn.disabled = false;
            btn.innerHTML = originalContent;
            showAlert('Dashboard actualizado correctamente', 'success');
        }

        // Exportar a CSV
        function exportToCSV() {
            const csv = [];
            csv.push(['Estudiante', 'M√≥dulo 1', 'M√≥dulo 2', 'M√≥dulo 3', 'Promedio General']);

            allStudentsData.forEach(student => {
                const m1 = calculateModuleAverage(student, 1);
                const m2 = calculateModuleAverage(student, 2);
                const m3 = calculateModuleAverage(student, 3);
                const avg = Math.round((m1 + m2 + m3) / 3);

                csv.push([student.name, m1 + '%', m2 + '%', m3 + '%', avg + '%']);
            });

            const csvContent = csv.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `evaluaciones_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }
    </script>
</body>
</html>
