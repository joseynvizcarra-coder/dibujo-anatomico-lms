<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard Instructor - LMS Dibujo Anat√≥mico UAH (Conectado)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root{
            --primary-dark:#2c5f66;--primary-light:#e8a2b8;--dark:#1a1a1a;--light-bg:#f8f9fa;
        }
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--light-bg);color:var(--dark);margin:0}
        .header-uah{background:linear-gradient(135deg,var(--primary-dark),var(--dark));color:#fff;padding:1rem 0;position:sticky;top:0;z-index:1030}
        .header-title{color:var(--primary-light);font-size:1.25rem;font-weight:700;margin:0}
        .btn-header{background:rgba(255,255,255,.15);color:#fff;padding:.4rem .8rem;border-radius:20px;border:none}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin:1.25rem 0}
        .stat-card{background:#fff;padding:1rem;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.04);position:relative}
        .stat-number{font-size:1.75rem;font-weight:700;color:var(--primary-dark)}
        .section-card{background:#fff;padding:1.25rem;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.04);margin-bottom:1rem}
        .loading-spinner{border:3px solid var(--light-bg);border-top:3px solid var(--primary-dark);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .risk-badge{padding:.25rem .6rem;border-radius:20px;font-weight:600;font-size:.8rem}
        .risk-high{background:#fee2e2;color:#dc2626}.risk-medium{background:#fef3c7;color:#d97706}.risk-low{background:#d1fae5;color:#059669}
        .progress-bar-small{background:#e9ecef;border-radius:10px;height:8px;width:100px;display:inline-block;overflow:hidden}
        .progress-fill-small{height:100%;border-radius:10px;transition:width .3s ease;background:linear-gradient(90deg,var(--primary-dark),var(--primary-light))}
        .sync-indicator{position:fixed;bottom:20px;right:20px;z-index:9999;background:#fff;padding:.6rem 1rem;border-radius:18px;box-shadow:0 6px 18px rgba(0,0,0,.12);font-size:.9rem}
    </style>
</head>
<body>
    <!-- auth.js must be in same folder or path valid -->
    <script src="auth.js"></script>

    <header class="header-uah">
        <div class="container-fluid">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h1 class="header-title"><i class="bi bi-graph-up me-2"></i>Dashboard Instructor</h1>
                    <small class="text-white-50">LMS Dibujo Anat√≥mico UAH</small>
                </div>
                <div class="text-end">
                    <span id="instructorName" class="text-white me-3">Cargando...</span>
                    <a href="index.html" class="btn-header me-2"><i class="bi bi-arrow-left me-1"></i>Volver</a>
                    <button class="btn-header" id="logoutBtn"><i class="bi bi-box-arrow-right me-1"></i>Salir</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container-fluid py-4">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="totalStudents">-</div>
                <div class="text-muted">Estudiantes Inscritos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeStudents">-</div>
                <div class="text-muted">Estudiantes Activos</div>
                <div class="text-muted small" id="activePercentage">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgProgress">-</div>
                <div class="text-muted">Progreso Promedio</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="atRiskStudents">-</div>
                <div class="text-muted">Estudiantes en Riesgo</div>
            </div>
        </div>

        <section class="section-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>M√©tricas Pedag√≥gicas</h5>
                <div>
                    <button class="btn btn-sm btn-secondary me-2" id="forceSyncBtn" title="Forzar sincronizaci√≥n">Forzar sync</button>
                    <button class="btn btn-sm btn-success" id="refreshBtn"><i class="bi bi-arrow-clockwise me-1"></i>Actualizar</button>
                </div>
            </div>

            <div class="row gy-3">
                <div class="col-md-3">
                    <div class="p-2 bg-light rounded text-center">
                        <div class="h4 mb-0" id="completionRate">-</div>
                        <small class="text-muted">Tasa de Finalizaci√≥n</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-2 bg-light rounded text-center">
                        <div class="h4 mb-0" id="avgTimePerModule">-</div>
                        <small class="text-muted">Tiempo Prom. por M√≥dulo</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-2 bg-light rounded text-center">
                        <div class="h4 mb-0" id="evalPassRate">-</div>
                        <small class="text-muted">Tasa Aprobaci√≥n Evals</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-2 bg-light rounded text-center">
                        <div class="h4 mb-0" id="retentionRate">-</div>
                        <small class="text-muted">Tasa de Retenci√≥n (7d)</small>
                    </div>
                </div>
            </div>
        </section>

        <section class="section-card">
            <h5 class="mb-3"><i class="bi bi-people me-2"></i>Estudiantes del Curso</h5>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Estudiante</th><th>Usuario</th><th>Progreso</th><th>M√≥dulos</th><th>Evaluaciones</th><th>√öltimo Acceso</th><th>Riesgo</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr><td colspan="7" class="text-center py-4"><div class="loading-spinner"></div><div class="small text-muted mt-2">Cargando estudiantes...</div></td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="section-card">
            <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>Evaluaciones por Lecci√≥n</h5>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Estudiante</th><th class="text-center">M1.1</th><th class="text-center">M1.2</th><th class="text-center">M1.3</th>
                            <th class="text-center">M2.1</th><th class="text-center">M2.2</th><th class="text-center">M2.3</th><th class="text-center">M2.4</th>
                            <th class="text-center">M3.1</th><th class="text-center">M3.2</th><th class="text-center">M3.3</th><th class="text-center">Total</th>
                        </tr>
                    </thead>
                    <tbody id="evaluationsTableBody">
                        <tr><td colspan="12" class="text-center py-3 small text-muted">Cargando evaluaciones...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="section-card">
            <h5 class="mb-3"><i class="bi bi-clock-history me-2"></i>Actividad Reciente</h5>
            <div id="activityLog" style="max-height:300px;overflow:auto;border-radius:6px;border:1px solid #eee;padding:.5rem">
                <div class="text-center py-4"><div class="loading-spinner"></div><div class="small text-muted mt-2">Cargando actividades...</div></div>
            </div>
        </section>

        <section class="section-card">
            <h6 class="mb-1"><i class="bi bi-info-circle me-2"></i>Informaci√≥n del Sistema</h6>
            <div class="small text-muted">√öltima actualizaci√≥n: <span id="lastUpdate">-</span></div>
            <div class="small text-muted">Total usuarios: <span id="totalUsers">-</span> (<span id="studentsCount">-</span> estudiantes)</div>
        </section>
    </main>

    <div id="syncIndicator" class="sync-indicator" aria-hidden="true">üîÑ Sincronizando...</div>

    <script>
    // NOTE: Do NOT redeclare TOTAL_MODULES here; auth.js provides it.
    (function(){
        // Ensure auth.js loaded and functions are available
        function waitForAuthReady(timeout = 3000) {
            return new Promise((resolve, reject) => {
                const start = Date.now();
                const check = () => {
                    if (typeof protectPage === 'function' && typeof getCurrentUser === 'function' && typeof makeJSONPRequest === 'function') {
                        return resolve();
                    }
                    if (Date.now() - start > timeout) return reject(new Error('auth.js no carg√≥ a tiempo'));
                    setTimeout(check, 50);
                };
                check();
            });
        }

        async function init() {
            try {
                await waitForAuthReady(5000);
            } catch (e) {
                alert('Error cargando auth.js: ' + e.message);
                console.error(e);
                return;
            }

            // Protect page for instructor only
            if (!protectPage('instructor')) {
                return;
            }

            const user = getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('instructorName').textContent = user.fullName || user.username;
            document.getElementById('logoutBtn').addEventListener('click', function(){ logout(); });

            // Wire test buttons
            document.getElementById('refreshBtn').addEventListener('click', refreshDashboard);
            document.getElementById('forceSyncBtn').addEventListener('click', async function(){
                const u = getCurrentUser();
                if (!u) return showToast('No hay sesi√≥n', 'error');
                showToast('Sincronizando...', 'info');
                try {
                    const ok = await syncProgressFromSheets(u.username, true);
                    if (ok) {
                        showToast('Sincronizado correctamente', 'success');
                        await loadDashboardData();
                    } else {
                        showToast('Sincronizaci√≥n fallida', 'danger');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Error durante sincronizaci√≥n', 'danger');
                }
            });

            // Inject sync indicator update listener
            window.addEventListener('syncStatusChanged', (ev) => {
                const detail = ev.detail || {};
                const el = document.getElementById('syncIndicator');
                if (!el) return;
                const status = detail.status || 'synced';
                const msg = detail.message || '';
                const map = { synced: '‚úÖ ' + msg, syncing: 'üîÑ ' + msg, error: '‚ö†Ô∏è ' + msg, offline: 'üî¥ ' + msg };
                el.textContent = map[status] || msg;
            });

            // Load initial data
            await loadDashboardData();
            // Log access
            await logUserActivity('dashboard_access', '', '');
        }

        // Shared state
        const dashboardData = { students: [], evaluators: [], activities: [], evaluations: {} };

        async function loadDashboardData() {
            setSyncIndicator('üîÑ Cargando...');
            try {
                await loadStudentsData();
                await loadRecentActivities();
                processEvaluations();
                updateMainStats();
                updatePedagogicalMetrics();
                updateModuleStats();
                updateEvaluationsTable();
                updateTopStudents();
                updateProgressDistribution();
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
                setSyncIndicator('‚úÖ √öltima actualizaci√≥n: ' + new Date().toLocaleTimeString());
            } catch (err) {
                console.error('Error cargando dashboard:', err);
                alert('Error cargando datos. Revisa la consola.');
                setSyncIndicator('‚ö†Ô∏è Error cargando');
            }
        }

        async function loadStudentsData() {
            const res = await makeJSONPRequest('getAllStudents');
            if (!res || !res.success) throw new Error(res?.error || 'No data');
            const all = res.data || [];
            dashboardData.students = all.filter(u => u.role === 'estudiante');
            dashboardData.evaluators = all.filter(u => u.role === 'evaluador');
            document.getElementById('totalUsers').textContent = all.length;
            document.getElementById('studentsCount').textContent = dashboardData.students.length;
            updateStudentsTable();
            updateEvaluatorsTable();
        }

        async function loadRecentActivities() {
            const res = await makeJSONPRequest('getActivities', { limit: 50 });
            if (res && res.success) {
                dashboardData.activities = res.data || [];
                updateActivityLog();
            } else {
                dashboardData.activities = [];
            }
        }

        function processEvaluations() {
            const evals = {};
            dashboardData.students.forEach(s => {
                evals[s.username] = {
                    module1: s.progress?.modules?.[1]?.evaluations || {},
                    module2: s.progress?.modules?.[2]?.evaluations || {},
                    module3: s.progress?.modules?.[3]?.evaluations || {}
                };
            });
            dashboardData.evaluations = evals;
        }

        function updateMainStats() {
            const students = dashboardData.students || [];
            const total = students.length;
            const active = students.filter(s => (s.progress?.overallProgress || 0) > 0).length;
            const atRisk = students.filter(s => (s.progress?.overallProgress || 0) < 25 || !s.progress).length;
            const avg = total ? Math.round(students.reduce((acc,s)=>acc+(s.progress?.overallProgress||0),0)/total) : 0;
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('activePercentage').textContent = total ? Math.round((active/total)*100) + '%' : '0%';
            document.getElementById('avgProgress').textContent = avg + '%';
            document.getElementById('atRiskStudents').textContent = atRisk;
        }

        function updatePedagogicalMetrics() {
            const students = dashboardData.students || [];
            const total = students.length;
            const completed = students.filter(s => (s.progress?.overallProgress||0) === 100).length;
            document.getElementById('completionRate').textContent = total ? Math.round((completed/total)*100) + '%' : '0%';

            // avg time per module
            let totalTime=0, count=0;
            students.forEach(s=>{
                [1,2,3].forEach(m=>{
                    const t = s.progress?.modules?.[m]?.timeSpent;
                    if (typeof t === 'number'){ totalTime += t; count++; }
                });
            });
            document.getElementById('avgTimePerModule').textContent = count ? Math.round(totalTime/count) + 'h' : '0h';

            // eval pass rate (simple heuristic)
            let passed=0, totalEvals=0;
            Object.values(dashboardData.evaluations).forEach(st=>{
                [1,2,3].forEach(m=>{
                    const module = st['module'+m]||{};
                    Object.keys(module).forEach(lesson=>{
                        totalEvals++;
                        if (isEvaluationPassed(module, parseInt(lesson))) passed++;
                    });
                });
            });
            document.getElementById('evalPassRate').textContent = totalEvals ? Math.round((passed/totalEvals)*100) + '%' : '0%';

            // retention 7 days
            const recent = new Date(); recent.setDate(recent.getDate()-7);
            const recentActive = students.filter(s => s.progress?.lastAccess && new Date(s.progress.lastAccess) > recent).length;
            document.getElementById('retentionRate').textContent = total ? Math.round((recentActive/total)*100) + '%' : '0%';
        }

        function isEvaluationPassed(moduleEvals, lessonNum) {
            if (!moduleEvals || typeof moduleEvals !== 'object') return false;
            const le = moduleEvals[lessonNum];
            if (!le || typeof le !== 'object') return false;
            return Object.keys(le).length >= 2;
        }

        function updateModuleStats() {
            // Minimal: update counts per module
            [1,2,3].forEach(m=>{
                const completed = dashboardData.students.filter(s => s.progress?.modules?.[m]?.completed).length;
                const inProgress = dashboardData.students.filter(s => (s.progress?.modules?.[m]?.progress||0) > 0 && !s.progress?.modules?.[m]?.completed).length;
                const avgTime = (() => {
                    let t=0,c=0;
                    dashboardData.students.forEach(s=>{
                        const ts = s.progress?.modules?.[m]?.timeSpent;
                        if (typeof ts === 'number'){ t+=ts; c++; }
                    });
                    return c ? Math.round(t/c) + 'h' : '-';
                })();
                const elComp = document.getElementById('module'+m+'Completed');
                if (elComp) elComp.textContent = completed;
                const elProg = document.getElementById('module'+m+'InProgress');
                if (elProg) elProg.textContent = inProgress;
                const elTime = document.getElementById('module'+m+'AvgTime');
                if (elTime) elTime.textContent = avgTime;
                const elPass = document.getElementById('module'+m+'PassRate');
                if (elPass) elPass.textContent = '-';
            });
        }

        function updateStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';
            const students = dashboardData.students || [];
            if (!students.length){
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 small text-muted">No hay estudiantes registrados</td></tr>';
                return;
            }
            students.forEach(student=>{
                const overall = student.progress?.overallProgress || 0;
                const completedModules = Object.values(student.progress?.modules || {}).filter(m=>m.completed).length;
                let passedEvals = 0;
                const evals = dashboardData.evaluations[student.username] || {};
                [1,2,3].forEach(m=>{
                    const mod = evals['module'+m]||{};
                    Object.keys(mod).forEach(l=>{ if (isEvaluationPassed(mod, parseInt(l))) passedEvals++; });
                });
                let lastAccessText = 'Nunca';
                let daysSince = 999;
                if (student.progress?.lastAccess){ const dt = new Date(student.progress.lastAccess); lastAccessText = dt.toLocaleString(); daysSince = Math.floor((Date.now()-dt.getTime())/(1000*60*60*24)); }
                let riskClass='risk-low', riskText='Bajo';
                if (overall < 25 || daysSince > 7){ riskClass='risk-high'; riskText='Alto'; }
                else if (overall < 50 || daysSince > 3){ riskClass='risk-medium'; riskText='Medio'; }
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><strong>${student.fullName||student.username}</strong></td>
                    <td><code class="small">${student.username}</code></td>
                    <td><div class="d-flex align-items-center gap-2"><div class="progress-bar-small"><div class="progress-fill-small" style="width:${overall}%"></div></div><span class="small">${overall}%</span></div></td>
                    <td class="text-center"><strong>${completedModules}</strong>/3</td>
                    <td class="text-center"><strong>${passedEvals}</strong>/10</td>
                    <td class="small text-muted">${lastAccessText}</td>
                    <td><span class="risk-badge ${riskClass}">${riskText}</span></td>`;
                tbody.appendChild(tr);
            });
        }

        function updateEvaluatorsTable(){
            const tbody = document.getElementById('evaluatorsTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            const evs = dashboardData.evaluators || [];
            if (!evs.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3 small text-muted">No hay evaluadores registrados</td></tr>'; return; }
            evs.forEach(e=>{
                const overall = e.progress?.overallProgress || 0;
                const completedModules = Object.values(e.progress?.modules || {}).filter(m=>m.completed).length;
                const lastAccess = e.progress?.lastAccess ? new Date(e.progress.lastAccess).toLocaleDateString() : 'Nunca';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><strong>${e.fullName||e.username}</strong> <span class="badge bg-info">Evaluador</span></td>
                                <td><code class="small">${e.username}</code></td>
                                <td><div class="d-flex align-items-center gap-2"><div class="progress-bar-small"><div class="progress-fill-small" style="width:${overall}%"></div></div><span class="small">${overall}%</span></div></td>
                                <td class="text-center"><strong>${completedModules}</strong>/3</td>
                                <td class="small text-muted">${lastAccess}</td>`;
                tbody.appendChild(tr);
            });
        }

        function updateEvaluationsTable(){
            const tbody = document.getElementById('evaluationsTableBody');
            tbody.innerHTML = '';
            const students = dashboardData.students || [];
            if (!students.length){ tbody.innerHTML = '<tr><td colspan="12" class="text-center py-3 small text-muted">No hay datos</td></tr>'; return; }
            students.forEach(student=>{
                const ev = dashboardData.evaluations[student.username] || {};
                const checks = [];
                for (let l=1;l<=3;l++) checks.push(isEvaluationPassed(ev.module1, l));
                for (let l=1;l<=4;l++) checks.push(isEvaluationPassed(ev.module2, l));
                for (let l=1;l<=3;l++) checks.push(isEvaluationPassed(ev.module3, l));
                const total = checks.filter(Boolean).length;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><strong>${student.fullName||student.username}</strong></td>` + checks.map(p=>`<td class="text-center"><i class="bi bi-${p?'check-circle-fill text-success':'circle text-muted'}"></i></td>`).join('') + `<td class="text-center"><strong>${total}</strong>/10</td>`;
                tbody.appendChild(tr);
            });
        }

        function updateTopStudents(){
            // not shown in simplified UI, but can be added
        }

        function updateProgressDistribution(){
            // simple version: update progress bars if present
            const ranges = {'0-25':0,'26-50':0,'51-75':0,'76-100':0};
            (dashboardData.students||[]).forEach(s=>{
                const p = s.progress?.overallProgress || 0;
                if (p<=25) ranges['0-25']++; else if (p<=50) ranges['26-50']++; else if (p<=75) ranges['51-75']++; else ranges['76-100']++;
            });
            Object.keys(ranges).forEach(r=>{
                const el = document.getElementById('dist'+r);
                if (el){ const percent = Math.round((ranges[r]/(dashboardData.students.length||1))*100); el.style.width = percent+'%'; el.textContent = ranges[r]; }
            });
        }

        function updateActivityLog(){
            const el = document.getElementById('activityLog');
            if (!el) return;
            const activities = dashboardData.activities || [];
            if (!activities.length){ el.innerHTML = '<div class="p-3 text-center small text-muted">No hay actividades registradas</div>'; return; }
            el.innerHTML = activities.slice(0,40).map(a=>{
                const t = new Date(a.timestamp).toLocaleString();
                const who = a.username || a.userId || 'n/a';
                const desc = a.action || a.activityType || 'actividad';
                return `<div style="padding:.6rem;border-bottom:1px solid #f1f1f1;display:flex;justify-content:space-between"><div><strong>${who}</strong><div class="small text-muted">${desc}</div></div><div class="small text-muted">${t}</div></div>`;
            }).join('');
        }

        function setSyncIndicator(txt){
            const el = document.getElementById('syncIndicator');
            if (el) el.textContent = txt;
        }

        // Small UI helpers from auth.js are available (showToast used here)
        function showToast(msg, type='info'){
            if (typeof window.showToast === 'function') return window.showToast(msg, type);
            const colors = {success:'#10b981',info:'#3b82f6',warning:'#f59e0b',danger:'#ef4444'};
            const t = document.createElement('div'); t.textContent = msg;
            t.style.cssText = `position:fixed;top:20px;right:20px;background:${colors[type]};color:white;padding:.8rem 1rem;border-radius:8px;z-index:10000`;
            document.body.appendChild(t); setTimeout(()=>t.remove(),2500);
            
                async function refreshDashboard() {
            showToast('Actualizando dashboard...', 'info');
            await loadDashboardData();
            showToast('Dashboard actualizado', 'success');
        }
}

        // init
        init();
    })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
