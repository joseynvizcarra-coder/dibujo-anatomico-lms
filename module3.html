<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo 3: Figura Completa - LMS UAH</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary-dark: #2c5f66;
            --primary-light: #e8a2b8;
            --dark: #1a1a1a;
            --gray-light: #f5f5f5;
            --gray-medium: #666;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #f44336;
            --info: #2196F3;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .header-uah {
            background: linear-gradient(135deg, var(--primary-dark), var(--dark));
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1030;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .breadcrumb-custom {
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .sidebar-lesson {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        @media (min-width: 992px) {
            .sidebar-lesson {
                position: sticky;
                top: 90px;
                max-height: calc(100vh - 110px);
                overflow-y: auto;
            }
        }

        .lesson-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 0.5rem;
            border: 2px solid transparent;
        }

        .lesson-link:hover {
            background: #f8f9fa;
            transform: translateX(3px);
            border-color: var(--primary-light);
        }

        .lesson-link.active {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: white;
        }

        .lesson-number {
            width: 35px;
            height: 35px;
            background: var(--primary-dark);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .lesson-link.active .lesson-number {
            background: white;
            color: var(--primary-dark);
        }

        .main-content-area {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            min-height: 500px;
        }

        /* PREREQUISITOS */
        .prereq-screen {
            text-align: center;
            padding: 3rem 2rem;
        }

        .prereq-icon {
            font-size: 5rem;
            color: var(--warning);
            margin-bottom: 1.5rem;
        }

        .prereq-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }

        .prereq-list {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-dark);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem auto;
            max-width: 600px;
            text-align: left;
        }

        .prereq-list h5 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .prereq-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .prereq-list li {
            padding: 0.75rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .prereq-list li:last-child {
            border-bottom: none;
        }

        .prereq-list li i {
            color: var(--success);
            font-size: 1.2rem;
        }

        .prereq-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 500px;
            margin: 2rem auto;
        }

        /* TEST DIAGN√ìSTICO */
        .test-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .test-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--dark));
            color: white;
            padding: 2.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .test-instructions {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .test-counter {
            background: rgba(255,255,255,0.2);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            display: inline-block;
            margin-top: 1rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .test-question {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .test-question:hover {
            border-color: var(--primary-light);
            box-shadow: 0 4px 12px rgba(44,95,102,0.1);
        }

        .question-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .question-number {
            background: var(--primary-dark);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .question-text {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            line-height: 1.5;
        }

        .test-option {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin: 0.75rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .test-option:hover {
            background: #e9ecef;
            border-color: var(--primary-light);
            transform: translateX(5px);
        }

        .test-option.selected {
            background: #d1ecf1;
            border-color: var(--primary-dark);
        }

        .test-option.correct {
            background: #d4edda;
            border-color: var(--success);
        }

        .test-option.incorrect {
            background: #f8d7da;
            border-color: var(--danger);
        }

        .test-radio {
            width: 22px;
            height: 22px;
            border: 3px solid #999;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
        }

        .test-option.selected .test-radio {
            border-color: var(--primary-dark);
        }

        .test-option.selected .test-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--primary-dark);
            border-radius: 50%;
        }

        .test-result {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .test-result.success {
            background: #d4edda;
            border: 2px solid var(--success);
            color: #155724;
        }

        .test-result.failure {
            background: #f8d7da;
            border: 2px solid var(--danger);
            color: #721c24;
        }

        /* PROGRESS BAR */
        .progress-module {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-bar-module {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #20c997);
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* MENTOR BUTTON - EXACTO AL INDEX */
        .mentor-float-button {
            position: fixed;
            bottom: 8rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            border-radius: 50%;
            box-shadow: 0 6px 20px rgba(44, 95, 102, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9998;
            transition: all 0.3s ease;
            border: 3px solid white;
        }

        .mentor-float-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(44, 95, 102, 0.7);
        }

        .mentor-float-button i {
            color: white;
            font-size: 2rem;
        }

        .mentor-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            border: 2px solid white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .mentor-chat-container {
            position: fixed;
            bottom: 8rem;
            right: 2rem;
            width: 400px;
            max-width: calc(100vw - 2rem);
            height: 600px;
            max-height: calc(100vh - 12rem);
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 9999;
            animation: slideUp 0.3s ease-out;
        }

        .mentor-chat-container.show {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mentor-chat-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: white;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 20px 20px 0 0;
        }

        .mentor-chat-header-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .mentor-avatar {
            width: 46px;
            height: 46px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
        }

        .mentor-status {
            display: flex;
            flex-direction: column;
        }

        .mentor-name {
            font-weight: 600;
            font-size: 1.05rem;
        }

        .mentor-online {
            font-size: 0.8rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .mentor-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mentor-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .mentor-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mentor-chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .mentor-chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: 0.5rem;
            animation: fadeInMessage 0.3s ease-out;
        }

        @keyframes fadeInMessage {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            font-size: 0.9rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.mentor .message-bubble {
            background: white;
            color: var(--dark);
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .mentor-chat-input-container {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .mentor-chat-input {
            flex: 1;
            border: 2px solid var(--gray-light);
            border-radius: 25px;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            resize: none;
            max-height: 100px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .mentor-chat-input:focus {
            outline: none;
            border-color: var(--primary-light);
        }

        .mentor-send-btn {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            border: none;
            color: white;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mentor-send-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(44, 95, 102, 0.3);
        }

        .action-button {
            background: white;
            border: 2px solid var(--primary-light);
            color: var(--primary-dark);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: inline-block;
            margin: 0.25rem;
        }

        .action-button:hover {
            background: var(--primary-light);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .eval-option {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin: 0.75rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .eval-option:hover {
            background: #e9ecef;
            border-color: var(--primary-light);
        }

        .eval-option.selected {
            background: #d1ecf1;
            border-color: var(--primary-dark);
        }

        .eval-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #666;
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
        }

        .eval-option.selected .eval-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--primary-dark);
            border-radius: 50%;
        }
        @media (max-width: 992px) {
            .main-content-area {
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .mentor-chat-container {
                width: calc(100vw - 2rem);
                height: calc(100vh - 12rem);
                bottom: 6rem;
                right: 1rem;
            }

            .mentor-float-button {
                bottom: 6rem;
                right: 1.5rem;
                width: 60px;
                height: 60px;
            }

            .prereq-title {
                font-size: 1.5rem;
            }

            .test-header {
                padding: 1.5rem;
            }
        }

        .btn-nav {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-nav:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header-uah">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">DIADIFO - Dibujo Figura Humana</h5>
                    <small class="text-white-50">Universidad Alberto Hurtado</small>
                </div>
                <a href="index.html" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-house-door me-1"></i>Inicio
                </a>
            </div>
        </div>
    </header>

    <div class="container my-4">
        <!-- Breadcrumb -->
        <nav class="breadcrumb-custom" aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="index.html">Inicio</a></li>
                <li class="breadcrumb-item active">M√≥dulo 3</li>
            </ol>
        </nav>

        <!-- Main Layout -->
        <div class="row g-4">
            <!-- Sidebar -->
            <aside class="col-lg-3">
                <div class="sidebar-lesson">
                    <h5 class="mb-3" style="color: var(--primary-dark); font-weight: 700;">
                        <i class="bi bi-list-ul me-2"></i>Lecciones
                    </h5>
                    
                    <a class="lesson-link" data-lesson="1" onclick="loadLesson(1)">
                        <span class="lesson-number">1</span>
                        <span class="flex-grow-1">S√≠ntesis por Capas</span>
                    </a>
                    
                    <a class="lesson-link" data-lesson="2" onclick="loadLesson(2)">
                        <span class="lesson-number">2</span>
                        <span class="flex-grow-1">Luz, Sombra y Volumen</span>
                    </a>
                    
                    <a class="lesson-link" data-lesson="3" onclick="loadLesson(3)">
                        <span class="lesson-number">3</span>
                        <span class="flex-grow-1">Proyecto Final</span>
                    </a>
                    
                    <div class="mt-4">
                        <h6 class="mb-2">Progreso del M√≥dulo</h6>
                        <div class="progress-module">
                            <div class="progress-bar-module" id="progressBar" style="width: 0%">0%</div>
                        </div>
                        <small class="text-muted d-block mt-2" id="progressDetail">0 de 3 lecciones completadas</small>
                    </div>

                    <div class="card border-primary mt-3">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-info-circle me-2"></i>Informaci√≥n
                        </div>
                        <div class="card-body">
                            <p class="small mb-2"><strong>Duraci√≥n:</strong> 5 d√≠as</p>
                            <p class="small mb-2"><strong>Carga:</strong> 200 min</p>
                            <p class="small mb-0"><strong>Entregables:</strong></p>
                            <ul class="small mb-0 mt-2">
                                <li>2 figuras completas</li>
                                <li>1 figura con valores</li>
                                <li>1 proyecto final</li>
                                <li>3 evaluaciones</li>
                            </ul>
                        </div>
                    </div>

                    <div class="card border-success mt-3">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-cloud-upload me-2"></i>Entrega Final
                        </div>
                        <div class="card-body text-center">
                            <p class="mb-3 small">Fotograf√≠a tus trabajos y s√∫belos:</p>
                            <a href="https://forms.gle/TU_URL_AQUI" 
                               class="btn btn-primary btn-sm" 
                               target="_blank">
                                <i class="bi bi-box-arrow-up-right me-2"></i>Subir Trabajos
                            </a>
                            <p class="small text-muted mt-3 mb-0">
                                Plazo: Al completar el m√≥dulo
                            </p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="col-lg-9">
                <div class="main-content-area" id="mainContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3">Inicializando m√≥dulo...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Mentor Float Button -->
    <button class="mentor-float-button" id="mentorFloatBtn" aria-label="Abrir Mentor Virtual">
        <i class="bi bi-chat-dots-fill"></i>
        <span class="mentor-badge">!</span>
    </button>

    <!-- Mentor Chat Container -->
    <div class="mentor-chat-container" id="mentorChatContainer">
        <div class="mentor-chat-header">
            <div class="mentor-chat-header-info">
                <div class="mentor-avatar">üé®</div>
                <div class="mentor-status">
                    <div class="mentor-name">Mentor Anat√≥mico</div>
                    <div class="mentor-online">
                        <span class="status-dot"></span>
                        En l√≠nea
                    </div>
                </div>
            </div>
            <button class="mentor-close-btn" id="mentorCloseBtn" aria-label="Cerrar chat">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <div class="mentor-chat-messages" id="mentorMessages">
            <!-- Messages loaded dynamically -->
        </div>

        <div class="mentor-chat-input-container">
            <textarea 
                class="mentor-chat-input" 
                id="mentorInput" 
                placeholder="Escribe tu pregunta o duda..."
                rows="1"
            ></textarea>
            <button class="mentor-send-btn" id="mentorSendBtn" aria-label="Enviar mensaje">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    <script>
        // ===== VARIABLES GLOBALES =====
        let currentLesson = 0;
        let moduleProgress = {
            completedLessons: [],
            evaluations: {},
            testDiagnostico: null
        };
        let testAnswers = {};

        // ===== INICIALIZACI√ìN =====
        async function initializeModule() {
            console.log('üé® Inicializando M√≥dulo 3...');
            
            const currentUser = getCurrentUser();
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            await syncProgressFromSheets(currentUser, true);
            const progress = getStoredProgress();
            
            if (progress && progress.modules && progress.modules[3]) {
                moduleProgress = progress.modules[3];
            }

            // Verificar si ya aprob√≥ el test
            if (moduleProgress.testDiagnostico && moduleProgress.testDiagnostico.aprobado) {
                console.log('‚úÖ Test ya aprobado, iniciando m√≥dulo');
                iniciarModulo();
            } else {
                showPrerequisitos();
            }

            updateProgressBar();
        }

        // ===== PREREQUISITOS =====
        function showPrerequisitos() {
            const content = `
                <div class="prereq-screen">
                    <div class="prereq-icon">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <h2 class="prereq-title">‚ö†Ô∏è M√≥dulo Avanzado</h2>
                    <p class="lead text-muted">Este m√≥dulo requiere conocimientos de los M√≥dulos 1 y 2</p>

                    <div class="prereq-list">
                        <h5><i class="bi bi-check2-square me-2"></i>Prerequisitos</h5>
                        <ul>
                            <li>
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>L√≠nea de acci√≥n</strong> (M√≥dulo 1)</span>
                            </li>
                            <li>
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>3 masas corporales</strong> (M√≥dulo 2)</span>
                            </li>
                            <li>
                                <i class="bi bi-check-circle-fill"></i>
                                <span><strong>Proporciones b√°sicas</strong> (M√≥dulos 1 y 2)</span>
                            </li>
                        </ul>
                    </div>

                    <div class="prereq-buttons">
                        <button class="btn btn-success btn-nav btn-lg w-100" onclick="iniciarModulo()">
                            <i class="bi bi-check-circle me-2"></i>Complet√© M√≥dulos 1 y 2
                        </button>
                        <button class="btn btn-primary btn-nav btn-lg w-100" onclick="mostrarTestDiagnostico()">
                            <i class="bi bi-clipboard-check me-2"></i>Test Diagn√≥stico
                        </button>
                        <a href="index.html" class="btn btn-outline-secondary btn-nav btn-lg w-100">
                            <i class="bi bi-arrow-left me-2"></i>Volver a M√≥dulos 1 y 2
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = content;
        }

        // ===== TEST DIAGN√ìSTICO =====
        async function mostrarTestDiagnostico() {
            const intentos = moduleProgress.testDiagnostico ? moduleProgress.testDiagnostico.intentos || 0 : 0;
            
            if (intentos >= 3) {
                alert('Has alcanzado el l√≠mite de 3 intentos. Por favor, completa los M√≥dulos 1 y 2 antes de continuar.');
                return;
            }

            // Registrar que el usuario inici√≥ el test diagn√≥stico
            await logUserActivity('test_diagnostico_inicio', 3, 0, {
                intento: intentos + 1,
                fecha: new Date().toISOString()
            });

            testAnswers = {};

            const content = `
                <div class="test-container">
                    <div class="test-header">
                        <h3>üìã Test Diagn√≥stico</h3>
                        <p class="mb-0">Verifica tus conocimientos de los M√≥dulos 1 y 2</p>
                        <div class="test-instructions">
                            <p class="mb-1"><strong>Instrucciones:</strong></p>
                            <ul class="mb-1 text-start" style="list-style-position: inside;">
                                <li>5 preguntas de opci√≥n m√∫ltiple</li>
                                <li>M√≠nimo aprobatorio: 4/5 correctas (80%)</li>
                                <li>M√°ximo 3 intentos</li>
                            </ul>
                        </div>
                        <div class="test-counter" id="testCounter">Respondidas: 0/5</div>
                    </div>

                    <div class="test-question">
                        <div class="question-header">
                            <span class="question-number">1</span>
                            <span class="question-text">¬øCu√°l es la l√≠nea de acci√≥n correcta en una figura?</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(1, 'A')">
                            <div class="test-radio"></div>
                            <span>A) Una l√≠nea recta vertical en el centro</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(1, 'B')">
                            <div class="test-radio"></div>
                            <span>B) Una curva en "C" que atraviesa el cuerpo capturando el movimiento</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(1, 'C')">
                            <div class="test-radio"></div>
                            <span>C) El contorno exterior de la figura</span>
                        </div>
                    </div>

                    <div class="test-question">
                        <div class="question-header">
                            <span class="question-number">2</span>
                            <span class="question-text">¬øCu√°les son las 3 masas corporales fundamentales?</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(2, 'A')">
                            <div class="test-radio"></div>
                            <span>A) Brazos, piernas y tronco</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(2, 'B')">
                            <div class="test-radio"></div>
                            <span>B) Cabeza, torso y pelvis</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(2, 'C')">
                            <div class="test-radio"></div>
                            <span>C) Hombros, abdomen y caderas</span>
                        </div>
                    </div>

                    <div class="test-question">
                        <div class="question-header">
                            <span class="question-number">3</span>
                            <span class="question-text">En contrapposto con peso en la pierna derecha, ¬øqu√© sucede?</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(3, 'A')">
                            <div class="test-radio"></div>
                            <span>A) La cadera derecha sube y el hombro derecho baja</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(3, 'B')">
                            <div class="test-radio"></div>
                            <span>B) La cadera derecha baja y el hombro derecho sube</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(3, 'C')">
                            <div class="test-radio"></div>
                            <span>C) Ambas caderas y hombros quedan al mismo nivel</span>
                        </div>
                    </div>

                    <div class="test-question">
                        <div class="question-header">
                            <span class="question-number">4</span>
                            <span class="question-text">¬øC√≥mo se estructura correctamente una mano?</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(4, 'A')">
                            <div class="test-radio"></div>
                            <span>A) Como 5 l√≠neas que salen de un punto</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(4, 'B')">
                            <div class="test-radio"></div>
                            <span>B) Un bloque rectangular (palma) m√°s 5 cilindros articulados (dedos)</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(4, 'C')">
                            <div class="test-radio"></div>
                            <span>C) Una esfera con extensiones</span>
                        </div>
                    </div>

                    <div class="test-question">
                        <div class="question-header">
                            <span class="question-number">5</span>
                            <span class="question-text">¬øCu√°les son los valores tonales b√°sicos de luz a oscuridad?</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(5, 'A')">
                            <div class="test-radio"></div>
                            <span>A) Luz m√°xima, luz, medio tono, sombra, sombra profunda</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(5, 'B')">
                            <div class="test-radio"></div>
                            <span>B) Blanco, gris claro, gris oscuro, negro</span>
                        </div>
                        <div class="test-option" onclick="selectTestOption(5, 'C')">
                            <div class="test-radio"></div>
                            <span>C) Luz, sombra y medio tono solamente</span>
                        </div>
                    </div>

                    <div id="testResult"></div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-nav" id="evaluateTestBtn" onclick="evaluateTest()" disabled>
                            <i class="bi bi-check-circle me-2"></i>Evaluar Test
                        </button>
                    </div>

                    <div class="mt-3 text-center text-muted">
                        <small>Intento ${intentos + 1} de 3</small>
                    </div>
                </div>
            `;
            document.getElementById('mainContent').innerHTML = content;
        }

        function selectTestOption(questionNum, option) {
            const questions = document.querySelectorAll('.test-question');
            const questionDiv = questions[questionNum - 1];
            
            questionDiv.querySelectorAll('.test-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            event.currentTarget.classList.add('selected');
            testAnswers[questionNum] = option;

            const count = Object.keys(testAnswers).length;
            document.getElementById('testCounter').textContent = `Respondidas: ${count}/5`;
            document.getElementById('evaluateTestBtn').disabled = count < 5;
        }

        async function evaluateTest() {
            const correctAnswers = { 1: 'B', 2: 'B', 3: 'A', 4: 'B', 5: 'A' };
            let score = 0;
            
            for (let q = 1; q <= 5; q++) {
                if (testAnswers[q] === correctAnswers[q]) {
                    score++;
                }
            }

            const passed = score >= 4;
            const intentos = (moduleProgress.testDiagnostico?.intentos || 0) + 1;

            const currentUser = getCurrentUser();
            if (currentUser) {
                moduleProgress.testDiagnostico = {
                    aprobado: passed,
                    puntaje: `${score}/5`,
                    intentos: intentos,
                    fecha: new Date().toISOString()
                };

                // Guardar en Sheets
                await updateModuleProgress(3, moduleProgress);
                
                // Registrar actividad de completar el test
                await logUserActivity('test_diagnostico_completado', 3, 0, {
                    aprobado: passed,
                    puntaje: score,
                    totalPreguntas: 5,
                    intento: intentos,
                    fecha: new Date().toISOString()
                });
            }

            let resultHTML = '';
            if (passed) {
                resultHTML = `
                    <div class="test-result success">
                        <h4><i class="bi bi-check-circle-fill me-2"></i>¬°Aprobado!</h4>
                        <p class="mb-2">Obtuviste ${score}/5 respuestas correctas</p>
                        <button class="btn btn-success btn-nav mt-2" onclick="iniciarModulo()">
                            <i class="bi bi-arrow-right-circle me-2"></i>Iniciar M√≥dulo 3
                        </button>
                    </div>
                `;
            } else {
                if (intentos >= 3) {
                    resultHTML = `
                        <div class="test-result failure">
                            <h4><i class="bi bi-x-circle-fill me-2"></i>No Aprobado</h4>
                            <p class="mb-2">Obtuviste ${score}/5 - M√≠nimo requerido: 4/5</p>
                            <p class="mb-0"><strong>Has alcanzado el l√≠mite de 3 intentos.</strong><br>
                            Por favor, revisa los M√≥dulos 1 y 2 antes de continuar.</p>
                            <a href="index.html" class="btn btn-warning btn-nav mt-3">
                                <i class="bi bi-arrow-left-circle me-2"></i>Volver a M√≥dulos
                            </a>
                        </div>
                    `;
                } else {
                    resultHTML = `
                        <div class="test-result failure">
                            <h4><i class="bi bi-x-circle-fill me-2"></i>No Aprobado</h4>
                            <p class="mb-2">Obtuviste ${score}/5 - M√≠nimo requerido: 4/5</p>
                            <p class="mb-2"><strong>Respuestas correctas:</strong></p>
                            <ul class="text-start mb-0" style="list-style-position: inside;">
                                <li>Q1: B - Curva en "C" atravesando el cuerpo</li>
                                <li>Q2: B - Cabeza, torso y pelvis</li>
                                <li>Q3: A - Cadera derecha sube, hombro baja</li>
                                <li>Q4: B - Bloque rectangular + 5 cilindros</li>
                                <li>Q5: A - 5 valores tonales</li>
                            </ul>
                            <button class="btn btn-warning btn-nav mt-3" onclick="mostrarTestDiagnostico()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Reintentar (${intentos}/3)
                            </button>
                        </div>
                    `;
                }
            }

            document.getElementById('testResult').innerHTML = resultHTML;
            document.getElementById('evaluateTestBtn').style.display = 'none';
        }

        // ===== INICIAR M√ìDULO =====
        function iniciarModulo() {
            loadLesson(1);
        }

        // ===== CARGAR LECCIONES =====
        function loadLesson(lessonNum) {
            currentLesson = lessonNum;
            
            document.querySelectorAll('.lesson-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-lesson') == lessonNum) {
                    link.classList.add('active');
                }
            });

            const lessons = {
                1: getLessonContent1(),
                2: getLessonContent2(),
                3: getLessonContent3()
            };
            
            document.getElementById('mainContent').innerHTML = lessons[lessonNum] || '';
            window.scrollTo(0, 0);
            logUserActivity('lesson_view', 3, lessonNum);
        }

        // ===== LECCI√ìN 3.1: S√çNTESIS POR CAPAS =====
        function getLessonContent1() {
            return `
                <div class="lesson-header" style="border-bottom: 3px solid var(--primary-light); padding-bottom: 1.5rem; margin-bottom: 2rem;">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1 mb-2 mb-md-0">
                            <h2 style="color: var(--primary-dark); font-weight: 700; font-size: 2rem;">Lecci√≥n 3.1: S√≠ntesis por Capas</h2>
                            <p style="color: #666; font-size: 1.2rem; margin: 0;">Integraci√≥n de Gesto y Anatom√≠a</p>
                        </div>
                        <span class="badge bg-primary" style="padding: 0.75rem 1.25rem; font-size: 1rem;">60 minutos</span>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(44,95,102,0.05), rgba(232,162,184,0.05)); border-left: 4px solid var(--primary-dark); padding: 1.5rem; border-radius: 8px; margin-top: 1.5rem;">
                        <h6 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 1rem;">
                            <i class="bi bi-bullseye me-2"></i>Objetivos de Aprendizaje
                        </h6>
                        <ul style="margin-bottom: 0;">
                            <li style="margin-bottom: 0.75rem;"><strong>OA 3.1 (COMPRENDER):</strong> Explicar el proceso de construcci√≥n por capas + aprobar evaluaci√≥n (2/3)</li>
                            <li><strong>OA 3.2 (APLICAR):</strong> Usar proceso en 2 figuras de 60-90 min + documentar 4 fotos cada una</li>
                        </ul>
                    </div>
                </div>

                <div class="alert alert-info" style="border-left: 4px solid var(--info); background: #d1ecf1; padding: 1.25rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h5 style="color: var(--info); font-weight: 700;"><i class="bi bi-lightbulb me-2"></i>Concepto Central</h5>
                    <p style="margin: 0;">Integrar√°s <strong>gesto (M√≥dulo 1)</strong> y <strong>anatom√≠a (M√≥dulo 2)</strong> en una figura completa. El proceso por capas garantiza que nunca pierdas la energ√≠a inicial del movimiento.</p>
                </div>

                <div class="accordion mt-4" id="accordionLesson1">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseL1_1" style="background: #f8f9fa; color: var(--dark); font-weight: 600;">
                                <i class="bi bi-layers me-2"></i>Las 4 Capas del Proceso
                            </button>
                        </h2>
                        <div id="collapseL1_1" class="accordion-collapse collapse show" data-bs-parent="#accordionLesson1">
                            <div class="accordion-body">
                                <h6 style="color: var(--primary-dark); font-weight: 700; margin-top: 1rem;">CAPA 1 - GESTO (0-10 min):</h6>
                                <ol>
                                    <li>L√≠nea de acci√≥n visible y clara</li>
                                    <li>Punto de apoyo marcado</li>
                                    <li>Las 3 masas b√°sicas (cabeza, torso, pelvis)</li>
                                    <li>Ejes de hombros y caderas</li>
                                    <li>Extremidades direccionales (l√≠neas simples)</li>
                                </ol>
                                
                                <div class="alert alert-warning" style="background: #fff3cd; border-left: 4px solid var(--warning); padding: 1rem; border-radius: 8px;">
                                    <strong>NO incluir:</strong> Detalles musculares, rasgos faciales, dedos individuales
                                </div>

                                <h6 style="color: var(--primary-dark); font-weight: 700; margin-top: 1.5rem;">CAPA 2 - ESTRUCTURA (10-30 min):</h6>
                                <ol>
                                    <li>Refinar las 3 masas como formas tridimensionales</li>
                                    <li>Marcar articulaciones principales (hombros, codos, mu√±ecas, caderas, rodillas, tobillos)</li>
                                    <li>Identificar 6 grupos musculares esenciales</li>
                                    <li>Verificar proporciones con medici√≥n visual</li>
                                    <li>Manos y pies simplificados (bloques b√°sicos)</li>
                                </ol>

                                <h6 style="color: var(--primary-dark); font-weight: 700; margin-top: 1.5rem;">CAPA 3 - ANATOM√çA (30-60 min):</h6>
                                <ol>
                                    <li>Contorno continuo y limpio</li>
                                    <li>Detalles anat√≥micos (m√∫sculos visibles)</li>
                                    <li>Rasgos faciales b√°sicos</li>
                                    <li>Manos y pies con estructura completa</li>
                                    <li>Refinar proporciones finales</li>
                                </ol>

                                <h6 style="color: var(--primary-dark); font-weight: 700; margin-top: 1.5rem;">CAPA 4 - REFINAMIENTO (60-90 min):</h6>
                                <ol>
                                    <li>L√≠nea de peso variable (gruesa/fina)</li>
                                    <li>Borrar l√≠neas constructivas</li>
                                    <li>Detalles finales</li>
                                    <li>Verificaci√≥n final de proporciones</li>
                                </ol>

                                <div class="alert alert-danger" style="background: #f8d7da; border-left: 4px solid var(--danger); padding: 1rem; border-radius: 8px; margin-top: 1.5rem;">
                                    <strong>‚ö†Ô∏è NUNCA saltes capas.</strong> El gesto es el alma de la figura, la anatom√≠a es solo el traje. Sin alma, el traje est√° vac√≠o.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, rgba(44,95,102,0.05), rgba(232,162,184,0.05)); border: 2px solid var(--primary-light); border-radius: 12px; padding: 2rem; margin: 2rem 0;">
                    <h5 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 1rem;">
                        <i class="bi bi-pencil me-2"></i>EJERCICIO: 2 Figuras Completas por Capas
                    </h5>
                    <p><strong>Objetivo:</strong> Aplicar el proceso de 4 capas en dos figuras diferentes</p>
                    
                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <h6 style="font-weight: 600;">Materiales:</h6>
                            <ul>
                                <li>2 hojas tama√±o carta</li>
                                <li>L√°pices: HB, 2B, 4B</li>
                                <li>Goma de borrar</li>
                                <li>C√°mara/celular para documentar</li>
                            </ul>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 style="font-weight: 600;">Referencias sugeridas:</h6>
                            <ul>
                                <li>line-of-action.com (poses de 30 min)</li>
                                <li>Fotograf√≠as de atletas</li>
                                <li>Bailarines en movimiento</li>
                            </ul>
                        </div>
                    </div>

                    <div class="alert alert-info" style="background: #d1ecf1; border-left: 4px solid var(--info); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <p style="margin-bottom: 0.5rem;"><strong>üì∏ DOCUMENTACI√ìN REQUERIDA:</strong></p>
                        <p style="margin: 0;">Toma 1 foto despu√©s de completar cada capa (4 fotos por figura = 8 fotos totales)</p>
                    </div>
                </div>

                ${getEvaluation1()}
            `;
        }

        // ===== LECCI√ìN 3.2: LUZ Y SOMBRA =====
        function getLessonContent2() {
            return `
                <div class="lesson-header" style="border-bottom: 3px solid var(--primary-light); padding-bottom: 1.5rem; margin-bottom: 2rem;">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1 mb-2 mb-md-0">
                            <h2 style="color: var(--primary-dark); font-weight: 700; font-size: 2rem;">Lecci√≥n 3.2: Luz, Sombra y Volumen</h2>
                            <p style="color: #666; font-size: 1.2rem; margin: 0;">Aplicaci√≥n de Valores Tonales</p>
                        </div>
                        <span class="badge bg-warning text-dark" style="padding: 0.75rem 1.25rem; font-size: 1rem;">90 minutos</span>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(44,95,102,0.05), rgba(232,162,184,0.05)); border-left: 4px solid var(--primary-dark); padding: 1.5rem; border-radius: 8px; margin-top: 1.5rem;">
                        <h6 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 1rem;">
                            <i class="bi bi-bullseye me-2"></i>Objetivos de Aprendizaje
                        </h6>
                        <ul style="margin-bottom: 0;">
                            <li style="margin-bottom: 0.75rem;"><strong>OA 3.3 (COMPRENDER):</strong> Explicar los 5 valores tonales y su funci√≥n + aprobar evaluaci√≥n (2/3)</li>
                            <li><strong>OA 3.4 (APLICAR):</strong> Desarrollar 1 figura de 90 min con 5 valores + fuente de luz coherente</li>
                        </ul>
                    </div>
                </div>

                <div class="alert alert-info" style="border-left: 4px solid var(--info); background: #d1ecf1; padding: 1.25rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h5 style="color: var(--info); font-weight: 700;"><i class="bi bi-sun me-2"></i>Concepto Central</h5>
                    <p style="margin: 0;">Los valores tonales transforman un dibujo plano en una forma tridimensional. La fuente de luz determina d√≥nde aplicar cada uno de los 5 valores.</p>
                </div>

                <div class="accordion mt-4" id="accordionLesson2">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseL2_1" style="background: #f8f9fa; color: var(--dark); font-weight: 600;">
                                <i class="bi bi-palette me-2"></i>Los 5 Valores Tonales
                            </button>
                        </h2>
                        <div id="collapseL2_1" class="accordion-collapse collapse show" data-bs-parent="#accordionLesson2">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 style="color: var(--primary-dark); font-weight: 700;">1. LUZ M√ÅXIMA</h6>
                                                <ul style="font-size: 0.9rem;">
                                                    <li>Blanco del papel</li>
                                                    <li>Recibe luz directa</li>
                                                    <li>Punto m√°s brillante</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 style="color: var(--primary-dark); font-weight: 700;">2. LUZ</h6>
                                                <ul style="font-size: 0.9rem;">
                                                    <li>Gris muy claro</li>
                                                    <li>Iluminado pero no directo</li>
                                                    <li>Transici√≥n suave</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 style="color: var(--primary-dark); font-weight: 700;">3. MEDIO TONO</h6>
                                                <ul style="font-size: 0.9rem;">
                                                    <li>Gris medio</li>
                                                    <li>Transici√≥n luz-sombra</li>
                                                    <li>Mayor √°rea del cuerpo</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 style="color: var(--primary-dark); font-weight: 700;">4. SOMBRA</h6>
                                                <ul style="font-size: 0.9rem;">
                                                    <li>Gris oscuro</li>
                                                    <li>No recibe luz directa</li>
                                                    <li>Opuesta a fuente</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 style="color: var(--primary-dark); font-weight: 700;">5. SOMBRA PROFUNDA</h6>
                                                <ul style="font-size: 0.9rem; margin-bottom: 0;">
                                                    <li>Negro intenso</li>
                                                    <li>Pliegues y cavidades</li>
                                                    <li>Sombra proyectada</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-success" style="background: #d4edda; border-left: 4px solid var(--success); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <strong>Regla clave:</strong> Imagina el cuerpo como esferas y cilindros. La luz los envuelve gradualmente.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseL2_2" style="background: #f8f9fa; color: var(--dark); font-weight: 600;">
                                <i class="bi bi-lightbulb me-2"></i>Fuente de Luz
                            </button>
                        </h2>
                        <div id="collapseL2_2" class="accordion-collapse collapse" data-bs-parent="#accordionLesson2">
                            <div class="accordion-body">
                                <p>La direcci√≥n de la luz determina d√≥nde aplicar cada valor:</p>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 style="color: var(--primary-dark); font-weight: 700;">LUZ FRONTAL:</h6>
                                                <ul style="font-size: 0.9rem; margin-bottom: 0;">
                                                    <li>Desde el observador</li>
                                                    <li>Poco contraste</li>
                                                    <li>Menos volumen aparente</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 style="color: var(--primary-dark); font-weight: 700;">LUZ LATERAL:</h6>
                                                <ul style="font-size: 0.9rem; margin-bottom: 0;">
                                                    <li>Desde un lado</li>
                                                    <li>M√°ximo contraste</li>
                                                    <li>Mejor para volumen</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-warning" style="background: #fff3cd; border-left: 4px solid var(--warning); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                    <strong>Importante:</strong> Elige UNA fuente de luz y mant√©n consistencia en toda la figura.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, rgba(44,95,102,0.05), rgba(232,162,184,0.05)); border: 2px solid var(--primary-light); border-radius: 12px; padding: 2rem; margin: 2rem 0;">
                    <h5 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 1rem;">
                        <i class="bi bi-palette me-2"></i>EJERCICIO: 1 Figura con Valores Tonales
                    </h5>
                    <p><strong>Objetivo:</strong> Aplicar los 5 valores tonales con fuente de luz coherente</p>
                    
                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <h6 style="font-weight: 600;">Materiales:</h6>
                            <ul>
                                <li>1 hoja tama√±o carta</li>
                                <li>L√°pices: HB, 2B, 4B, 6B</li>
                                <li>Goma y difumino</li>
                            </ul>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 style="font-weight: 600;">Proceso (90 min):</h6>
                            <ol>
                                <li>0-30 min: Capas 1 y 2 (gesto + estructura)</li>
                                <li>30-40 min: Dividir zonas luz/sombra</li>
                                <li>40-90 min: Aplicar 5 valores progresivamente</li>
                            </ol>
                        </div>
                    </div>

                    <div class="alert alert-danger" style="background: #f8d7da; border-left: 4px solid var(--danger); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <strong>‚ö†Ô∏è SIEMPRE estructura PRIMERO, valores DESPU√âS.</strong> Nunca comiences con sombras sin tener la forma correcta.
                    </div>
                </div>

                ${getEvaluation2()}
            `;
        }

        // ===== LECCI√ìN 3.3: PROYECTO FINAL =====
        function getLessonContent3() {
            return `
                <div class="lesson-header" style="border-bottom: 3px solid var(--primary-light); padding-bottom: 1.5rem; margin-bottom: 2rem;">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1 mb-2 mb-md-0">
                            <h2 style="color: var(--primary-dark); font-weight: 700; font-size: 2rem;">Lecci√≥n 3.3: Proyecto Final</h2>
                            <p style="color: #666; font-size: 1.2rem; margin: 0;">Dibujo Completo - Integraci√≥n Total</p>
                        </div>
                        <span class="badge bg-danger text-white" style="padding: 0.75rem 1.25rem; font-size: 1rem;">2-3 horas</span>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(44,95,102,0.05), rgba(232,162,184,0.05)); border-left: 4px solid var(--primary-dark); padding: 1.5rem; border-radius: 8px; margin-top: 1.5rem;">
                        <h6 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 1rem;">
                            <i class="bi bi-bullseye me-2"></i>Objetivos de Aprendizaje
                        </h6>
                        <ul style="margin-bottom: 0;">
                            <li style="margin-bottom: 0.75rem;"><strong>OA 3.5 (EVALUAR):</strong> Autoevaluar con r√∫brica identificando puntaje en 6 criterios</li>
                            <li><strong>OA 3.6 (CREAR):</strong> Producir proyecto final 1/4 mercurio ‚â•60/100 pts seg√∫n r√∫brica</li>
                        </ul>
                    </div>
                </div>

                <div class="alert alert-info" style="border-left: 4px solid var(--info); background: #d1ecf1; padding: 1.25rem; border-radius: 8px; margin-bottom: 2rem;">
                    <h5 style="color: var(--info); font-weight: 700;"><i class="bi bi-trophy me-2"></i>Tu Proyecto Final</h5>
                    <p style="margin: 0;">Este es tu proyecto final. Aplica todo lo aprendido en los 3 m√≥dulos: gesto, anatom√≠a y valores tonales. Demuestra tu dominio t√©cnico en una sola pieza.</p>
                </div>

                <div class="card border-primary mt-4">
                    <div class="card-header bg-primary text-white" style="font-weight: 600;">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Requisitos del Proyecto</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6 style="color: var(--primary-dark); font-weight: 700;">Formato y Materiales:</h6>
                                <ul>
                                    <li><strong>Formato:</strong> 1/4 mercurio (27.5 √ó 37.5 cm)</li>
                                    <li><strong>L√°pices:</strong> HB, 2B, 4B, 6B</li>
                                    <li><strong>Papel:</strong> Blanco, liso o texturado</li>
                                    <li><strong>Herramientas:</strong> Goma, difumino opcional</li>
                                </ul>
                            </div>
                            <div class="col-md-6 mb-3">
                                <h6 style="color: var(--primary-dark); font-weight: 700;">Requisitos T√©cnicos:</h6>
                                <ul>
                                    <li>‚úì L√≠nea de acci√≥n visible</li>
                                    <li>‚úì Proporciones ‚â•70% precisas</li>
                                    <li>‚úì 3 masas diferenciadas + grupos musculares</li>
                                    <li>‚úì Manos y pies estructurados</li>
                                    <li>‚úì M√≠nimo 3 valores tonales</li>
                                    <li>‚úì Composici√≥n balanceada</li>
                                </ul>
                            </div>
                        </div>

                        <div class="alert alert-warning" style="background: #fff3cd; border-left: 4px solid var(--warning); padding: 1rem; border-radius: 8px; margin-top: 1rem; margin-bottom: 0;">
                            <strong>Puntaje m√≠nimo:</strong> 60/100 puntos para aprobar. Usa el bot√≥n flotante de r√∫brica para ver los criterios completos.
                        </div>
                    </div>
                </div>

                ${getEvaluation3()}

                <div id="congratsMessage" style="display: none;">
                    <div class="alert alert-success" style="background: #d4edda; border-left: 4px solid var(--success); padding: 1.5rem; border-radius: 8px; margin-top: 2rem;">
                        <h4 style="color: var(--success); font-weight: 700;"><i class="bi bi-trophy-fill me-2"></i>¬°Felicitaciones!</h4>
                        <p style="margin-bottom: 0.5rem;">Has completado exitosamente el curso DIADIFO.</p>
                        <p style="margin: 0;">Has creado 24 dibujos y dominado la representaci√≥n del cuerpo humano. Est√°s listo para ense√±ar esto a tus futuros estudiantes.</p>
                    </div>
                </div>
            `;
        }

        // ===== EVALUACIONES FORMATIVAS =====
        function getEvaluation1() {
            return `
                <div style="background: #f8f9fa; border-radius: 12px; padding: 2rem; margin-top: 2rem;">
                    <h5 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 1rem;">
                        <i class="bi bi-clipboard-check me-2"></i>Evaluaci√≥n Formativa 3.1
                    </h5>
                    <p style="margin-bottom: 1.5rem;">Responde las siguientes preguntas. Necesitas 2/3 correctas para aprobar.</p>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">1. ¬øCu√°l es el orden correcto del proceso por capas?</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'A', 1)">
                            <div class="eval-radio"></div>
                            <span>A) Anatom√≠a ‚Üí Gesto ‚Üí Estructura ‚Üí Refinamiento</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'B', 1)">
                            <div class="eval-radio"></div>
                            <span>B) Gesto ‚Üí Estructura ‚Üí Anatom√≠a ‚Üí Refinamiento</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'C', 1)">
                            <div class="eval-radio"></div>
                            <span>C) Estructura ‚Üí Anatom√≠a ‚Üí Gesto ‚Üí Refinamiento</span>
                        </div>
                    </div>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">2. ¬øPor qu√© NO debes saltar capas en el proceso?</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'A', 1)">
                            <div class="eval-radio"></div>
                            <span>A) Porque pierdes tiempo</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'B', 1)">
                            <div class="eval-radio"></div>
                            <span>B) Porque el gesto es el alma y debe ir primero</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'C', 1)">
                            <div class="eval-radio"></div>
                            <span>C) Porque es una regla arbitraria</span>
                        </div>
                    </div>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">3. ¬øCu√°ntas fotograf√≠as debes documentar por figura?</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'A', 1)">
                            <div class="eval-radio"></div>
                            <span>A) 2 fotos (inicio y fin)</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'B', 1)">
                            <div class="eval-radio"></div>
                            <span>B) 4 fotos (una por cada capa)</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'C', 1)">
                            <div class="eval-radio"></div>
                            <span>C) Solo la versi√≥n final</span>
                        </div>
                    </div>

                    <div id="evalResult1" style="margin-top: 1.5rem;"></div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-nav" id="submitEval1" onclick="submitEvaluation(1)">
                            <i class="bi bi-check-circle me-2"></i>Enviar Evaluaci√≥n
                        </button>
                    </div>
                </div>
            `;
        }

        function getEvaluation2() {
            return `
                <div style="background: #f8f9fa; border-radius: 12px; padding: 2rem; margin-top: 2rem;">
                    <h5 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 1rem;">
                        <i class="bi bi-clipboard-check me-2"></i>Evaluaci√≥n Formativa 3.2
                    </h5>
                    <p style="margin-bottom: 1.5rem;">Responde las siguientes preguntas. Necesitas 2/3 correctas para aprobar.</p>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">1. ¬øCu√°ntos valores tonales b√°sicos existen?</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'A', 2)">
                            <div class="eval-radio"></div>
                            <span>A) 3 (luz, medio, sombra)</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'B', 2)">
                            <div class="eval-radio"></div>
                            <span>B) 5 (luz m√°xima, luz, medio, sombra, profunda)</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'C', 2)">
                            <div class="eval-radio"></div>
                            <span>C) 7 (escala completa)</span>
                        </div>
                    </div>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">2. La fuente de luz determina:</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'A', 2)">
                            <div class="eval-radio"></div>
                            <span>A) Solo d√≥nde va la sombra</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'B', 2)">
                            <div class="eval-radio"></div>
                            <span>B) D√≥nde aplicar cada uno de los 5 valores</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'C', 2)">
                            <div class="eval-radio"></div>
                            <span>C) El color del dibujo</span>
                        </div>
                    </div>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">3. El medio tono es:</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'A', 2)">
                            <div class="eval-radio"></div>
                            <span>A) El valor m√°s oscuro</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'B', 2)">
                            <div class="eval-radio"></div>
                            <span>B) La transici√≥n entre luz y sombra</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'C', 2)">
                            <div class="eval-radio"></div>
                            <span>C) El blanco del papel</span>
                        </div>
                    </div>

                    <div id="evalResult2" style="margin-top: 1.5rem;"></div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-nav" id="submitEval2" onclick="submitEvaluation(2)">
                            <i class="bi bi-check-circle me-2"></i>Enviar Evaluaci√≥n
                        </button>
                    </div>
                </div>
            `;
        }

        function getEvaluation3() {
            return `
                <div style="background: #f8f9fa; border-radius: 12px; padding: 2rem; margin-top: 2rem;">
                    <h5 style="color: var(--primary-dark); font-weight: 700; margin-bottom: 1rem;">
                        <i class="bi bi-clipboard-check me-2"></i>Evaluaci√≥n Formativa 3.3
                    </h5>
                    <p style="margin-bottom: 1.5rem;">Responde las siguientes preguntas. Necesitas 2/3 correctas para aprobar.</p>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">1. El formato del proyecto final es:</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'A', 3)">
                            <div class="eval-radio"></div>
                            <span>A) Hoja carta</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'B', 3)">
                            <div class="eval-radio"></div>
                            <span>B) 1/4 mercurio (27.5 √ó 37.5 cm)</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 1, 'C', 3)">
                            <div class="eval-radio"></div>
                            <span>C) Tama√±o libre</span>
                        </div>
                    </div>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">2. ¬øCu√°l es el puntaje m√≠nimo para aprobar?</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'A', 3)">
                            <div class="eval-radio"></div>
                            <span>A) 50/100 puntos</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'B', 3)">
                            <div class="eval-radio"></div>
                            <span>B) 60/100 puntos</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 2, 'C', 3)">
                            <div class="eval-radio"></div>
                            <span>C) 70/100 puntos</span>
                        </div>
                    </div>

                    <div style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h6 style="font-weight: 600; margin-bottom: 1rem;">3. Si repruebas el proyecto (&lt;60pts), debes:</h6>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'A', 3)">
                            <div class="eval-radio"></div>
                            <span>A) Abandonar el curso</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'B', 3)">
                            <div class="eval-radio"></div>
                            <span>B) Crear un NUEVO proyecto completo</span>
                        </div>
                        <div class="eval-option" onclick="selectEvalOption(this, 3, 'C', 3)">
                            <div class="eval-radio"></div>
                            <span>C) Solo corregir detalles</span>
                        </div>
                    </div>

                    <div id="evalResult3" style="margin-top: 1.5rem;"></div>

                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-nav" id="submitEval3" onclick="submitEvaluation(3)">
                            <i class="bi bi-check-circle me-2"></i>Enviar Evaluaci√≥n
                        </button>
                    </div>
                </div>
            `;
        }

        // ===== L√ìGICA DE EVALUACIONES =====
        const evalCorrectAnswers = {
            1: { 1: 'B', 2: 'B', 3: 'B' },
            2: { 1: 'B', 2: 'B', 3: 'B' },
            3: { 1: 'B', 2: 'B', 3: 'B' }
        };

        let currentEvalAnswers = {};

        function selectEvalOption(element, questionNum, option, lessonNum) {
            const parent = element.closest('div[style*="background: white"]');
            parent.querySelectorAll('.eval-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            element.classList.add('selected');
            
            if (!currentEvalAnswers[lessonNum]) {
                currentEvalAnswers[lessonNum] = {};
            }
            currentEvalAnswers[lessonNum][questionNum] = option;
        }

        async function submitEvaluation(lessonNum) {
            const answers = currentEvalAnswers[lessonNum] || {};
            const correctAnswers = evalCorrectAnswers[lessonNum];

            if (Object.keys(answers).length < 3) {
                alert('Por favor responde todas las preguntas antes de enviar.');
                return;
            }

            let score = 0;
            for (let q = 1; q <= 3; q++) {
                if (answers[q] === correctAnswers[q]) {
                    score++;
                }
            }

            const passed = score >= 2;
            const resultDiv = document.getElementById(`evalResult${lessonNum}`);

            if (passed) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success" style="background: #d4edda; border-left: 4px solid var(--success); padding: 1.25rem; border-radius: 8px;">
                        <h5 style="color: var(--success); font-weight: 700;"><i class="bi bi-check-circle-fill me-2"></i>¬°Aprobaste!</h5>
                        <p style="margin: 0;">${score}/3 respuestas correctas</p>
                    </div>
                `;

                if (!moduleProgress.completedLessons.includes(lessonNum)) {
                    moduleProgress.completedLessons.push(lessonNum);
                }

                moduleProgress.evaluations[`lesson${lessonNum}`] = {
                    score: score,
                    passed: true,
                    date: new Date().toISOString()
                };

                await updateModuleProgress(3, moduleProgress);
                await logUserActivity('evaluation_submitted', 3, lessonNum, { score, passed });
                
                updateProgressBar();

                setTimeout(() => {
                    if (lessonNum < 3) {
                        loadLesson(lessonNum + 1);
                    } else {
                        document.getElementById('congratsMessage').style.display = 'block';
                        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                    }
                }, 3000);

            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger" style="background: #f8d7da; border-left: 4px solid var(--danger); padding: 1.25rem; border-radius: 8px;">
                        <h5 style="color: var(--danger); font-weight: 700;"><i class="bi bi-x-circle-fill me-2"></i>No Aprobado</h5>
                        <p style="margin-bottom: 0.5rem;">${score}/3 correctas - M√≠nimo requerido: 2/3</p>
                        <p style="margin: 0;"><strong>Respuestas correctas:</strong> Todas las opciones B son correctas en esta evaluaci√≥n.</p>
                    </div>
                `;
            }

            document.getElementById(`submitEval${lessonNum}`).style.display = 'none';
        }
        function updateProgressBar() {
            const completed = moduleProgress.completedLessons.length;
            const percentage = (completed / 3) * 100;
            
            const progressBar = document.getElementById('progressBar');
            const progressDetail = document.getElementById('progressDetail');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                progressBar.textContent = Math.round(percentage) + '%';
            }
            
            if (progressDetail) {
                progressDetail.textContent = `${completed} de 3 lecciones completadas`;
            }
        }

        // ===== MENTOR CHAT =====
        const mentorFloatBtn = document.getElementById('mentorFloatBtn');
        const mentorCloseBtn = document.getElementById('mentorCloseBtn');
        const mentorChatContainer = document.getElementById('mentorChatContainer');
        const mentorMessages = document.getElementById('mentorMessages');
        const mentorInput = document.getElementById('mentorInput');
        const mentorSendBtn = document.getElementById('mentorSendBtn');

        mentorFloatBtn.addEventListener('click', function() {
            mentorChatContainer.classList.add('show');
            mentorFloatBtn.style.display = 'none';
            
            if (mentorMessages.children.length === 0) {
                addMentorMessage(
                    "¬°Hola! üëã Soy tu Mentor Anat√≥mico.\n\n**¬øEn qu√© puedo ayudarte?**\n\nüíô **Emocional:** Frustraci√≥n, bloqueo, ansiedad\nüé® **T√©cnico:** L√≠nea de acci√≥n, proporciones, valores\nüìö **Sistema:** Ver glosario, progreso del curso",
                    ['Ver Glosario', 'Duda t√©cnica', 'Apoyo emocional']
                );
            }
            
            mentorInput.focus();
        });

        mentorCloseBtn.addEventListener('click', function() {
            mentorChatContainer.classList.remove('show');
            mentorFloatBtn.style.display = 'flex';
        });

        mentorSendBtn.addEventListener('click', sendMessage);
        mentorInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        mentorInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });

        function sendMessage() {
            const message = mentorInput.value.trim();
            if (!message) return;

            addUserMessage(message);
            mentorInput.value = '';
            mentorInput.style.height = 'auto';

            setTimeout(() => {
                const response = getMentorResponse(message);
                addMentorMessage(response);
            }, 500);
        }

        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `<div class="message-bubble">${text}</div>`;
            mentorMessages.appendChild(messageDiv);
            mentorMessages.scrollTop = mentorMessages.scrollHeight;
        }

        function addMentorMessage(text, actions = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message mentor';
            
            let actionsHTML = '';
            if (actions.length > 0) {
                actionsHTML = '<div style="margin-top: 0.75rem;">';
                actions.forEach(action => {
                    actionsHTML += `<button class="action-button" onclick="handleMentorAction('${action}')">${action}</button>`;
                });
                actionsHTML += '</div>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${text.replace(/\n/g, '<br>')}
                    ${actionsHTML}
                </div>
            `;
            mentorMessages.appendChild(messageDiv);
            mentorMessages.scrollTop = mentorMessages.scrollHeight;
        }

        function getMentorResponse(message) {
            const msg = message.toLowerCase();
            
            if (msg.includes('gesto') || msg.includes('linea') || msg.includes('l√≠nea')) {
                return 'La **l√≠nea de acci√≥n** es el alma de tu dibujo. Debe capturar la energ√≠a y direcci√≥n del movimiento. ¬°Nunca la pierdas en el proceso!';
            }
            if (msg.includes('masa') || msg.includes('anatomia') || msg.includes('anatom√≠a')) {
                return 'Las **3 masas corporales** (cabeza, torso, pelvis) son la base de cualquier figura. Piensa en ellas como formas tridimensionales que se conectan.';
            }
            if (msg.includes('valor') || msg.includes('sombra') || msg.includes('luz')) {
                return 'Los **5 valores tonales** transforman tu dibujo plano en volumen:\n\n1. Luz m√°xima\n2. Luz\n3. Medio tono\n4. Sombra\n5. Sombra profunda\n\nRecuerda: estructura PRIMERO, valores DESPU√âS.';
            }
            if (msg.includes('proporc') || msg.includes('medic')) {
                return 'Las **proporciones correctas** son esenciales. Usa tu l√°piz como regla y verifica constantemente durante todo el proceso. El cuerpo humano adulto mide 7.5-8 cabezas de altura.';
            }
            if (msg.includes('capa')) {
                return 'El **proceso por capas** garantiza construcci√≥n correcta:\n\n1. Gesto\n2. Estructura\n3. Anatom√≠a\n4. Refinamiento\n\n¬°Nunca saltes pasos!';
            }
            if (msg.includes('glosario')) {
                return 'El glosario completo con 26 t√©rminos est√° disponible. Incluye conceptos de los 3 m√≥dulos con sus referencias bibliogr√°ficas en formato APA.';
            }
            if (msg.includes('frustrad') || msg.includes('dificil') || msg.includes('dif√≠cil')) {
                return 'üíô Es completamente normal sentir frustraci√≥n al aprender a dibujar. **Cada artista ha pasado por esto.**\n\nTe sugiero:\n‚úì Tomar un descanso de 10 minutos\n‚úì Revisar los m√≥dulos anteriores\n‚úì Recordar que el progreso no es lineal\n\n¬øQu√© aspecto espec√≠fico te est√° costando m√°s?';
            }
            
            return 'Interesante pregunta sobre el M√≥dulo 3. ¬øPodr√≠as ser m√°s espec√≠fico? Puedo ayudarte con:\n\n‚Ä¢ Proceso por capas\n‚Ä¢ Valores tonales\n‚Ä¢ Proyecto final\n‚Ä¢ Conceptos t√©cnicos';
        }

        function handleMentorAction(action) {
            if (action === 'Ver Glosario') {
                addUserMessage('Quiero ver el glosario');
                addMentorMessage('El **glosario completo** incluye:\n\nüìê **M√≥dulo 1:** 8 t√©rminos (gesto, l√≠nea de acci√≥n, contrapposto...)\nü¶¥ **M√≥dulo 2:** 12 t√©rminos (3 masas, anatom√≠a funcional...)\nüé® **M√≥dulo 3:** 6 t√©rminos (valores tonales, s√≠ntesis...)\n\nTodos con referencias APA. ¬øSobre qu√© m√≥dulo quieres saber m√°s?');
            } else if (action === 'Duda t√©cnica') {
                addUserMessage('Tengo una duda t√©cnica');
                addMentorMessage('Perfecto, estoy aqu√≠ para ayudarte. ¬øSobre qu√© tema espec√≠fico tienes dudas?\n\n‚Ä¢ L√≠nea de acci√≥n y gesto\n‚Ä¢ 3 masas y anatom√≠a\n‚Ä¢ Valores tonales\n‚Ä¢ Proceso por capas\n‚Ä¢ Proporciones');
            } else if (action === 'Apoyo emocional') {
                addUserMessage('Necesito apoyo emocional');
                addMentorMessage('üíô Estoy aqu√≠ para apoyarte. Dibujar puede ser desafiante emocionalmente.\n\n**¬øC√≥mo te sientes?**\n\n¬øFrustrado con tu progreso? ¬øBloqueado creativamente? ¬øAnsioso por los resultados?\n\nCu√©ntame m√°s y te ayudar√©.');
            }
        }

        // ===== INIT =====
        window.addEventListener('DOMContentLoaded', initializeModule);
    </script>
</body>
</html>
