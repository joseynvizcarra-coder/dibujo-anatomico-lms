<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Módulo 1: Observación y Gesto - Método Leonardo da Vinci">
    <title>Módulo 1: Ver para Dibujar - LMS UAH</title>
    
    <!-- Bootstrap 5.3.2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary-dark: #2c5f66;
            --primary-light: #e8a2b8;
            --dark: #1a1a1a;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #f44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }

        .header-uah {
            background: linear-gradient(135deg, var(--primary-dark), var(--dark));
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1030;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .back-btn {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }

        .back-btn:hover {
            opacity: 0.8;
            color: white;
        }

        .sidebar-lesson {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            position: sticky;
            top: 90px;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .lesson-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 0.5rem;
            border: 2px solid transparent;
        }

        .lesson-link:hover {
            background: #f8f9fa;
        }

        .lesson-link.active {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: white;
            border-color: var(--primary-dark);
        }

        .lesson-number {
            width: 35px;
            height: 35px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .lesson-link.active .lesson-number {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .lesson-link.completed .lesson-number {
            background: var(--success);
            color: white;
        }

        .lesson-link.completed::after {
            content: '✓';
            margin-left: auto;
            font-weight: bold;
        }

        .progress-uah {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-bar-uah {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 1rem;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease;
        }

        .exercise-box {
            background: linear-gradient(135deg, #fff8e1, #fce4ec);
            border-left: 4px solid var(--primary-dark);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .exercise-title {
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .leonardo-quote {
            background: linear-gradient(135deg, #e8f5e9, #e1f5fe);
            border-left: 4px solid var(--success);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
            font-style: italic;
        }

        .observation-box {
            background: linear-gradient(135deg, #fff3e0, #fce4ec);
            border: 2px dashed var(--primary-dark);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .content-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .lesson-content h3 {
            color: var(--primary-dark);
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .lesson-content h4 {
            color: var(--dark);
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
        }

        .lesson-content p {
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .lesson-content ul, .lesson-content ol {
            margin-bottom: 1.5rem;
        }

        .lesson-content li {
            margin-bottom: 0.5rem;
        }

        .btn-uah-primary {
            background: var(--primary-dark);
            border: none;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-uah-primary:hover:not(:disabled) {
            background: var(--primary-light);
            color: var(--dark);
            transform: translateY(-2px);
        }

        .btn-uah-primary:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-uah-success {
            background: var(--success);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .btn-uah-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-content {
            animation: fadeIn 0.5s ease;
        }

        @media (max-width: 991px) {
            .sidebar-lesson {
                position: static;
                margin-bottom: 2rem;
            }
        }
    </style>
</head>
<body>
    <script src="auth.js"></script>

    <!-- Header -->
    <header class="header-uah">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-auto">
                    <a href="index.html" class="back-btn d-flex align-items-center gap-2">
                        <i class="bi bi-arrow-left"></i>
                        <span>Volver al Curso</span>
                    </a>
                </div>
                <div class="col text-center">
                    <h1 class="h4 mb-0">Módulo 1: Observación y Gesto</h1>
                    <small class="text-white-50">"Ver para Dibujar, Dibujar para Ver"</small>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark" id="progressText">0% Completado</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <aside class="col-lg-3">
                <div class="sidebar-lesson">
                    <h5 class="mb-3">
                        <i class="bi bi-eye me-2"></i>Lecciones
                    </h5>
                    <div class="lesson-list">
                        <a class="lesson-link active" data-lesson="1" onclick="loadLesson(1)">
                            <span class="lesson-number">1</span>
                            <span class="flex-grow-1">El Acto de Observar</span>
                        </a>
                        <a class="lesson-link" data-lesson="2" onclick="loadLesson(2)">
                            <span class="lesson-number">2</span>
                            <span class="flex-grow-1">La Línea como Movimiento</span>
                        </a>
                        <a class="lesson-link" data-lesson="3" onclick="loadLesson(3)">
                            <span class="lesson-number">3</span>
                            <span class="flex-grow-1">Volumen y Masa</span>
                        </a>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="col-lg-9">
                <div class="content-card">
                    <!-- Progress Bar -->
                    <div class="progress-uah">
                        <div class="progress-bar-uah" id="moduleProgress" style="width: 0%">
                            <span>0%</span>
                        </div>
                    </div>

                    <!-- Content Header -->
                    <div class="border-bottom pb-3 mb-4">
                        <h2 class="lesson-title h3 mb-2" id="lessonTitle">Lección 1: El Acto de Observar</h2>
                        <div class="d-flex gap-3 text-muted small lesson-meta" id="lessonMeta">
                            <span><i class="bi bi-clock me-1"></i>20 minutos</span>
                            <span><i class="bi bi-book me-1"></i>Observación</span>
                            <span><i class="bi bi-bar-chart me-1"></i>Fundamentos</span>
                        </div>
                    </div>

                    <!-- Lesson Content -->
                    <div class="lesson-content" id="lessonContent">
                        <p>Cargando contenido...</p>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between align-items-center pt-4 mt-4 border-top flex-wrap gap-3">
                        <button class="btn btn-uah-primary" id="prevButton" onclick="goToPreviousLesson()">
                            <i class="bi bi-arrow-left me-2"></i>Lección Anterior
                        </button>

                        <button class="btn btn-uah-success" onclick="completeLesson()" id="completeButton">
                            <i class="bi bi-check-circle me-2"></i>Marcar como Completada
                        </button>

                        <button class="btn btn-uah-primary" id="nextButton" onclick="goToNextLesson()">
                            Siguiente Lección<i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2" id="toastIcon"></i>
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Mensaje aquí
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentUser = null;
        let currentLesson = 1;
        let moduleProgress = 0;
        let completedLessons = [];
        let isOnline = navigator.onLine;
        
        window.currentModuleId = 1;

        const lessonsContent = {
            1: {
                title: 'El Acto de Observar',
                meta: '<span><i class="bi bi-clock me-1"></i>20 minutos</span><span><i class="bi bi-book me-1"></i>Observación</span><span><i class="bi bi-bar-chart me-1"></i>Fundamentos</span>',
                content: `
                    <div class="leonardo-quote">
                        <i class="bi bi-quote text-success fs-3"></i>
                        <p class="mb-0 mt-2">"La pintura es cosa mental. El buen pintor ha de pintar dos cosas principales: el hombre y la intención de su alma. Lo primero es fácil, lo segundo difícil, porque se ha de representar con gestos y movimientos de los miembros."</p>
                        <small class="text-muted d-block mt-2">— Leonardo da Vinci, Tratado de la Pintura (c. 1490)</small>
                    </div>

                    <h3>El "Saper Vedere": Aprender a Ver</h3>
                    <p class="lead">El dibujo no comienza en la mano, comienza en el ojo. Leonardo da Vinci llamaba a esto <strong>saper vedere</strong> (saber ver): la capacidad de observar con intención científica y curiosidad artística simultáneas.</p>

                    <p>Cuando dibujamos el cuerpo humano, no estamos copiando fórmulas matemáticas ni aplicando proporciones memorizadas. Estamos <strong>investigando visualmente</strong> la realidad que tenemos frente a nosotros. El dibujo se convierte en el instrumento de esa investigación.</p>

                    <h4>Observación vs. Reconocimiento</h4>
                    <p>Nuestro cerebro está entrenado para <em>reconocer</em> (identificar rápidamente: "eso es una mano"), pero rara vez <em>observa</em> (estudiar cómo esa mano específica se estructura, cómo la luz la define, cómo se relaciona con el brazo).</p>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card border-danger h-100">
                                <div class="card-header bg-danger text-white">
                                    <i class="bi bi-x-circle me-2"></i>Reconocimiento Automático
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>"Eso es una cabeza"</li>
                                        <li>"Sé cómo se ve una mano"</li>
                                        <li>"Los ojos van aquí"</li>
                                        <li>Dibujar desde el concepto mental</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success h-100">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-check-circle me-2"></i>Observación Contemplativa
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>"¿Cómo se construye esta cabeza?"</li>
                                        <li>"¿Qué formas específicas veo?"</li>
                                        <li>"¿Dónde termina esta línea?"</li>
                                        <li>Dibujar desde lo que realmente veo</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="observation-box">
                        <h5 class="text-primary mb-3"><i class="bi bi-lightbulb me-2"></i>Principio Fundamental</h5>
                        <p class="mb-0"><strong>"Dibuja lo que ves, no lo que sabes."</strong></p>
                        <p class="small text-muted mt-2">Tu conocimiento previo de que "una cabeza tiene ojos, nariz y boca" puede sabotear tu capacidad de ver <em>esta</em> cabeza específica frente a ti, con <em>estas</em> características únicas, en <em>esta</em> luz particular.</p>
                    </div>

                    <h3>El Dibujo como Investigación Científica</h3>
                    <p>Para Leonardo, el dibujo era una <strong>herramienta epistémica</strong>: un método de conocimiento. Cuando dibujaba un hombro humano, no memorizaba su forma, sino que <em>descubría</em> su funcionamiento biomecánico mediante la observación directa.</p>

                    <div class="alert alert-info border-0">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Contexto Histórico</h6>
                        <p class="mb-0">Leonardo diseccionó más de 30 cadáveres humanos para comprender la anatomía desde su estructura interna hacia su apariencia externa. Sus cuadernos anatómicos (c. 1510-1511) son simultáneamente ciencia y arte: cada dibujo es una hipótesis visual sobre cómo funciona el cuerpo.</p>
                    </div>

                    <h4>Tres Niveles de Observación</h4>
                    <div class="accordion mb-4" id="observationAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#nivel1">
                                    <strong>Nivel 1: Forma General (El Todo)</strong>
                                </button>
                            </h2>
                            <div id="nivel1" class="accordion-collapse collapse show" data-bs-parent="#observationAccordion">
                                <div class="accordion-body">
                                    <p><strong>Pregunta clave:</strong> ¿Qué forma geométrica simple describe mejor lo que veo?</p>
                                    <p>Antes de dibujar detalles, observa la <em>masa total</em>. Un torso puede verse como un cilindro modificado, una cabeza como una esfera con planos específicos.</p>
                                    <p class="text-muted small mb-0"><em>Tiempo de observación: 30 segundos mínimo antes de dibujar.</em></p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nivel2">
                                    <strong>Nivel 2: Relaciones (Las Conexiones)</strong>
                                </button>
                            </h2>
                            <div id="nivel2" class="accordion-collapse collapse" data-bs-parent="#observationAccordion">
                                <div class="accordion-body">
                                    <p><strong>Pregunta clave:</strong> ¿Cómo se relacionan las partes entre sí?</p>
                                    <p>No dibujes "un brazo", dibuja "cómo este brazo sale de este hombro y cómo se relaciona con este torso". Las conexiones son más importantes que las partes aisladas.</p>
                                    <p class="text-muted small mb-0"><em>Observa ángulos, direcciones, puntos de intersección.</em></p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#nivel3">
                                    <strong>Nivel 3: Carácter (Lo Específico)</strong>
                                </button>
                            </h2>
                            <div id="nivel3" class="accordion-collapse collapse" data-bs-parent="#observationAccordion">
                                <div class="accordion-body">
                                    <p><strong>Pregunta clave:</strong> ¿Qué hace única a esta figura?</p>
                                    <p>Después de capturar forma y relaciones, observa las peculiaridades: tensión en ciertos músculos, peso sobre una pierna, inclinación de la cabeza. Estos detalles transforman un dibujo genérico en uno vivo.</p>
                                    <p class="text-muted small mb-0"><em>Este nivel requiere observación prolongada y curiosa.</em></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="exercise-box">
                        <div class="exercise-title">
                            <i class="bi bi-pencil-square me-2"></i>Ejercicio 1: "Dibuja lo que ves, no lo que sabes"
                        </div>
                        <p><strong>Objetivo:</strong> Desactivar el reconocimiento automático y activar la observación consciente.</p>
                        
                        <h6 class="mt-3">Materiales:</h6>
                        <ul>
                            <li>Papel (mínimo A4)</li>
                            <li>Lápiz o carboncillo</li>
                            <li>Referencia: Tu propia mano (en vivo, no foto)</li>
                            <li>Cronómetro</li>
                        </ul>

                        <h6 class="mt-3">Instrucciones:</h6>
                        <ol>
                            <li><strong>Coloca tu mano</strong> en una posición cómoda sobre una mesa, con luz lateral clara.</li>
                            <li><strong>Observa durante 2 minutos</strong> sin dibujar nada. Solo mira:
                                <ul>
                                    <li>¿Qué forma general tiene?</li>
                                    <li>¿Dónde están las sombras más oscuras?</li>
                                    <li>¿Cómo se conectan los dedos con la palma?</li>
                                    <li>¿Qué ves que nunca habías notado antes?</li>
                                </ul>
                            </li>
                            <li><strong>Dibuja durante 10 minutos</strong> mirando el 90% del tiempo tu mano, solo el 10% tu papel.</li>
                            <li><strong>No corrijas ni borres</strong>. Deja que el dibujo sea imperfecto.</li>
                        </ol>

                        <div class="alert alert-warning border-0 mt-3">
                            <p class="mb-0"><strong>Regla crítica:</strong> Si encuentras tu mente diciendo "sé cómo es una mano", detente. Respira. Pregúntate: "¿Cómo es <em>esta</em> mano específica que tengo delante?"</p>
                        </div>

                        <h6 class="mt-3">Entregable:</h6>
                        <ul>
                            <li>1 dibujo de tu mano (10 minutos)</li>
                            <li>Reflexión escrita (100 palabras): "¿Qué vi que nunca había notado antes?"</li>
                        </ul>
                    </div>

                    <h3>Reflexión Final</h3>
                    <p>La observación contemplativa es una <strong>habilidad entrenable</strong>, no un talento innato. Investigaciones en neurociencia (Chamberlain et al., 2014) confirman que "aprender a ver" produce cambios medibles en el cerebro: las áreas visuales se vuelven más sensibles a detalles específicos.</p>

                    <p class="lead text-primary">El primer paso para dibujar bien no es aprender técnicas, sino aprender a ver.</p>
                `
            },
            2: {
                title: 'La Línea como Movimiento',
                meta: '<span><i class="bi bi-clock me-1"></i>25 minutos</span><span><i class="bi bi-book me-1"></i>Gesto</span><span><i class="bi bi-bar-chart me-1"></i>Intermedio</span>',
                content: `
                    <div class="leonardo-quote">
                        <i class="bi bi-quote text-success fs-3"></i>
                        <p class="mb-0 mt-2">"El movimiento es causa de toda vida."</p>
                        <small class="text-muted d-block mt-2">— Leonardo da Vinci, Cuadernos (c. 1490)</small>
                    </div>

                    <h3>El Croquis Gestual: Capturar la Esencia</h3>
                    <p class="lead">Antes de que un dibujo sea preciso, debe ser <strong>vivo</strong>. El croquis gestual no busca exactitud anatómica, sino capturar la <em>energía</em>, <em>dirección</em> y <em>tensión</em> del cuerpo en movimiento.</p>

                    <p>Cuando Leonardo dibujaba figuras humanas en acción, comenzaba con líneas rápidas que atravesaban todo el cuerpo: la <strong>línea de acción</strong>. Esta línea invisible organiza la pose completa, dándole unidad y dinamismo.</p>

                    <h4>¿Qué es la Línea de Acción?</h4>
                    <p>Es una curva imaginaria que atraviesa la figura, capturando su dirección principal de movimiento o peso. No es una línea real del cuerpo, sino una abstracción que resume la <em>intención</em> de la pose.</p>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card h-100 text-center border-primary">
                                <div class="card-body">
                                    <i class="bi bi-arrow-up-right text-primary" style="font-size: 3rem;"></i>
                                    <h6 class="mt-2">Línea Ascendente</h6>
                                    <p class="small mb-0">Sugiere elevación, salto, energía hacia arriba</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100 text-center border-warning">
                                <div class="card-body">
                                    <i class="bi bi-water text-warning" style="font-size: 3rem;"></i>
                                    <h6 class="mt-2">Curva S</h6>
                                    <p class="small mb-0">Contrapposto, equilibrio dinámico, fluidez</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100 text-center border-danger">
                                <div class="card-body">
                                    <i class="bi bi-arrow-down-right text-danger" style="font-size: 3rem;"></i>
                                    <h6 class="mt-2">Línea Descendente</h6>
                                    <p class="small mb-0">Peso, caída, descanso, tensión hacia abajo</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="observation-box">
                        <h5 class="text-primary mb-3"><i class="bi bi-lightbulb me-2"></i>Principio del Gesto</h5>
                        <p class="mb-0"><strong>"La línea no describe, sugiere."</strong></p>
                        <p class="small text-muted mt-2">En el croquis gestual, una sola línea curva puede comunicar más sobre el movimiento del cuerpo que diez líneas precisas pero sin vida.</p>
                    </div>

                    <h3>Los Tres Elementos del Gesto</h3>
                    
                    <div class="accordion mb-4" id="gestureAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#direccion">
                                    1. Dirección
                                </button>
                            </h2>
                            <div id="direccion" class="accordion-collapse collapse show" data-bs-parent="#gestureAccordion">
                                <div class="accordion-body">
                                    <p><strong>¿Hacia dónde se mueve o se inclina la figura?</strong></p>
                                    <p>Observa la columna vertebral: raramente es vertical. Incluso una figura de pie tiene micro-inclinaciones que revelan peso y equilibrio. La dirección es la primera decisión del croquis gestual.</p>
                                    <ul>
                                        <li>Traza la columna vertebral como primera línea</li>
                                        <li>Observa cómo la cabeza se relaciona con las caderas</li>
                                        <li>Identifica el eje principal del movimiento</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#peso">
                                    2. Peso y Gravedad
                                </button>
                            </h2>
                            <div id="peso" class="accordion-collapse collapse" data-bs-parent="#gestureAccordion">
                                <div class="accordion-body">
                                    <p><strong>¿Dónde está el centro de gravedad?</strong></p>
                                    <p>El cuerpo humano está constantemente negociando con la gravedad. En una pose de pie, el peso se distribuye entre las piernas. En movimiento, el peso se desplaza, creando tensión en ciertos músculos y relajación en otros.</p>
                                    <ul>
                                        <li>Identifica la pierna de apoyo vs. la pierna libre</li>
                                        <li>Observa dónde se concentra la tensión muscular</li>
                                        <li>Nota cómo el peso afecta la posición de hombros y caderas</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ritmo">
                                    3. Ritmo y Contraste
                                </button>
                            </h2>
                            <div id="ritmo" class="accordion-collapse collapse" data-bs-parent="#gestureAccordion">
                                <div class="accordion-body">
                                    <p><strong>¿Cómo se alternan tensión y relajación?</strong></p>
                                    <p>El cuerpo crea ritmos visuales: cuando una cadera sube, la otra baja. Cuando un hombro avanza, el otro retrocede. Estos contrastes dan vida a la figura.</p>
                                    <ul>
                                        <li>Busca el <em>contrapposto</em>: oposición rítmica de partes del cuerpo</li>
                                        <li>Observa alternancias: tensión/relajación, alto/bajo, adelante/atrás</li>
                                        <li>Captura el ritmo antes que los detalles</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>Velocidad vs. Precisión</h3>
                    <p>El croquis gestual es deliberadamente rápido (30 segundos a 2 minutos). Esta velocidad no es un defecto, es una característica: te obliga a capturar solo lo esencial, eliminando detalles irrelevantes.</p>

                    <div class="alert alert-info border-0">
                        <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Neurociencia del Dibujo Rápido</h6>
                        <p class="mb-0">Cuando dibujas rápido, desactivas el pensamiento analítico consciente y activas la percepción visual directa. Tu mano responde a lo que tu ojo ve, sin la interferencia del "conocimiento" conceptual sobre cómo "debería" verse algo.</p>
                    </div>

                    <div class="exercise-box">
                        <div class="exercise-title">
                            <i class="bi bi-pencil-square me-2"></i>Ejercicio 2: Serie de Croquis Gestuales
                        </div>
                        <p><strong>Objetivo:</strong> Capturar movimiento y energía mediante líneas rápidas y decisivas.</p>
                        
                        <h6 class="mt-3">Materiales:</h6>
                        <ul>
                            <li>Papel (mínimo 10 hojas A4 o un cuaderno)</li>
                            <li>Carboncillo, lápiz blando (4B-6B), o marcador</li>
                            <li>Referencias: Usa <a href="https://line-of-action.com" target="_blank">Line of Action</a> (gratuito) o videos en cámara lenta de deportistas</li>
                            <li>Cronómetro</li>
                        </ul>

                        <h6 class="mt-3">Serie de Tiempos:</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tiempo</th>
                                        <th>Cantidad</th>
                                        <th>Foco</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>30 segundos</strong></td>
                                        <td>5 croquis</td>
                                        <td>Solo línea de acción + masa general</td>
                                    </tr>
                                    <tr>
                                        <td><strong>1 minuto</strong></td>
                                        <td>5 croquis</td>
                                        <td>Línea de acción + distribución de peso</td>
                                    </tr>
                                    <tr>
                                        <td><strong>2 minutos</strong></td>
                                        <td>5 croquis</td>
                                        <td>Todo lo anterior + ritmo de extremidades</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h6 class="mt-3">Reglas del Ejercicio:</h6>
                        <ol>
                            <li><strong>No levantes el lápiz</strong> innecesariamente. Deja que las líneas fluyan.</li>
                            <li><strong>No borres nada</strong>. Acepta las líneas incorrectas como parte del proceso.</li>
                            <li><strong>Prioriza dirección sobre detalle</strong>. Si te queda tiempo, puedes sugerir brazos/piernas, pero solo después de capturar el gesto principal.</li>
                            <li><strong>Dibuja "a través" del cuerpo</strong>. No dibujes solo el contorno visible; sugiere la estructura tridimensional completa.</li>
                        </ol>

                        <div class="alert alert-warning border-0 mt-3">
                            <p class="mb-0"><strong>Expectativa vs. Realidad:</strong> Tus primeros 5 croquis probablemente se verán caóticos. Esto es normal y correcto. Estás entrenando tu cerebro a ver movimiento, no a producir dibujos "bonitos".</p>
                        </div>

                        <h6 class="mt-3">Entregable:</h6>
                        <ul>
                            <li>15 croquis gestuales totales (fotografía de la página completa es suficiente)</li>
                            <li>Reflexión escrita (150 palabras): "¿Qué fue más difícil: capturar dirección, peso o ritmo? ¿Por qué?"</li>
                        </ul>
                    </div>

                    <h3>De la Línea al Volumen</h3>
                    <p>El croquis gestual es el fundamento. Una vez que puedes capturar el movimiento con líneas rápidas, el siguiente paso es agregar <em>volumen</em>: la sensación de que estas líneas representan masas tridimensionales en el espacio.</p>

                    <p class="lead text-primary">La línea es el primer paso. El volumen es el siguiente. Pero sin gesto, el volumen es una forma vacía.</p>
                `
            },
            3: {
                title: 'Volumen y Masa',
                meta: '<span><i class="bi bi-clock me-1"></i>25 minutos</span><span><i class="bi bi-book me-1"></i>Tridimensionalidad</span><span><i class="bi bi-bar-chart me-1"></i>Intermedio</span>',
                content: `
                    <div class="leonardo-quote">
                        <i class="bi bi-quote text-success fs-3"></i>
                        <p class="mb-0 mt-2">"La luz y la sombra hacen que el cuerpo parezca tener relieve."</p>
                        <small class="text-muted d-block mt-2">— Leonardo da Vinci, Tratado de la Pintura</small>
                    </div>

                    <h3>De la Línea a la Masa</h3>
                    <p class="lead">Una línea en el papel es bidimensional, pero el cuerpo humano es <strong>tridimensional</strong>. El volumen es la ilusión de que lo dibujado ocupa espacio, tiene peso, puede ser rodeado.</p>

                    <p>Leonardo comprendió que el volumen no se logra agregando más líneas, sino observando cómo <strong>la luz revela la forma</strong>. Donde hay luz, la forma se acerca hacia nosotros. Donde hay sombra, se aleja o se esconde.</p>

                    <h4>Observar la Luz como Escultor</h4>
                    <p>La luz no es un "efecto" que se agrega después. La luz <em>construye</em> la forma en nuestra percepción. Sin luz, no vemos volumen; vemos solo silueta.</p>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card h-100 border-warning">
                                <div class="card-body text-center">
                                    <i class="bi bi-brightness-high text-warning" style="font-size: 2.5rem;"></i>
                                    <h6 class="mt-2">Luz Directa</h6>
                                    <p class="small mb-0">Planos que miran hacia la fuente de luz. Los más claros.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100 border-secondary">
                                <div class="card-body text-center">
                                    <i class="bi bi-cloud text-secondary" style="font-size: 2.5rem;"></i>
                                    <h6 class="mt-2">Medios Tonos</h6>
                                    <p class="small mb-0">Planos en ángulo a la luz. Transición gradual.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100 border-dark">
                                <div class="card-body text-center">
                                    <i class="bi bi-moon text-dark" style="font-size: 2.5rem;"></i>
                                    <h6 class="mt-2">Sombra Propia</h6>
                                    <p class="small mb-0">Planos alejados de la luz. Los más oscuros.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="observation-box">
                        <h5 class="text-primary mb-3"><i class="bi bi-lightbulb me-2"></i>Principio del Volumen</h5>
                        <p class="mb-0"><strong>"No dibujes líneas, dibuja planos que reciben luz."</strong></p>
                        <p class="small text-muted mt-2">El contorno es solo el lugar donde un plano iluminado se encuentra con el fondo. La verdadera estructura está en cómo la luz modela la superficie.</p>
                    </div>

                    <h3>Pensar en Formas Geométricas Simples</h3>
                    <p>Leonardo reducía formas complejas a geometría simple: cilindros, esferas, cubos. No porque el cuerpo sea geométrico, sino porque estas formas nos ayudan a comprender cómo la luz las afecta.</p>

                    <div class="alert alert-info border-0">
                        <h6 class="alert-heading"><i class="bi bi-cube me-2"></i>Formas Base del Cuerpo</h6>
                        <ul class="mb-0">
                            <li><strong>Cabeza:</strong> Esfera modificada con planos faciales</li>
                            <li><strong>Cuello:</strong> Cilindro que conecta cabeza con torso</li>
                            <li><strong>Torso:</strong> Caja (caja torácica) + cilindro (abdomen)</li>
                            <li><strong>Brazos/Piernas:</strong> Cilindros modificados que se adelgazan</li>
                            <li><strong>Manos/Pies:</strong> Cajas complejas con planos angulares</li>
                        </ul>
                    </div>

                    <h4>De la Geometría a la Anatomía</h4>
                    <p>Las formas geométricas son herramientas de comprensión, no el objetivo final. Una vez que entiendes cómo la luz afecta un cilindro simple, puedes observar cómo afecta al brazo humano, que es un cilindro <em>modificado</em> por músculos, huesos y tejido.</p>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card border-primary h-100">
                                <div class="card-header bg-primary text-white">
                                    <i class="bi bi-circle me-2"></i>Paso 1: Forma Simple
                                </div>
                                <div class="card-body">
                                    <p class="mb-0">Observa el brazo como un cilindro básico. Identifica dónde está la luz, dónde la sombra, cómo se gradúa la transición.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success h-100">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-triangle me-2"></i>Paso 2: Modificaciones Anatómicas
                                </div>
                                <div class="card-body">
                                    <p class="mb-0">Ajusta el cilindro: el bíceps crea una protuberancia, el codo un ángulo, el antebrazo una forma más compleja. Pero la lógica de luz permanece.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>Gradación: La Clave del Volumen Convincente</h3>
                    <p>La diferencia entre un dibujo plano y uno tridimensional está en la <strong>gradación</strong>: la transición suave entre luz y sombra. Las formas redondeadas tienen gradaciones graduales; las angulares tienen transiciones abruptas.</p>

                    <div class="accordion mb-4" id="volumeAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#esfera">
                                    Esfera: Gradación Circular
                                </button>
                            </h2>
                            <div id="esfera" class="accordion-collapse collapse show" data-bs-parent="#volumeAccordion">
                                <div class="accordion-body">
                                    <p>Una esfera tiene el punto más brillante donde la luz la golpea directamente. Desde ahí, la gradación es circular y suave hacia todos los lados, hasta llegar a la sombra más profunda en el lado opuesto.</p>
                                    <p class="text-muted small mb-0"><em>Aplicación: Cabeza, articulaciones (hombros, rodillas), músculos redondeados.</em></p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cilindro">
                                    Cilindro: Gradación Direccional
                                </button>
                            </h2>
                            <div id="cilindro" class="accordion-collapse collapse" data-bs-parent="#volumeAccordion">
                                <div class="accordion-body">
                                    <p>Un cilindro tiene una banda de luz que corre a lo largo de su eje. La gradación ocurre perpendicular a este eje, creando una transición clara de luz a sombra en la superficie curva.</p>
                                    <p class="text-muted small mb-0"><em>Aplicación: Brazos, piernas, cuello, torso.</em></p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#planos">
                                    Planos Angulares: Cambios Abruptos
                                </button>
                            </h2>
                            <div id="planos" class="accordion-collapse collapse" data-bs-parent="#volumeAccordion">
                                <div class="accordion-body">
                                    <p>Donde la anatomía crea ángulos (huesos visibles, articulaciones flexionadas), la luz cambia abruptamente. No hay gradación suave; hay cambio de valor claro entre planos.</p>
                                    <p class="text-muted small mb-0"><em>Aplicación: Estructura facial, codos, rodillas, manos, pies.</em></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="exercise-box">
                        <div class="exercise-title">
                            <i class="bi bi-pencil-square me-2"></i>Ejercicio 3: Estudio de Volumen con Luz Dirigida
                        </div>
                        <p><strong>Objetivo:</strong> Comprender cómo la luz revela la estructura tridimensional del cuerpo mediante observación directa.</p>
                        
                        <h6 class="mt-3">Materiales:</h6>
                        <ul>
                            <li>Papel blanco (A4 o mayor)</li>
                            <li>Lápiz grafito (rango 2B-6B) o carboncillo</li>
                            <li>Difumino o papel para difuminar (opcional)</li>
                            <li>Referencia: Tu propio brazo + lámpara direccional</li>
                        </ul>

                        <h6 class="mt-3">Configuración de Iluminación:</h6>
                        <ol>
                            <li>Coloca una lámpara (lámpara de escritorio, linterna de celular) a 45° de tu brazo</li>
                            <li>Asegúrate que el resto del ambiente esté relativamente oscuro</li>
                            <li>Observa cómo la luz crea una gradación clara de brillante a oscuro</li>
                        </ol>

                        <h6 class="mt-3">Proceso del Dibujo (30 minutos):</h6>
                        <ol>
                            <li><strong>Minutos 0-5:</strong> Observa sin dibujar. Identifica:
                                <ul>
                                    <li>¿Dónde está el punto más brillante?</li>
                                    <li>¿Dónde está la sombra más profunda?</li>
                                    <li>¿Cómo es la transición entre ambos?</li>
                                </ul>
                            </li>
                            <li><strong>Minutos 5-10:</strong> Dibuja el contorno básico con línea ligera</li>
                            <li><strong>Minutos 10-25:</strong> Construye el volumen mediante gradación:
                                <ul>
                                    <li>Comienza con las sombras más oscuras</li>
                                    <li>Gradúa hacia los medios tonos</li>
                                    <li>Deja el papel en blanco donde hay luz directa</li>
                                </ul>
                            </li>
                            <li><strong>Minutos 25-30:</strong> Refina transiciones y ajusta valores</li>
                        </ol>

                        <div class="alert alert-warning border-0 mt-3">
                            <p class="mb-0"><strong>Regla crítica:</strong> No uses líneas para separar luz de sombra. La separación debe ser mediante gradación de valor (tono), no mediante contorno.</p>
                        </div>

                        <h6 class="mt-3">Desafío Adicional: Copiar un Estudio de Leonardo</h6>
                        <p>Busca un estudio anatómico de Leonardo da Vinci (disponibles en dominio público en Wikimedia Commons). Intenta copiar cómo él representa el volumen:</p>
                        <ul>
                            <li>Observa su uso de líneas paralelas para sombreado</li>
                            <li>Nota cómo sugiere volumen con mínimas marcas</li>
                            <li>Estudia su énfasis en estructura más que en superficie</li>
                        </ul>

                        <h6 class="mt-3">Entregable:</h6>
                        <ul>
                            <li>1 estudio de tu brazo con luz dirigida (30 min)</li>
                            <li>1 copia de estudio anatómico de Leonardo (20 min mínimo)</li>
                            <li>Reflexión escrita (150 palabras): "¿Cómo cambia mi percepción del cuerpo cuando pienso en términos de luz y planos en lugar de líneas y contornos?"</li>
                        </ul>
                    </div>

                    <h3>Integración: Gesto + Volumen</h3>
                    <p>Ahora que comprendes tanto el gesto (dirección, energía) como el volumen (luz, forma), el siguiente paso es integrarlos:</p>

                    <ol>
                        <li><strong>Comienza con el gesto:</strong> Captura la línea de acción y dirección general (30 segundos - 1 minuto)</li>
                        <li><strong>Agrega formas volumétricas simples:</strong> Cilindros, esferas sobre la estructura gestual (2-3 minutos)</li>
                        <li><strong>Observa la luz:</strong> Identifica dónde están las áreas brillantes y oscuras (1 minuto de observación)</li>
                        <li><strong>Construye el volumen:</strong> Gradúa de luz a sombra siguiendo la lógica de las formas (5-10 minutos)</li>
                    </ol>

                    <div class="alert alert-success border-0">
                        <h6 class="alert-heading"><i class="bi bi-trophy me-2"></i>Logro del Módulo 1</h6>
                        <p>Al completar este módulo, habrás experimentado los tres pilares del método leonardesco:</p>
                        <ul class="mb-0">
                            <li>✅ <strong>Observación contemplativa:</strong> Ver más allá del reconocimiento automático</li>
                            <li>✅ <strong>Gesto y movimiento:</strong> Capturar la energía antes que el detalle</li>
                            <li>✅ <strong>Volumen y luz:</strong> Comprender la tridimensionalidad mediante observación de luz</li>
                        </ul>
                        <p class="mt-3 mb-0 fw-bold">Estás listo para el Módulo 2: Anatomía como Comprensión Orgánica</p>
                    </div>

                    <h3>Entregable Final del Módulo 1</h3>
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-folder-check me-2"></i><strong>Portfolio Módulo 1: Observación y Gesto</strong>
                        </div>
                        <div class="card-body">
                            <p>Reúne todos los ejercicios del módulo:</p>
                            <ol>
                                <li><strong>Ejercicio 1:</strong> 1 dibujo de tu mano (10 min) + reflexión 100 palabras</li>
                                <li><strong>Ejercicio 2:</strong> 15 croquis gestuales (serie completa) + reflexión 150 palabras</li>
                                <li><strong>Ejercicio 3:</strong> 1 estudio de brazo + 1 copia de Leonardo + reflexión 150 palabras</li>
                            </ol>
                            <p class="mb-0"><strong>Formato de entrega:</strong> PDF o imágenes de alta calidad. Incluye todas las reflexiones escritas al final del documento.</p>
                        </div>
                    </div>

                    <p class="lead text-primary mt-4">El viaje ha comenzado. Has aprendido a ver, a capturar movimiento, y a pensar en términos de luz y forma. El siguiente paso es comprender la lógica interna del cuerpo.</p>
                `
            }
        };

        window.addEventListener('online', () => {
            isOnline = true;
            console.log('✓ Conexión restaurada');
            syncProgressWithSheets();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('⚠ Sin conexión - modo offline');
        });

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando Módulo 1 - Método Leonardo...');
            
            if (typeof getCurrentUser !== 'undefined' && typeof protectPage !== 'undefined') {
                if (!protectPage()) return;
                currentUser = getCurrentUser();
            } else {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                } else {
                    console.error('✖ No hay usuario autenticado');
                    window.location.href = 'login.html';
                    return;
                }
            }

            console.log('✓ Usuario autenticado:', currentUser);
            
            loadModuleProgress();
            loadLesson(1);
            
            if (typeof logUserActivity === 'function') {
                logUserActivity('module_access', currentUser, { 
                    moduleId: 1,
                    moduleTitle: 'Observación y Gesto - Método Leonardo'
                });
            }
        });

        async function loadModuleProgress() {
            console.log('📊 Cargando progreso del Módulo 1...');
            
            try {
                if (isOnline && typeof getStudentProgress === 'function') {
                    console.log('☁️ Intentando cargar desde Google Sheets...');
                    const sheetsProgress = await getStudentProgress(currentUser.username);
                    
                    if (sheetsProgress && sheetsProgress.modules && sheetsProgress.modules[1]) {
                        moduleProgress = sheetsProgress.modules[1].progress || 0;
                        completedLessons = sheetsProgress.modules[1].completedLessons || [];
                        
                        console.log('✓ Progreso cargado desde Google Sheets:', {
                            moduleProgress,
                            completedLessons
                        });
                        
                        syncToLocalStorage(sheetsProgress.modules[1]);
                        updateProgressDisplay();
                        updateSidebarProgress();
                        return;
                    }
                }
            } catch (error) {
                console.error('✖ Error cargando desde Google Sheets:', error);
            }
            
            console.log('💾 Cargando desde localStorage (fallback)...');
            const progressKey = `progress_${currentUser.username || currentUser.email}`;
            const userProgress = JSON.parse(localStorage.getItem(progressKey) || 'null');
            
            if (userProgress && userProgress.modules && userProgress.modules[1]) {
                moduleProgress = userProgress.modules[1].progress || 0;
                completedLessons = userProgress.modules[1].completedLessons || [];
                
                console.log('✓ Progreso cargado desde localStorage:', {
                    moduleProgress,
                    completedLessons
                });
            } else {
                console.log('ℹ️ No hay progreso previo - iniciando desde cero');
            }
            
            updateProgressDisplay();
            updateSidebarProgress();
        }

        function syncToLocalStorage(moduleData) {
            const progressKey = `progress_${currentUser.username || currentUser.email}`;
            let userProgress = JSON.parse(localStorage.getItem(progressKey) || 'null');
            
            if (!userProgress) {
                userProgress = initializeLocalProgress();
            }
            
            userProgress.modules[1] = moduleData;
            userProgress.lastActivity = new Date().toISOString();
            localStorage.setItem(progressKey, JSON.stringify(userProgress));
            
            console.log('✓ Sincronizado con localStorage');
        }

        function initializeLocalProgress() {
            return {
                modules: {
                    1: { completed: false, progress: 0, timeSpent: 0, completedLessons: [] },
                    2: { completed: false, progress: 0, timeSpent: 0, completedLessons: [] },
                    3: { completed: false, progress: 0, timeSpent: 0, completedLessons: [] }
                },
                overallProgress: 0,
                totalTimeSpent: 0,
                lastActivity: new Date().toISOString()
            };
        }

        function updateProgressDisplay() {
            document.getElementById('progressText').textContent = moduleProgress + '% Completado';
            
            const progressBar = document.getElementById('moduleProgress');
            progressBar.style.width = moduleProgress + '%';
            const progressText = progressBar.querySelector('span');
            if (progressText) {
                progressText.textContent = moduleProgress + '%';
            }
        }

        function updateSidebarProgress() {
            document.querySelectorAll('.lesson-link').forEach((link) => {
                const lessonNum = parseInt(link.getAttribute('data-lesson'));
                link.classList.remove('completed');
                
                if (completedLessons.includes(lessonNum)) {
                    link.classList.add('completed');
                }
            });
        }

        function loadLesson(lessonNumber) {
            console.log('📖 Cargando lección:', lessonNumber);
            currentLesson = lessonNumber;
            
            document.querySelectorAll('.lesson-link').forEach((link) => {
                link.classList.remove('active');
                if (parseInt(link.getAttribute('data-lesson')) === lessonNumber) {
                    link.classList.add('active');
                }
            });

            const lesson = lessonsContent[lessonNumber];
            if (lesson) {
                document.getElementById('lessonTitle').textContent = lesson.title;
                document.getElementById('lessonMeta').innerHTML = lesson.meta;
                document.getElementById('lessonContent').innerHTML = lesson.content;
            } else {
                console.error('✖ Lección no encontrada:', lessonNumber);
            }

            updateNavigationButtons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateNavigationButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            const completeButton = document.getElementById('completeButton');

            prevButton.disabled = (currentLesson <= 1);

            if (currentLesson >= 3) {
                nextButton.style.display = 'none';
            } else {
                nextButton.style.display = 'inline-block';
            }

            if (completedLessons.includes(currentLesson)) {
                completeButton.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Lección Completada';
                completeButton.classList.add('btn', 'btn-success');
                completeButton.classList.remove('btn-uah-success');
                completeButton.disabled = true;
            } else {
                completeButton.innerHTML = '<i class="bi bi-check-circle me-2"></i>Marcar como Completada';
                completeButton.classList.add('btn-uah-success');
                completeButton.classList.remove('btn', 'btn-success');
                completeButton.disabled = false;
            }
        }

        function goToPreviousLesson() {
            if (currentLesson > 1) {
                loadLesson(currentLesson - 1);
            }
        }

        function goToNextLesson() {
            if (currentLesson < 3) {
                loadLesson(currentLesson + 1);
            }
        }

        async function completeLesson() {
            if (completedLessons.includes(currentLesson)) {
                console.log('ℹ️ Lección ya completada');
                return;
            }

            completedLessons.push(currentLesson);
            moduleProgress = Math.round((completedLessons.length / 3) * 100);
            
            console.log('✓ Lección completada:', currentLesson, '- Progreso:', moduleProgress + '%');
            
            await saveProgress();
            
            updateProgressDisplay();
            updateSidebarProgress();
            updateNavigationButtons();
            
            if (moduleProgress >= 100) {
                showNotification('¡Felicitaciones! Has completado el Módulo 1: Observación y Gesto', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            } else {
                showNotification('¡Lección ' + currentLesson + ' completada!', 'success');
                
                if (currentLesson < 3) {
                    setTimeout(() => {
                        loadLesson(currentLesson + 1);
                    }, 2000);
                }
            }
        }

        async function saveProgress() {
            console.log('💾 Guardando progreso...');
            
            const progressData = {
                progress: moduleProgress,
                completed: moduleProgress >= 100,
                completedLessons: completedLessons,
                timeSpent: 0,
                lastUpdate: new Date().toISOString()
            };
            
            const progressKey = `progress_${currentUser.username || currentUser.email}`;
            let userProgress = JSON.parse(localStorage.getItem(progressKey) || 'null');
            
            if (!userProgress) {
                userProgress = initializeLocalProgress();
            }

            userProgress.modules[1] = progressData;
            
            let totalProgress = 0;
            for (let id in userProgress.modules) {
                totalProgress += userProgress.modules[id].progress || 0;
            }
            userProgress.overallProgress = Math.round(totalProgress / 3);
            userProgress.lastActivity = new Date().toISOString();

            localStorage.setItem(progressKey, JSON.stringify(userProgress));
            console.log('✓ Guardado en localStorage');

            try {
                if (isOnline && typeof updateModuleProgress === 'function') {
                    console.log('☁️ Sincronizando con Google Sheets...');
                    const success = await updateModuleProgress(1, progressData);
                    
                    if (success) {
                        console.log('✓ Sincronizado con Google Sheets');
                    } else {
                        console.warn('⚠ No se pudo sincronizar con Sheets');
                    }
                } else {
                    console.log('🔴 Modo offline - solo localStorage');
                }
                
                if (typeof logUserActivity === 'function') {
                    logUserActivity('lesson_completed', currentUser, {
                        moduleId: 1,
                        lessonId: currentLesson,
                        progress: moduleProgress
                    });
                }
                
            } catch (error) {
                console.error('✖ Error sincronizando:', error);
            }
        }

        async function syncProgressWithSheets() {
            try {
                if (!isOnline || typeof updateModuleProgress !== 'function') return;
                
                const progressKey = `progress_${currentUser.username || currentUser.email}`;
                const localProgress = JSON.parse(localStorage.getItem(progressKey) || 'null');
                
                if (localProgress && localProgress.modules[1]) {
                    console.log('🔄 Sincronizando progreso local...');
                    const success = await updateModuleProgress(1, localProgress.modules[1]);
                    
                    if (success) {
                        console.log('✓ Sincronización completada');
                        showNotification('Progreso sincronizado con la nube', 'info');
                    }
                }
            } catch (error) {
                console.error('✖ Error en sincronización automática:', error);
            }
        }

        function showNotification(message, type = 'success') {
            const toastEl = document.getElementById('notificationToast');
            const toastBody = document.getElementById('toastBody');
            const toastIcon = document.getElementById('toastIcon');
            
            const icons = {
                success: 'bi-check-circle-fill text-success',
                error: 'bi-x-circle-fill text-danger',
                warning: 'bi-exclamation-triangle-fill text-warning',
                info: 'bi-info-circle-fill text-info'
            };
            
            toastIcon.className = icons[type] || icons.success;
            toastIcon.className += ' me-2';
            toastBody.textContent = message;
            
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
        }

        window.addEventListener('error', function(e) {
            console.error('✖ Error global:', e);
        });

        window.addEventListener('beforeunload', function() {
            if (moduleProgress > 0 && completedLessons.length > 0) {
                saveProgress();
            }
        });
    </script>
</body>
</html>