<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo 1: Observación y Gesto (Mejorado) - LMS UAH</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary-dark: #2c5f66;
            --primary-light: #e8a2b8;
            --dark: #1a1a1a;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #f44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }

        .header-uah {
            background: linear-gradient(135deg, var(--primary-dark), var(--dark));
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1030;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sidebar-lesson {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            position: sticky;
            top: 90px;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .lesson-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .lesson-link:hover {
            background: #f8f9fa;
        }

        .lesson-link.active {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: white;
        }

        .lesson-number {
            width: 30px;
            height: 30px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .lesson-link.active .lesson-number {
            background: white;
            color: var(--primary-dark);
        }

        .lesson-link.completed .lesson-number {
            background: var(--success);
            color: white;
        }
        
        .lesson-link.completed::after {
            content: '\F26B'; /* Icono de Bootstrap checkmark */
            font-family: 'bootstrap-icons';
            color: var(--success);
            font-size: 1.2rem;
            margin-left: auto;
        }

        .progress-module {
            height: 6px;
            background: #e9ecef;
            border-radius: 10px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar-module {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary-light));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .content-area {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            min-height: 70vh;
        }

        .lesson-header {
            border-bottom: 3px solid var(--primary-light);
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        
        .lesson-title {
            color: var(--primary-dark);
            font-weight: 700;
        }
        
        .objectives-list {
            background: #f8f9fa;
            border-left: 4px solid var(--primary-dark);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .accordion-button {
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            color: var(--dark);
            font-weight: 600;
        }

        .accordion-button:not(.collapsed) {
            background: var(--primary-dark);
            color: white;
        }

        .exercise-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid var(--primary-light);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        
        .image-placeholder {
            border: 2px dashed #adb5bd;
            border-radius: 8px;
            aspect-ratio: 3/4;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.85rem;
        }

        .evaluation-container {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
        }

        .eval-question {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .eval-option {
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .eval-option:hover {
            border-color: var(--primary-dark);
        }
        
        .eval-option.selected {
            border-color: var(--primary-dark);
            background: rgba(44, 95, 102, 0.1);
        }

        .eval-option.correct {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .eval-option.incorrect {
            border-color: var(--danger);
            background: rgba(244, 67, 54, 0.1);
        }

        .eval-radio {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .eval-option.selected .eval-radio {
            border-color: var(--primary-dark);
            background: var(--primary-dark);
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            border: none;
            color: white;
        }

        @media (max-width: 991px) {
            .sidebar-lesson {
                position: static;
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <script src="auth.js"></script>

    <header class="header-uah">
        <div class="container-fluid">
            <div class="row align-items-center g-2">
                <div class="col-auto">
                    <a href="index.html" class="text-white text-decoration-none">
                        <i class="bi bi-arrow-left me-2"></i><span class="d-none d-md-inline">Volver</span>
                    </a>
                </div>
                <div class="col text-center">
                    <h1 class="h5 h-md-4 mb-0">Módulo 1: Observación y Gesto</h1>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark" id="progressText">0%</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container-fluid py-3 py-md-4">
        <div class="row">
            <aside class="col-lg-3">
                <div class="sidebar-lesson">
                    <h5 class="mb-3"><i class="bi bi-book me-2"></i>Lecciones</h5>
                    <a class="lesson-link active" data-lesson="1" onclick="loadLesson(1)">
                        <span class="lesson-number">1</span>
                        <span class="flex-grow-1">Fundamentos del Croquis</span>
                    </a>
                    <a class="lesson-link" data-lesson="2" onclick="loadLesson(2)">
                        <span class="lesson-number">2</span>
                        <span class="flex-grow-1">Proporciones</span>
                    </a>
                    <a class="lesson-link" data-lesson="3" onclick="loadLesson(3)">
                        <span class="lesson-number">3</span>
                        <span class="flex-grow-1">Balance</span>
                    </a>
                    
                    <div class="mt-4">
                        <h6 class="mb-2">Progreso del Módulo</h6>
                        <div class="progress-module">
                            <div class="progress-bar-module" id="progressBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted d-block mt-2" id="progressDetail">0 de 3 lecciones completadas</small>
                    </div>

                    <div class="card border-primary mt-3">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-info-circle me-2"></i>Módulo 1
                        </div>
                        <div class="card-body">
                            <p class="small mb-2"><strong>Duración:</strong> 3 días</p>
                            <p class="small mb-2"><strong>Carga:</strong> 150 min aprox.</p>
                            <p class="small mb-0"><strong>Entregable:</strong> 8 croquis/figuras</p>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="col-lg-9">
                <div class="content-area" id="lessonContent">
                    </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentLesson = 1;
        let completedLessons = [];
        let evaluationAnswers = {};
        let currentUser = { name: 'Estudiante', email: 'estudiante@uah.cl' }; // Default user
        
        // Cargar usuario real si auth.js está disponible
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof getCurrentUser === 'function' && getCurrentUser()) {
                currentUser = getCurrentUser();
            }
            loadProgress();
            loadLesson(1);
        });
        
        // --- GESTIÓN DE PROGRESO ---
        function loadProgress() {
            const progressKey = `module1_progress_${currentUser.email}`;
            const saved = JSON.parse(localStorage.getItem(progressKey)) || {};
            completedLessons = saved.completedLessons || [];
            evaluationAnswers = saved.evaluations || {};
            updateProgressBar();
        }

        function saveProgress() {
            const progressKey = `module1_progress_${currentUser.email}`;
            const dataToSave = {
                completedLessons: completedLessons,
                evaluations: evaluationAnswers
            };
            localStorage.setItem(progressKey, JSON.stringify(dataToSave));
            updateProgressBar();
        }

        function updateProgressBar() {
            const totalLessons = 3;
            const completedCount = completedLessons.length;
            const percentage = Math.round((completedCount / totalLessons) * 100);
            
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = percentage + '%';
            document.getElementById('progressDetail').textContent = 
                `${completedCount} de ${totalLessons} lecciones completadas`;
            
            document.querySelectorAll('.lesson-link').forEach(link => {
                const lessonNum = parseInt(link.dataset.lesson);
                if (completedLessons.includes(lessonNum)) {
                    link.classList.add('completed');
                }
            });
        }
        
        function completeLesson(lessonNum) {
            if (!completedLessons.includes(lessonNum)) {
                completedLessons.push(lessonNum);
                saveProgress();
                showToast('¡Lección completada!', 'success');
                if (lessonNum < 3) {
                   setTimeout(() => loadLesson(lessonNum + 1), 1500);
                } else {
                   showToast('¡Felicidades, has completado el Módulo 1!', 'success');
                }
            }
        }

        // --- NAVEGACIÓN Y CARGA DE CONTENIDO ---
        function loadLesson(lessonNum) {
            currentLesson = lessonNum;
            document.querySelectorAll('.lesson-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`[data-lesson="${lessonNum}"]`).classList.add('active');
            
            const lessonData = lessonsContent[`lesson${lessonNum}`];
            document.getElementById('lessonContent').innerHTML = lessonData.content;
            
            // MEJORA: Personalización
            const welcomeEl = document.getElementById('welcomeMessage');
            if(welcomeEl) {
                welcomeEl.textContent = `¡Hola, ${currentUser.name}! Empecemos con la Lección ${lessonNum}.`;
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // --- EVALUACIONES ---
        function selectEvalOption(element, optionNumber, lessonNum) {
            const container = element.parentElement;
            const question = container.dataset.question;
            container.querySelectorAll('.eval-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            
            if (!evaluationAnswers[lessonNum]) evaluationAnswers[lessonNum] = {};
            evaluationAnswers[lessonNum][question] = optionNumber;
        }

        function submitEvaluation(lessonNum) {
            const correctAnswers = lessonsContent[`lesson${lessonNum}`].answers;
            const userAnswers = evaluationAnswers[lessonNum] || {};

            if (Object.keys(userAnswers).length < Object.keys(correctAnswers).length) {
                showToast('Por favor, responde todas las preguntas.', 'warning');
                return;
            }

            let score = 0;
            Object.keys(correctAnswers).forEach(q => {
                if (userAnswers[q] === correctAnswers[q]) score++;
            });

            // Mostrar feedback visual
            Object.keys(correctAnswers).forEach(q => {
                const container = document.querySelector(`[data-question="${q}"]`);
                if (container) {
                    const options = container.querySelectorAll('.eval-option');
                    options.forEach((opt, idx) => {
                        const optNum = idx + 1;
                        if (optNum === correctAnswers[q]) opt.classList.add('correct');
                        else if (optNum === userAnswers[q]) opt.classList.add('incorrect');
                        opt.style.pointerEvents = 'none';
                    });
                }
            });

            document.getElementById('submitEvalBtn').style.display = 'none';
            const passed = score >= 2;
            const resultText = `Obtuviste ${score}/${Object.keys(correctAnswers).length} respuestas correctas.`;

            if (passed) {
                document.getElementById('evalResult').innerHTML = `
                    <div class="alert alert-success"><i class="bi bi-check-circle-fill me-2"></i><strong>¡Aprobado!</strong> ${resultText}</div>`;
                completeLesson(lessonNum);
                document.getElementById('nextLessonBtn').style.display = 'inline-block';
            } else {
                document.getElementById('evalResult').innerHTML = `
                    <div class="alert alert-warning"><i class="bi bi-exclamation-triangle-fill me-2"></i><strong>A revisar.</strong> ${resultText} Revisa el contenido e inténtalo de nuevo.</div>`;
                document.getElementById('retryEvalBtn').style.display = 'inline-block';
            }
            saveProgress();
        }

        function retryEvaluation(lessonNum) {
            evaluationAnswers[lessonNum] = {};
            saveProgress();
            loadLesson(lessonNum);
        }

        function goToNextLesson() {
            if (currentLesson < 3) {
                loadLesson(currentLesson + 1);
            }
        }
        
        // --- UTILIDADES ---
        function showToast(message, type = 'info') {
            const colors = { success: '#4CAF50', warning: '#FFC107', info: '#2196F3' };
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; top: 80px; right: 20px; background: ${colors[type]}; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; animation: slideIn 0.3s ease-out;`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove() }, 3000);
        }

        // --- CONTENIDO DE LECCIONES ---
        const lessonsContent = {
            lesson1: {
                answers: { q1: 2, q2: 1, q3: 3 },
                content: `
                    <div class="lesson-header">
                        <h2 class="lesson-title">Lección 1.1: Fundamentos del Croquis Rápido</h2>
                        <p class="text-muted" id="welcomeMessage">¡Hola, ${currentUser.name}! Empecemos con la Lección 1.</p>
                    </div>
                    
                    <div class="objectives-list">
                        <h6 class="mb-2"><i class="bi bi-bullseye me-2"></i>Objetivos de Aprendizaje</h6>
                        <ul>
                            <li>Aplicar técnicas de observación para capturar la línea de acción (2 min).</li>
                            <li>Identificar eje central y puntos de peso en figuras humanas.</li>
                        </ul>
                    </div>

                    <div class="accordion mb-4" id="accordionLesson1">
                        <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#c1">¿Qué es la Línea de Acción?</button></h2><div id="c1" class="accordion-collapse collapse show" data-bs-parent="#accordionLesson1"><div class="accordion-body">La línea de acción es el eje imaginario que atraviesa toda la figura, definiendo la dirección y energía del movimiento.</div></div></div>
                        <div class="accordion-item"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#c2">Peso y Punto de Apoyo</button></h2><div id="c2" class="accordion-collapse collapse" data-bs-parent="#accordionLesson1"><div class="accordion-body">Identificar dónde se concentra el peso es fundamental para crear figuras creíbles. La línea vertical desde el centro de la cabeza debe caer dentro del área entre los pies.</div></div></div>
                    </div>

                    <div class="exercise-card">
                        <h5 class="mb-3"><i class="bi bi-palette me-2"></i>Ejercicio 1: 3 Croquis de 2 Minutos</h5>
                        <p><strong>Objetivo:</strong> Capturar línea de acción y peso en 3 poses diferentes.</p>
                        <div class="row g-2 mb-3">
                            <div class="col-4"><div class="image-placeholder">ref1_figura_pie.jpg</div></div>
                            <div class="col-4"><div class="image-placeholder">ref2_pose_dinamica.jpg</div></div>
                            <div class="col-4"><div class="image-placeholder">ref3_contrapposto.jpg</div></div>
                        </div>
                        <div class="list-group">
                           <label class="list-group-item"><input class="form-check-input me-2" type="checkbox" value="">Configurar cronómetro a 2 minutos.</label>
                           <label class="list-group-item"><input class="form-check-input me-2" type="checkbox" value="">Dibujar croquis 1 sin borrar.</label>
                           <label class="list-group-item"><input class="form-check-input me-2" type="checkbox" value="">Repetir para croquis 2 y 3.</label>
                        </div>
                    </div>

                    <div class="evaluation-container">
                        <h4 class="mb-4"><i class="bi bi-clipboard-check me-2"></i>Evaluación Lección 1.1</h4>
                        <div class="eval-question" data-question="q1"><p><strong>1. ¿Cuál es el objetivo principal de un croquis de 2 minutos?</strong></p><div class="eval-options"><div class="eval-option" onclick="selectEvalOption(this,1,1)"><div class="eval-radio"></div><span>A) Lograr un dibujo detallado y realista</span></div><div class="eval-option" onclick="selectEvalOption(this,2,1)"><div class="eval-radio"></div><span>B) Capturar la energía, dirección y peso del cuerpo</span></div><div class="eval-option" onclick="selectEvalOption(this,3,1)"><div class="eval-radio"></div><span>C) Practicar técnicas de sombreado</span></div></div></div>
                        <div class="eval-question" data-question="q2"><p><strong>2. ¿Qué debes identificar PRIMERO antes de comenzar a dibujar?</strong></p><div class="eval-options"><div class="eval-option" onclick="selectEvalOption(this,1,1)"><div class="eval-radio"></div><span>A) La línea de acción y el punto de apoyo</span></div><div class="eval-option" onclick="selectEvalOption(this,2,1)"><div class="eval-radio"></div><span>B) Los detalles del rostro</span></div><div class="eval-option" onclick="selectEvalOption(this,3,1)"><div class="eval-radio"></div><span>C) La textura de la ropa</span></div></div></div>
                        <div class="eval-question" data-question="q3"><p><strong>3. En el croquis rápido, ¿qué actitud es la más apropiada?</strong></p><div class="eval-options"><div class="eval-option" onclick="selectEvalOption(this,1,1)"><div class="eval-radio"></div><span>A) Borrar constantemente hasta lograr perfección</span></div><div class="eval-option" onclick="selectEvalOption(this,2,1)"><div class="eval-radio"></div><span>B) Comenzar con detalles pequeños</span></div><div class="eval-option" onclick="selectEvalOption(this,3,1)"><div class="eval-radio"></div><span>C) No borrar, enfocarse en capturar el gesto</span></div></div></div>
                        <div id="evalResult"></div>
                        <div class="text-center mt-4">
                            <button class="btn btn-warning" id="submitEvalBtn" onclick="submitEvaluation(1)">Enviar</button>
                            <button class="btn btn-secondary" id="retryEvalBtn" style="display: none;" onclick="retryEvaluation(1)">Reintentar</button>
                            <button class="btn btn-primary-custom" id="nextLessonBtn" style="display: none;" onclick="goToNextLesson()">Siguiente Lección <i class="bi bi-arrow-right"></i></button>
                        </div>
                    </div>
                `
            },
            // MEJORA: La misma estructura se aplicaría a las lecciones 2 y 3.
            lesson2: {
                answers: { q1: 2, q2: 3, q3: 1 },
                content: `<div class="lesson-header"><h2 class="lesson-title">Lección 1.2: Proporciones por Observación</h2><p class="text-muted" id="welcomeMessage"></p></div><div class="objectives-list"><h6>Objetivos</h6><ul><li>Medir proporciones por comparación visual directa.</li></ul></div><p>Contenido de la lección 2 aquí...</p>`
            },
            lesson3: {
                answers: { q1: 2, q2: 3, q3: 1 },
                content: `<div class="lesson-header"><h2 class="lesson-title">Lección 1.3: Composición y Balance</h2><p class="text-muted" id="welcomeMessage"></p></div><div class="objectives-list"><h6>Objetivos</h6><ul><li>Identificar contrapposto.</li></ul></div><p>Contenido de la lección 3 aquí...</p>`
            }
        };
        
        // Estilos para la animación del toast
        const style = document.createElement('style');
        style.textContent = `@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }`;
        document.head.appendChild(style);

    </script>
</body>
</html>
