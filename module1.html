<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Módulo 1: Fundamentos y Proporción - LMS Dibujo Anatómico UAH">
    <title>Módulo 1: Fundamentos - LMS UAH</title>
    
    <!-- Bootstrap 5.3.2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --primary-dark: #2c5f66;
            --primary-light: #e8a2b8;
            --dark: #1a1a1a;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #f44336;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }

        /* Header personalizado UAH */
        .header-uah {
            background: linear-gradient(135deg, var(--primary-dark), var(--dark));
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1030;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .back-btn {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }

        .back-btn:hover {
            opacity: 0.8;
        }

        /* Sidebar personalizado */
        .sidebar-lesson {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            position: sticky;
            top: 90px;
            max-height: calc(100vh - 110px);
            overflow-y: auto;
        }

        .lesson-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .lesson-link:hover {
            background: #f8f9fa;
        }

        .lesson-link.active {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            color: white;
        }

        .lesson-number {
            width: 35px;
            height: 35px;
            background: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .lesson-link.active .lesson-number {
            background: rgba(255,255,255,0.3);
        }

        .lesson-link.completed .lesson-number {
            background: var(--success);
            color: white;
        }

        /* Progress bar personalizada */
        .progress-uah {
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-bar-uah {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 1rem;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease;
        }

        /* Cajas de ejercicios */
        .exercise-box {
            background: linear-gradient(135deg, #f0f4ff, #fef0f5);
            border-left: 4px solid var(--primary-dark);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .exercise-title {
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }

        /* Content card */
        .content-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* Botones personalizados UAH */
        .btn-uah-primary {
            background: var(--primary-dark);
            border: none;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-uah-primary:hover {
            background: var(--primary-light);
            color: var(--dark);
            transform: translateY(-2px);
        }

        .btn-uah-success {
            background: var(--success);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .btn-uah-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        /* Quiz styles */
        .quiz-option {
            padding: 1rem;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.5rem;
        }

        .quiz-option:hover {
            border-color: var(--primary-light);
        }

        .quiz-option.selected {
            border-color: var(--primary-dark);
            background: rgba(44, 95, 102, 0.1);
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .quiz-option.incorrect {
            border-color: var(--danger);
            background: rgba(244, 67, 54, 0.1);
        }

        /* Responsive ajustes */
        @media (max-width: 991px) {
            .sidebar-lesson {
                position: static;
                margin-bottom: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Cargar auth.js -->
    <script src="auth.js"></script>

    <!-- Header -->
    <header class="header-uah">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-auto">
                    <a href="index.html" class="back-btn d-flex align-items-center gap-2">
                        <i class="bi bi-arrow-left"></i>
                        <span>Volver al Curso</span>
                    </a>
                </div>
                <div class="col text-center">
                    <h1 class="h4 mb-0">Módulo 1: Fundamentos y Proporción</h1>
                </div>
                <div class="col-auto">
                    <span class="badge bg-light text-dark" id="progressText">0% Completado</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <aside class="col-lg-3">
                <div class="sidebar-lesson">
                    <h5 class="mb-3">
                        <i class="bi bi-book me-2"></i>Lecciones
                    </h5>
                    <div class="lesson-list">
                        <a class="lesson-link active" onclick="loadLesson(1)">
                            <span class="lesson-number">1</span>
                            <span class="flex-grow-1">Introducción al Canon</span>
                        </a>
                        <a class="lesson-link" onclick="loadLesson(2)">
                            <span class="lesson-number">2</span>
                            <span class="flex-grow-1">Las 8 Cabezas</span>
                        </a>
                        <a class="lesson-link" onclick="loadLesson(3)">
                            <span class="lesson-number">3</span>
                            <span class="flex-grow-1">Proporciones Básicas</span>
                        </a>
                        <a class="lesson-link" onclick="loadLesson(4)">
                            <span class="lesson-number">4</span>
                            <span class="flex-grow-1">Estructura Esquelética</span>
                        </a>
                        <a class="lesson-link" onclick="loadLesson(5)">
                            <span class="lesson-number">5</span>
                            <span class="flex-grow-1">Ejercicios Prácticos</span>
                        </a>
                        <a class="lesson-link" onclick="loadLesson(6)">
                            <span class="lesson-number">6</span>
                            <span class="flex-grow-1">Evaluación Final</span>
                        </a>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="col-lg-9">
                <div class="content-card">
                    <!-- Progress Bar -->
                    <div class="progress-uah">
                        <div class="progress-bar-uah" id="moduleProgress" style="width: 0%">
                            <span>0%</span>
                        </div>
                    </div>

                    <!-- Content Header -->
                    <div class="border-bottom pb-3 mb-4">
                        <h2 class="lesson-title h3 mb-2">Lección 1: Introducción al Canon de 8 Cabezas</h2>
                        <div class="d-flex gap-3 text-muted small">
                            <span><i class="bi bi-clock me-1"></i>30 minutos</span>
                            <span><i class="bi bi-book me-1"></i>Fundamentos</span>
                            <span><i class="bi bi-bar-chart me-1"></i>Nivel: Básico</span>
                        </div>
                    </div>

                    <!-- Lesson Content -->
                    <div class="lesson-content" id="lessonContent">
                        <!-- Contenido dinámico -->
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between align-items-center pt-4 mt-4 border-top">
                        <button class="btn btn-uah-primary" disabled id="prevButton">
                            <i class="bi bi-arrow-left me-2"></i>Lección Anterior
                        </button>

                        <button class="btn btn-uah-success" onclick="completeLesson()" id="completeButton">
                            <i class="bi bi-check-circle me-2"></i>Marcar como Completada
                        </button>

                        <button class="btn btn-uah-primary" onclick="loadLesson(2)" id="nextButton">
                            Siguiente Lección<i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container para Notificaciones -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Mensaje aquí
            </div>
        </div>
    </div>

    <!-- Bootstrap 5.3.2 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variables globales
        let currentUser = null;
        let currentLesson = 1;
        let moduleProgress = 0;
        let completedLessons = [];
        let isOnline = navigator.onLine;
        
        window.currentModuleId = 1;

        // Contenido de las lecciones (mismo que antes)
        const lessonsContent = {
            1: {
                title: 'Introducción al Canon de 8 Cabezas',
                meta: '<i class="bi bi-clock me-1"></i>30 minutos | <i class="bi bi-book me-1"></i>Fundamentos | <i class="bi bi-bar-chart me-1"></i>Nivel: Básico',
                content: `
                    <p class="lead">El canon de 8 cabezas es un sistema de proporciones utilizado desde el Renacimiento para representar la figura humana ideal. Este sistema divide el cuerpo en ocho segmentos iguales, cada uno del tamaño de la cabeza.</p>
                    
                    <h3 class="mt-4 mb-3">¿Por qué 8 cabezas?</h3>
                    <p>Esta proporción se considera ideal para representar figuras heroicas y estilizadas. En la realidad, la mayoría de las personas miden entre 7 y 7.5 cabezas de altura, pero el canon de 8 cabezas crea una figura más elegante y proporcionada.</p>
                    
                    <div class="alert alert-warning border-0" role="alert">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Consejo:</strong> Aunque el canon de 8 cabezas es ideal para comenzar, recuerda que las proporciones reales varían según la edad, género y características individuales.
                    </div>
                    
                    <div class="exercise-box">
                        <div class="exercise-title">
                            <i class="bi bi-pencil-square me-2"></i>Ejercicio 1: Primera Práctica
                        </div>
                        <p class="mb-0">Dibuja una línea vertical y divídela en 8 partes iguales. Marca cada división con una línea horizontal suave. Esta será tu guía base para construir la figura.</p>
                    </div>
                `
            },
            2: {
                title: 'Las 8 Divisiones del Cuerpo',
                meta: '<i class="bi bi-clock me-1"></i>35 minutos | <i class="bi bi-book me-1"></i>Estructura | <i class="bi bi-bar-chart me-1"></i>Nivel: Básico',
                content: `
                    <h3 class="mb-3">División del Cuerpo en 8 Segmentos</h3>
                    <p>El sistema de 8 cabezas divide el cuerpo humano en segmentos proporcionalmente exactos:</p>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><span class="badge bg-primary me-2">1</span>Cabeza</h5>
                                    <p class="card-text mb-0">Desde la coronilla hasta el mentón</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><span class="badge bg-primary me-2">2</span>Mentón a pecho</h5>
                                    <p class="card-text mb-0">Incluye el cuello y parte superior del torso</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><span class="badge bg-primary me-2">3</span>Pecho a ombligo</h5>
                                    <p class="card-text mb-0">Zona del torso medio</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><span class="badge bg-primary me-2">4</span>Ombligo a pubis</h5>
                                    <p class="card-text mb-0">Parte baja del torso</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="exercise-box">
                        <div class="exercise-title">
                            <i class="bi bi-pencil-square me-2"></i>Ejercicio 2: Mapeo Corporal
                        </div>
                        <p class="mb-0">Dibuja una figura humana básica y marca cada una de las 8 divisiones con líneas horizontales. Etiqueta cada sección.</p>
                    </div>
                `
            },
            3: {
                title: 'Proporciones Básicas y Medidas',
                meta: '<i class="bi bi-clock me-1"></i>40 minutos | <i class="bi bi-book me-1"></i>Medición | <i class="bi bi-bar-chart me-1"></i>Nivel: Intermedio',
                content: `
                    <h3 class="mb-3">Medidas Horizontales Clave</h3>
                    <p>Además de las divisiones verticales, existen proporciones horizontales importantes:</p>
                    
                    <ul class="list-group mb-4">
                        <li class="list-group-item"><strong>Ancho de hombros:</strong> 2 cabezas de ancho</li>
                        <li class="list-group-item"><strong>Ancho de caderas:</strong> 1.5 cabezas de ancho</li>
                        <li class="list-group-item"><strong>Ancho de cabeza:</strong> 0.7 cabezas de ancho</li>
                        <li class="list-group-item"><strong>Ancho de cuello:</strong> 0.3 cabezas de ancho</li>
                    </ul>
                    
                    <h4 class="mb-3">Puntos de Referencia Laterales</h4>
                    <ul>
                        <li>Los codos se alinean con la cintura (unidad 3)</li>
                        <li>Las muñecas se alinean con la entrepierna (unidad 4)</li>
                        <li>Los dedos alcanzan 1/3 del muslo (unidad 5)</li>
                    </ul>
                    
                    <div class="exercise-box">
                        <div class="exercise-title">
                            <i class="bi bi-pencil-square me-2"></i>Ejercicio 3: Verificación de Proporciones
                        </div>
                        <p class="mb-0">Toma una fotografía de referencia y verifica las proporciones usando el sistema de 8 cabezas. Identifica desviaciones y analiza por qué ocurren.</p>
                    </div>
                `
            },
            4: {
                title: 'Estructura Esquelética Fundamental',
                meta: '<i class="bi bi-clock me-1"></i>45 minutos | <i class="bi bi-book me-1"></i>Anatomía | <i class="bi bi-bar-chart me-1"></i>Nivel: Intermedio',
                content: `
                    <h3 class="mb-3">Base Esquelética del Canon</h3>
                    <p>El canon de 8 cabezas se basa en la estructura ósea humana. Comprender la anatomía básica mejora la precisión del dibujo:</p>
                    
                    <h4 class="mt-4 mb-3">Puntos Óseos Clave</h4>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h5 class="card-title">Cráneo</h5>
                                    <p class="card-text small">Determina la unidad de medida base</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h5 class="card-title">Clavículas</h5>
                                    <p class="card-text small">Marcan el ancho de los hombros</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h5 class="card-title">Pelvis</h5>
                                    <p class="card-text small">Establece el ancho de las caderas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info border-0 mt-4" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Importante:</strong> La estructura ósea es constante, pero los músculos y tejidos pueden variar significativamente entre individuos.
                    </div>
                    
                    <div class="exercise-box">
                        <div class="exercise-title">
                            <i class="bi bi-pencil-square me-2"></i>Ejercicio 4: Esqueleto Básico
                        </div>
                        <p class="mb-0">Dibuja un esqueleto simplificado usando formas geométricas básicas, respetando las proporciones del canon de 8 cabezas.</p>
                    </div>
                `
            },
            5: {
                title: 'Ejercicios Prácticos de Proporción',
                meta: '<i class="bi bi-clock me-1"></i>60 minutos | <i class="bi bi-book me-1"></i>Práctica | <i class="bi bi-bar-chart me-1"></i>Nivel: Intermedio',
                content: `
                    <h3 class="mb-3">Ejercicios de Aplicación</h3>
                    <p>La práctica constante es esencial para dominar el canon de 8 cabezas. Estos ejercicios te ayudarán a internalizar las proporciones:</p>
                    
                    <div class="accordion" id="exercisesAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#exercise5a">
                                    <i class="bi bi-pencil-square me-2"></i>Ejercicio 5A: Figuras Básicas
                                </button>
                            </h2>
                            <div id="exercise5a" class="accordion-collapse collapse show" data-bs-parent="#exercisesAccordion">
                                <div class="accordion-body">
                                    <p>Dibuja 10 figuras humanas básicas usando solo formas geométricas (círculos, rectángulos, líneas). Enfócate únicamente en las proporciones, no en detalles.</p>
                                    <span class="badge bg-secondary">Tiempo: 30 minutos</span>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#exercise5b">
                                    <i class="bi bi-pencil-square me-2"></i>Ejercicio 5B: Diferentes Ángulos
                                </button>
                            </h2>
                            <div id="exercise5b" class="accordion-collapse collapse" data-bs-parent="#exercisesAccordion">
                                <div class="accordion-body">
                                    <p>Dibuja la misma figura desde 4 ángulos diferentes: frontal, perfil, 3/4 y espalda. Mantén las proporciones consistentes.</p>
                                    <span class="badge bg-secondary">Tiempo: 40 minutos</span>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#exercise5c">
                                    <i class="bi bi-pencil-square me-2"></i>Ejercicio 5C: Corrección de Errores
                                </button>
                            </h2>
                            <div id="exercise5c" class="accordion-collapse collapse" data-bs-parent="#exercisesAccordion">
                                <div class="accordion-body">
                                    <p>Se te proporcionan dibujos con errores de proporción. Identifica y corrige cada error usando el sistema de 8 cabezas.</p>
                                    <span class="badge bg-secondary">Tiempo: 45 minutos</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            6: {
                title: 'Evaluación Final del Módulo',
                meta: '<i class="bi bi-clock me-1"></i>90 minutos | <i class="bi bi-book me-1"></i>Evaluación | <i class="bi bi-bar-chart me-1"></i>Nivel: Aplicación',
                content: `
                    <h3 class="mb-3">Proyecto Final: Portfolio de Proporciones</h3>
                    <p>Para completar este módulo, debes crear un portfolio que demuestre tu dominio del canon de 8 cabezas:</p>
                    
                    <div class="card border-primary mb-4">
                        <div class="card-header bg-primary text-white">
                            <i class="bi bi-folder-check me-2"></i>Entregables Requeridos
                        </div>
                        <div class="card-body">
                            <ol class="mb-0">
                                <li><strong>Guía de construcción:</strong> Diagrama paso a paso del canon de 8 cabezas</li>
                                <li><strong>Figuras masculinas:</strong> 3 dibujos (frontal, perfil, 3/4)</li>
                                <li><strong>Figuras femeninas:</strong> 3 dibujos (frontal, perfil, 3/4)</li>
                                <li><strong>Análisis comparativo:</strong> Diferencias entre canon masculino y femenino</li>
                                <li><strong>Poses dinámicas:</strong> 2 figuras en movimiento manteniendo proporciones</li>
                                <li><strong>Autorreflexión:</strong> 300 palabras sobre tu proceso de aprendizaje</li>
                            </ol>
                        </div>
                    </div>
                    
                    <h4 class="mb-3">Evaluación Teórica</h4>
                    <div class="card bg-light">
                        <div class="card-body">
                            <p class="fw-bold mb-3">¿Cuál es la principal ventaja del canon de 8 cabezas sobre las proporciones naturales?</p>
                            <div class="quiz-options">
                                <div class="quiz-option" onclick="selectAnswer(this, false)">
                                    Es más rápido de dibujar
                                </div>
                                <div class="quiz-option" onclick="selectAnswer(this, false)">
                                    Usa menos líneas de construcción
                                </div>
                                <div class="quiz-option" onclick="selectAnswer(this, true)">
                                    Crea figuras más elegantes y heroicas
                                </div>
                                <div class="quiz-option" onclick="selectAnswer(this, false)">
                                    Es más fácil de memorizar
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success border-0 mt-4" role="alert">
                        <h5 class="alert-heading"><i class="bi bi-check-circle me-2"></i>Próximos Pasos</h5>
                        <p class="mb-0">Al completar este módulo habrás dominado el sistema de proporciones clásico y estarás preparado para el <strong>Módulo 2: Anatomía Facial</strong>.</p>
                    </div>
                `
            }
        };

        // Monitoreo de conectividad
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('Conexión restaurada');
            syncProgressWithSheets();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('Sin conexión - modo offline');
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inicializando Módulo 1 con Bootstrap...');
            
            // Verificar autenticación
            if (typeof getCurrentUser !== 'undefined' && typeof protectPage !== 'undefined') {
                if (!protectPage()) return;
                currentUser = getCurrentUser();
            } else {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                } else {
                    window.location.href = 'login.html';
                    return;
                }
            }

            console.log('Usuario autenticado:', currentUser);
            
            // Cargar progreso (híbrido: Sheets primero, luego localStorage)
            loadModuleProgress();
            
            // Cargar primera lección
            loadLesson(1);
            
            // Registrar actividad
            if (typeof logUserActivity === 'function') {
                logUserActivity('module_access', currentUser, { 
                    moduleId: 1,
                    moduleTitle: 'Fundamentos y Proporción'
                });
            }
        });

        // Cargar progreso del módulo (HÍBRIDO: Google Sheets + localStorage)
        async function loadModuleProgress() {
            console.log('Cargando progreso del Módulo 1...');
            
            try {
                // PASO 1: Intentar cargar desde Google Sheets primero
                if (isOnline && typeof getStudentProgress === 'function') {
                    console.log('Intentando cargar desde Google Sheets...');
                    const sheetsProgress = await getStudentProgress(currentUser.username);
                    
                    if (sheetsProgress && sheetsProgress.modules && sheetsProgress.modules[1]) {
                        moduleProgress = sheetsProgress.modules[1].progress || 0;
                        completedLessons = sheetsProgress.modules[1].completedLessons || [];
                        
                        console.log('✓ Progreso cargado desde Google Sheets:', {
                            moduleProgress,
                            completedLessons
                        });
                        
                        // SINCRONIZAR con localStorage como backup
                        const progressKey = `progress_${currentUser.username || currentUser.email}`;
                        let localProgress = JSON.parse(localStorage.getItem(progressKey) || 'null');
                        
                        if (!localProgress) {
                            localProgress = initializeLocalProgress();
                        }
                        
                        localProgress.modules[1] = sheetsProgress.modules[1];
                        localStorage.setItem(progressKey, JSON.stringify(localProgress));
                        
                        updateProgressDisplay();
                        updateSidebarProgress();
                        return;
                    } else {
                        console.log('No hay datos en Sheets, usando localStorage');
                    }
                }
            } catch (error) {
                console.error('Error cargando desde Google Sheets:', error);
            }
            
            // PASO 2: FALLBACK - Cargar desde localStorage
            console.log('Cargando progreso desde localStorage (fallback)...');
            const progressKey = `progress_${currentUser.username || currentUser.email}`;
            const userProgress = JSON.parse(localStorage.getItem(progressKey) || 'null');
            
            if (userProgress && userProgress.modules[1]) {
                moduleProgress = userProgress.modules[1].progress || 0;
                completedLessons = userProgress.modules[1].completedLessons || [];
                
                console.log('✓ Progreso cargado desde localStorage:', {
                    moduleProgress,
                    completedLessons
                });
            }
            
            updateProgressDisplay();
            updateSidebarProgress();
        }

        // Inicializar estructura de progreso local
        function initializeLocalProgress() {
            return {
                modules: {
                    1: { completed: false, progress: 0, timeSpent: 0, completedLessons: [] },
                    2: { completed: false, progress: 0, timeSpent: 0, completedLessons: [] },
                    3: { completed: false, progress: 0, timeSpent: 0, completedLessons: [] },
                    4: { completed: false, progress: 0, timeSpent: 0, completedLessons: [] }
                },
                overallProgress: 0,
                totalTimeSpent: 0,
                lastActivity: new Date().toISOString()
            };
        }

        // Actualizar visualización del progreso
        function updateProgressDisplay() {
            document.getElementById('progressText').textContent = moduleProgress + '% Completado';
            
            const progressBar = document.getElementById('moduleProgress');
            progressBar.style.width = moduleProgress + '%';
            progressBar.querySelector('span').textContent = moduleProgress + '%';
        }

        // Actualizar progreso en sidebar
        function updateSidebarProgress() {
            document.querySelectorAll('.lesson-link').forEach((link, index) => {
                const lessonNumber = index + 1;
                if (completedLessons.includes(lessonNumber)) {
                    link.classList.add('completed');
                }
            });
        }

        // Cargar lección específica
        function loadLesson(lessonNumber) {
            currentLesson = lessonNumber;
            
            // Actualizar sidebar activo
            document.querySelectorAll('.lesson-link').forEach((link, index) => {
                link.classList.remove('active');
                if (index + 1 === lessonNumber) {
                    link.classList.add('active');
                }
            });

            // Actualizar contenido
            const lesson = lessonsContent[lessonNumber];
            if (lesson) {
                document.querySelector('.lesson-title').textContent = lesson.title;
                document.querySelector('.lesson-meta').innerHTML = lesson.meta;
                document.getElementById('lessonContent').innerHTML = lesson.content;
            }

            // Actualizar botones de navegación
            updateNavigationButtons();

            // Scroll suave al inicio del contenido
            window.scrollTo({ top: 0, behavior: 'smooth' });

            console.log('Lección cargada:', lessonNumber);
        }

        // Actualizar botones de navegación
        function updateNavigationButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            const completeButton = document.getElementById('completeButton');

            // Botón anterior
            if (currentLesson <= 1) {
                prevButton.disabled = true;
            } else {
                prevButton.disabled = false;
                prevButton.onclick = () => loadLesson(currentLesson - 1);
            }

            // Botón siguiente
            if (currentLesson >= 6) {
                nextButton.style.display = 'none';
            } else {
                nextButton.style.display = 'inline-block';
                nextButton.onclick = () => loadLesson(currentLesson + 1);
            }

            // Botón completar
            if (completedLessons.includes(currentLesson)) {
                completeButton.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Lección Completada';
                completeButton.classList.remove('btn-uah-success');
                completeButton.classList.add('btn', 'btn-success');
            } else {
                completeButton.innerHTML = '<i class="bi bi-check-circle me-2"></i>Marcar como Completada';
                completeButton.classList.remove('btn', 'btn-success');
                completeButton.classList.add('btn-uah-success');
            }
        }

        // Completar lección (SINCRONIZACIÓN HÍBRIDA)
        async function completeLesson() {
            if (!completedLessons.includes(currentLesson)) {
                completedLessons.push(currentLesson);
                
                // Calcular nuevo progreso
                moduleProgress = Math.round((completedLessons.length / 6) * 100);
                
                // GUARDAR PROGRESO (híbrido)
                await saveProgress();
                
                // Actualizar UI
                updateProgressDisplay();
                updateSidebarProgress();
                updateNavigationButtons();
                
                // Mostrar notificación
                if (currentLesson === 6 && moduleProgress >= 100) {
                    showNotification('¡Felicitaciones! Has completado todo el módulo', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                } else {
                    showNotification('¡Lección completada!', 'success');
                    
                    // Auto-avanzar si no es la última lección
                    if (currentLesson < 6) {
                        setTimeout(() => {
                            loadLesson(currentLesson + 1);
                        }, 2000);
                    }
                }
            }
        }

        // Guardar progreso (SINCRONIZACIÓN BIDIRECCIONAL)
        async function saveProgress() {
            console.log('Guardando progreso del Módulo 1...');
            
            const progressData = {
                progress: moduleProgress,
                completed: moduleProgress >= 100,
                completedLessons: completedLessons,
                timeSpent: 0,
                lastUpdate: new Date().toISOString()
            };
            
            // PASO 1: Guardar INMEDIATAMENTE en localStorage (backup instantáneo)
            const progressKey = `progress_${currentUser.username || currentUser.email}`;
            let userProgress = JSON.parse(localStorage.getItem(progressKey) || 'null');
            
            if (!userProgress) {
                userProgress = initializeLocalProgress();
            }

            userProgress.modules[1] = progressData;
            
            // Calcular progreso general
            let totalProgress = 0;
            for (let id in userProgress.modules) {
                totalProgress += userProgress.modules[id].progress || 0;
            }
            userProgress.overallProgress = Math.round(totalProgress / 4);
            userProgress.lastActivity = new Date().toISOString();

            localStorage.setItem(progressKey, JSON.stringify(userProgress));
            console.log('✓ Progreso guardado en localStorage');

            // PASO 2: Intentar sincronizar con Google Sheets
            try {
                if (isOnline && typeof updateModuleProgress === 'function') {
                    console.log('Sincronizando con Google Sheets...');
                    const success = await updateModuleProgress(1, progressData);
                    
                    if (success) {
                        console.log('✓ Progreso sincronizado con Google Sheets');
                        showNotification('💾 Progreso guardado en la nube', 'info');
                    } else {
                        console.warn('⚠ No se pudo sincronizar con Sheets, usando localStorage');
                        showNotification('💾 Progreso guardado localmente', 'warning');
                    }
                } else {
                    console.log('Modo offline: solo localStorage');
                    showNotification('💾 Progreso guardado localmente', 'info');
                }
                
                // Registrar actividad
                if (typeof logUserActivity === 'function') {
                    logUserActivity('lesson_completed', currentUser, {
                        moduleId: 1,
                        lessonId: currentLesson,
                        progress: moduleProgress
                    });
                }
                
            } catch (error) {
                console.error('Error sincronizando con Google Sheets:', error);
                showNotification('💾 Progreso guardado localmente', 'warning');
            }
        }

        // Sincronizar cuando se restaure conexión
        async function syncProgressWithSheets() {
            try {
                if (!isOnline || typeof updateModuleProgress !== 'function') {
                    return;
                }
                
                const progressKey = `progress_${currentUser.username || currentUser.email}`;
                const localProgress = JSON.parse(localStorage.getItem(progressKey) || 'null');
                
                if (localProgress && localProgress.modules[1]) {
                    console.log('Sincronizando progreso local con Google Sheets...');
                    const success = await updateModuleProgress(1, localProgress.modules[1]);
                    
                    if (success) {
                        console.log('✓ Sincronización completada');
                        showNotification('🔄 Progreso sincronizado con la nube', 'success');
                    }
                }
            } catch (error) {
                console.error('Error en sincronización automática:', error);
            }
        }

        // Quiz: Seleccionar respuesta
        function selectAnswer(element, isCorrect) {
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected', 'correct', 'incorrect');
            });

            element.classList.add('selected');
            
            setTimeout(() => {
                if (isCorrect) {
                    element.classList.add('correct');
                    showNotification('¡Correcto!', 'success');
                } else {
                    element.classList.add('incorrect');
                    showNotification('Intenta de nuevo', 'error');
                }
            }, 500);
        }

        // Mostrar notificación con Bootstrap Toast
        function showNotification(message, type = 'success') {
            const toastEl = document.getElementById('notificationToast');
            const toastBody = document.getElementById('toastBody');
            const toastHeader = toastEl.querySelector('.toast-header');
            
            // Actualizar icono y color según tipo
            let icon = 'bi-check-circle-fill text-success';
            if (type === 'error') icon = 'bi-x-circle-fill text-danger';
            if (type === 'warning') icon = 'bi-exclamation-triangle-fill text-warning';
            if (type === 'info') icon = 'bi-info-circle-fill text-info';
            
            const iconElement = toastHeader.querySelector('i');
            iconElement.className = `${icon} me-2`;
            
            toastBody.textContent = message;
            
            const toast = new bootstrap.Toast(toastEl, {
                delay: 3000
            });
            toast.show();
        }

        // Manejar errores globales
        window.addEventListener('error', function(e) {
            console.error('Error en módulo:', e);
            showNotification('Ha ocurrido un error. Recarga la página si persiste.', 'error');
        });

        // Guardar progreso antes de salir
        window.addEventListener('beforeunload', function() {
            if (moduleProgress > 0) {
                saveProgress();
            }
        });
    </script>
</body>
</html>