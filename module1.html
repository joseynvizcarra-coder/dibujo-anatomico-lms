<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo 1 - LMS UAH</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; }
        .container { max-width: 900px; margin: 2rem auto; }
        .card { border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .lesson-nav { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .lesson-btn { flex: 1; padding: 1rem; border: 2px solid #dee2e6; border-radius: 8px; background: white; cursor: pointer; transition: all 0.3s; }
        .lesson-btn:hover { border-color: #2c5f66; transform: translateY(-2px); }
        .lesson-btn.active { background: linear-gradient(135deg, #2c5f66, #e8a2b8); color: white; border-color: #2c5f66; }
        .lesson-btn.completed { background: #d4edda; border-color: #28a745; }
        .eval-question { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .eval-option { padding: 1rem; border: 2px solid #dee2e6; border-radius: 8px; margin: 0.5rem 0; cursor: pointer; display: flex; align-items: center; gap: 1rem; transition: all 0.3s; }
        .eval-option:hover { border-color: #2c5f66; background: #f8f9fa; }
        .eval-option.selected { border-color: #2c5f66; background: rgba(44, 95, 102, 0.1); }
        .eval-option.correct { border-color: #28a745; background: rgba(40, 167, 69, 0.1); }
        .eval-option.incorrect { border-color: #dc3545; background: rgba(220, 53, 69, 0.1); }
        .eval-radio { width: 20px; height: 20px; border: 2px solid #dee2e6; border-radius: 50%; flex-shrink: 0; }
        .eval-option.selected .eval-radio { background: #2c5f66; border-color: #2c5f66; }
        .eval-option.correct .eval-radio { background: #28a745; border-color: #28a745; }
        .eval-option.incorrect .eval-radio { background: #dc3545; border-color: #dc3545; }
        .btn-custom { background: linear-gradient(135deg, #2c5f66, #e8a2b8); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; font-weight: 600; }
        .btn-custom:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .progress-bar { background: linear-gradient(90deg, #2c5f66, #e8a2b8); }
        .alert { border-left: 4px solid; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">M√≥dulo 1: Observaci√≥n y Gesto</h4>
                        <small class="text-muted" id="userInfo">Cargando...</small>
                    </div>
                    <div>
                        <span class="badge bg-success" id="progressBadge">0%</span>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 10px;">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="lesson-nav">
            <button class="lesson-btn active" data-lesson="1" onclick="loadLesson(1)">
                <strong>Lecci√≥n 1</strong><br>
                <small>Fundamentos del Croquis</small>
            </button>
            <button class="lesson-btn" data-lesson="2" onclick="loadLesson(2)">
                <strong>Lecci√≥n 2</strong><br>
                <small>Proporciones</small>
            </button>
            <button class="lesson-btn" data-lesson="3" onclick="loadLesson(3)">
                <strong>Lecci√≥n 3</strong><br>
                <small>Balance</small>
            </button>
        </div>

        <div id="lessonContent"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>
    
    <script>
        // VARIABLES GLOBALES
        let currentLesson = 1;
        let evaluationAnswers = {};
        let completedLessons = [];
        let moduleStartTime = Date.now();
        
        const MODULE_NUMBER = 1;
        const TOTAL_LESSONS = 3;
        const STORAGE_KEY = 'module1_progress';

        // CONTENIDO DE LECCIONES
        const lessons = {
            1: {
                title: "Lecci√≥n 1: Fundamentos del Croquis R√°pido",
                questions: [
                    {
                        id: "q1",
                        text: "¬øCu√°l es el objetivo de un croquis de 2 minutos?",
                        options: [
                            "A) Hacer un dibujo detallado y perfecto",
                            "B) Capturar la energ√≠a y peso del cuerpo",
                            "C) Practicar t√©cnicas de sombreado"
                        ],
                        correct: 2
                    },
                    {
                        id: "q2",
                        text: "¬øQu√© debemos identificar PRIMERO en un croquis?",
                        options: [
                            "A) La l√≠nea de acci√≥n y punto de apoyo",
                            "B) Los detalles del rostro",
                            "C) La textura de la ropa"
                        ],
                        correct: 1
                    },
                    {
                        id: "q3",
                        text: "¬øCu√°l es la actitud apropiada al dibujar un croquis?",
                        options: [
                            "A) Borrar constantemente hasta lograr perfecci√≥n",
                            "B) Comenzar siempre por los detalles",
                            "C) No borrar, enfocarse en capturar el gesto"
                        ],
                        correct: 3
                    }
                ]
            },
            2: {
                title: "Lecci√≥n 2: Proporciones por Observaci√≥n",
                questions: [
                    {
                        id: "q1",
                        text: "¬øCu√°l es la t√©cnica correcta de medici√≥n visual?",
                        options: [
                            "A) Memorizar la f√≥rmula de 8 cabezas",
                            "B) Extender el brazo y usar el l√°piz como regla",
                            "C) Usar una regla f√≠sica para medir"
                        ],
                        correct: 2
                    },
                    {
                        id: "q2",
                        text: "¬øQu√© significa 'consistencia interna' en el dibujo?",
                        options: [
                            "A) Usar el mismo grosor de l√≠neas",
                            "B) Terminar completamente el dibujo",
                            "C) Que todas las partes se relacionen proporcionalmente"
                        ],
                        correct: 3
                    },
                    {
                        id: "q3",
                        text: "¬øQu√© debemos hacer PRIMERO antes de dibujar?",
                        options: [
                            "A) Observar y medir visualmente",
                            "B) Dibujar los detalles del rostro",
                            "C) Sombrear el fondo"
                        ],
                        correct: 1
                    }
                ]
            },
            3: {
                title: "Lecci√≥n 3: Composici√≥n y Balance",
                questions: [
                    {
                        id: "q1",
                        text: "Si la cadera derecha est√° elevada, ¬øqu√© pasa con el hombro derecho?",
                        options: [
                            "A) Tambi√©n se eleva",
                            "B) Tiende a descender (movimiento opuesto)",
                            "C) Permanece horizontal"
                        ],
                        correct: 2
                    },
                    {
                        id: "q2",
                        text: "¬øD√≥nde debe caer la l√≠nea vertical del centro de gravedad?",
                        options: [
                            "A) Exactamente en el centro entre los dos pies",
                            "B) Siempre sobre el pie derecho",
                            "C) Dentro del pol√≠gono de apoyo"
                        ],
                        correct: 3
                    },
                    {
                        id: "q3",
                        text: "Al dibujar contrapposto, ¬øqu√© debemos marcar PRIMERO?",
                        options: [
                            "A) Los ejes de hombros y caderas",
                            "B) Los dedos de las manos",
                            "C) El sombreado del torso"
                        ],
                        correct: 1
                    }
                ]
            }
        };

        // FUNCI√ìN: Cargar lecci√≥n
        function loadLesson(lessonNum) {
            currentLesson = lessonNum;
            
            // Actualizar navegaci√≥n
            document.querySelectorAll('.lesson-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.lesson) === lessonNum) {
                    btn.classList.add('active');
                }
            });
            
            // Renderizar contenido
            const lesson = lessons[lessonNum];
            let html = `
                <div class="card">
                    <div class="card-body">
                        <h3 class="mb-4">${lesson.title}</h3>
                        
                        <div class="alert alert-info">
                            <strong><i class="bi bi-info-circle me-2"></i>Instrucciones:</strong>
                            Responde las 3 preguntas y haz clic en "Enviar Evaluaci√≥n"
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">Respondidas: <strong id="answeredCount">0</strong>/3</small>
                        </div>
            `;
            
            lesson.questions.forEach((q, index) => {
                html += `
                    <div class="eval-question" data-question="${q.id}">
                        <h6 class="mb-3">Pregunta ${index + 1}: ${q.text}</h6>
                `;
                
                q.options.forEach((option, optIndex) => {
                    html += `
                        <div class="eval-option" onclick="selectOption(${lessonNum}, '${q.id}', ${optIndex + 1})">
                            <div class="eval-radio"></div>
                            <span>${option}</span>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += `
                        <div id="evalResult"></div>
                        
                        <div class="d-flex gap-2 mt-4">
                            <button class="btn btn-custom" id="submitBtn" onclick="submitEvaluation(${lessonNum})">
                                <i class="bi bi-check-circle me-2"></i>Enviar Evaluaci√≥n
                            </button>
                            <button class="btn btn-warning hidden" id="retryBtn" onclick="retryEvaluation(${lessonNum})">
                                <i class="bi bi-arrow-clockwise me-2"></i>Reintentar
                            </button>
                            <button class="btn btn-success hidden" id="nextBtn" onclick="nextLesson()">
                                Siguiente Lecci√≥n <i class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('lessonContent').innerHTML = html;
            
            // Restaurar respuestas previas
            restoreAnswers(lessonNum);
            updateAnswerCount(lessonNum);
        }

        // FUNCI√ìN: Seleccionar opci√≥n
        function selectOption(lessonNum, questionId, optionNum) {
            const container = document.querySelector(`[data-question="${questionId}"]`);
            if (!container) return;
            
            // Remover selecci√≥n previa
            container.querySelectorAll('.eval-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar nueva opci√≥n
            const options = container.querySelectorAll('.eval-option');
            options[optionNum - 1].classList.add('selected');
            
            // Guardar respuesta
            if (!evaluationAnswers[lessonNum]) evaluationAnswers[lessonNum] = {};
            evaluationAnswers[lessonNum][questionId] = optionNum;
            
            updateAnswerCount(lessonNum);
            saveProgress();
        }

        // FUNCI√ìN: Actualizar contador
        function updateAnswerCount(lessonNum) {
            const count = Object.keys(evaluationAnswers[lessonNum] || {}).length;
            const el = document.getElementById('answeredCount');
            if (el) el.textContent = count;
        }

        // FUNCI√ìN: Restaurar respuestas
        function restoreAnswers(lessonNum) {
            const answers = evaluationAnswers[lessonNum];
            if (!answers) return;
            
            Object.keys(answers).forEach(questionId => {
                const container = document.querySelector(`[data-question="${questionId}"]`);
                if (container) {
                    const options = container.querySelectorAll('.eval-option');
                    const selectedIndex = answers[questionId] - 1;
                    if (options[selectedIndex]) {
                        options[selectedIndex].classList.add('selected');
                    }
                }
            });
        }

        // FUNCI√ìN: Enviar evaluaci√≥n
        function submitEvaluation(lessonNum) {
            const userAnswers = evaluationAnswers[lessonNum] || {};
            const lesson = lessons[lessonNum];
            
            if (Object.keys(userAnswers).length < lesson.questions.length) {
                alert('Por favor responde todas las preguntas');
                return;
            }
            
            let score = 0;
            
            // Evaluar respuestas
            lesson.questions.forEach(q => {
                const container = document.querySelector(`[data-question="${q.id}"]`);
                const options = container.querySelectorAll('.eval-option');
                const userAnswer = userAnswers[q.id];
                
                options.forEach((opt, index) => {
                    opt.style.pointerEvents = 'none';
                    
                    if (index + 1 === q.correct) {
                        opt.classList.add('correct');
                        if (userAnswer === q.correct) score++;
                    } else if (index + 1 === userAnswer) {
                        opt.classList.add('incorrect');
                    }
                });
            });
            
            const percentage = Math.round((score / lesson.questions.length) * 100);
            const passed = score >= 2;
            
            // Mostrar resultado
            const resultHTML = passed ? 
                `<div class="alert alert-success mt-3">
                    <h5><i class="bi bi-check-circle-fill me-2"></i>¬°Excelente!</h5>
                    <p class="mb-0">Aprobaste con ${score}/${lesson.questions.length} (${percentage}%)</p>
                </div>` :
                `<div class="alert alert-warning mt-3">
                    <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Necesitas mejorar</h5>
                    <p class="mb-0">Obtuviste ${score}/${lesson.questions.length} (${percentage}%). Necesitas al menos 2/3</p>
                </div>`;
            
            document.getElementById('evalResult').innerHTML = resultHTML;
            document.getElementById('submitBtn').classList.add('hidden');
            
            if (passed) {
                completeLesson(lessonNum);
                document.getElementById('nextBtn').classList.remove('hidden');
            } else {
                document.getElementById('retryBtn').classList.remove('hidden');
            }
            
            // Log actividad
            const currentUser = getCurrentUser();
            if (currentUser) {
                logUserActivity('evaluation_submitted', currentUser, {
                    moduleId: MODULE_NUMBER,
                    lessonId: lessonNum,
                    score: percentage,
                    passed: passed
                });
            }
            
            saveProgress();
        }

        // FUNCI√ìN: Reintentar
        function retryEvaluation(lessonNum) {
            delete evaluationAnswers[lessonNum];
            loadLesson(lessonNum);
            saveProgress();
        }

        // FUNCI√ìN: Siguiente lecci√≥n
        function nextLesson() {
            if (currentLesson < TOTAL_LESSONS) {
                loadLesson(currentLesson + 1);
            } else {
                alert('¬°Felicidades! Completaste el M√≥dulo 1');
                window.location.href = 'index.html';
            }
        }

        // FUNCI√ìN: Completar lecci√≥n
        function completeLesson(lessonNum) {
            if (!completedLessons.includes(lessonNum)) {
                completedLessons.push(lessonNum);
                
                const btn = document.querySelector(`[data-lesson="${lessonNum}"]`);
                if (btn) btn.classList.add('completed');
                
                updateProgressBar();
                saveProgress();
            }
        }

        // FUNCI√ìN: Actualizar barra de progreso
        function updateProgressBar() {
            const percentage = Math.round((completedLessons.length / TOTAL_LESSONS) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressBadge').textContent = percentage + '%';
        }

        // FUNCI√ìN: Guardar progreso
        async function saveProgress() {
            console.log('‚ïê'.repeat(60));
            console.log('üíæ saveProgress() INICIADO');
            
            const currentUser = getCurrentUser();
            if (!currentUser) {
                console.error('‚ùå No hay usuario');
                return;
            }
            
            console.log('‚úÖ Usuario:', currentUser.username);
            console.log('‚úÖ Rol:', currentUser.role);
            
            const timeSpent = Math.round((Date.now() - moduleStartTime) / 60000);
            const progress = Math.round((completedLessons.length / TOTAL_LESSONS) * 100);
            const isCompleted = completedLessons.length === TOTAL_LESSONS;
            
            console.log('üìä Progreso:', progress + '%');
            console.log('üìä Lecciones completadas:', completedLessons);
            
            // 1. localStorage
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    completedLessons,
                    evaluations: evaluationAnswers,
                    timeSpent,
                    lastUpdate: new Date().toISOString()
                }));
                console.log('‚úÖ localStorage guardado');
            } catch (error) {
                console.error('‚ùå Error localStorage:', error);
            }
            
            // 2. Google Sheets
            if (typeof updateModuleProgress === 'function') {
                try {
                    console.log('üì§ Guardando en Google Sheets...');
                    
                    const result = await updateModuleProgress(MODULE_NUMBER, {
                        completed: isCompleted,
                        progress: progress,
                        timeSpent: timeSpent,
                        completedLessons: completedLessons,
                        lastUpdate: new Date().toISOString()
                    });
                    
                    if (result) {
                        console.log('üéâ ¬°SHEETS GUARDADO!');
                    } else {
                        console.warn('‚ö†Ô∏è Sheets retorn√≥ false');
                    }
                } catch (error) {
                    console.error('‚ùå Error Sheets:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è updateModuleProgress no disponible');
            }
            
            console.log('‚ïê'.repeat(60));
        }

        // FUNCI√ìN: Cargar progreso
        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                completedLessons = data.completedLessons || [];
                evaluationAnswers = data.evaluations || {};
                console.log('üìÇ Progreso cargado:', {
                    completadas: completedLessons,
                    evaluaciones: Object.keys(evaluationAnswers).length
                });
            }
            updateProgressBar();
        }

        // FUNCI√ìN: Test de conexi√≥n
        async function testGoogleSheetsConnection() {
            console.log('‚ïê'.repeat(60));
            console.log('üß™ TEST CONEXI√ìN');
            
            const currentUser = getCurrentUser();
            if (!currentUser) {
                console.error('‚ùå No hay usuario');
                return;
            }
            
            console.log('‚úÖ Usuario:', currentUser.username);
            console.log('‚úÖ Rol:', currentUser.role);
            
            if (currentUser.role !== 'estudiante') {
                console.warn('‚ö†Ô∏è Solo estudiantes guardan progreso');
                console.warn('   Tu rol:', currentUser.role);
                return;
            }
            
            try {
                const result = await updateModuleProgress(1, {
                    completed: false,
                    progress: 33,
                    timeSpent: 5,
                    completedLessons: [1],
                    lastUpdate: new Date().toISOString()
                });
                
                console.log(result ? '‚úÖ ¬°√âXITO!' : '‚ùå FALL√ì');
            } catch (error) {
                console.error('‚ùå', error);
            }
            
            console.log('‚ïê'.repeat(60));
        }
        
        window.testGoogleSheetsConnection = testGoogleSheetsConnection;

        // FUNCI√ìN: Inicializar
        async function init() {
            console.log('üöÄ Inicializando M√≥dulo 1...');
            
            const currentUser = getCurrentUser();
            if (!currentUser) {
                console.warn('‚ùå No autenticado');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('‚úÖ Usuario:', currentUser.username);
            document.getElementById('userInfo').textContent = currentUser.fullName || currentUser.username;
            
            loadProgress();
            loadLesson(1);
            
            // Auto-guardar cada 2 minutos
            setInterval(saveProgress, 120000);
            
            console.log('‚úÖ M√≥dulo inicializado');
            console.log('');
            console.log('%cüìã COMANDOS:', 'color: #4CAF50; font-size: 16px; font-weight: bold;');
            console.log('%c   testGoogleSheetsConnection()', 'color: #2196F3;');
            console.log('%c   getCurrentUser()', 'color: #2196F3;');
        }

        // INICIALIZAR
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('beforeunload', saveProgress);
    </script>
</body>
</html>
